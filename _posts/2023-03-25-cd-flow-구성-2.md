---
layout: post
title: pkos) cd flow êµ¬ì„± (harbor-gitlab-argocd) 2/2
category:
  - study
  - cd
tags:
  - study
  - cd
---


1ì—ì„œ ì„¤ì¹˜í–ˆë˜ ê²ƒì— ì´ì–´ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆë‹¤.[ğŸ”—](https://nyoung08.github.io/study/cd/aws/2023/03/25/cd-flow-%EA%B5%AC%EC%84%B1-1/) 


# ì„¤ì •

## harbor ì„¤ì •

harborì—ì„œ ì €ì¥í•  Projectë¥¼ ìƒì„± í›„, ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ë©´ ìë™ìœ¼ë¡œ ì·¨ì•½ì ì„ ìŠ¤ìº”í•´ì£¼ëŠ” ê¸°ëŠ¥ë„ í™œì„±í™”í•´ì¤¬ë‹¤.

![1-3](/assets/img/pkos/cd/1-3.png)
projects > new project

![1-4](/assets/img/pkos/cd/1-4.png)
projects > project_name > configuration > Vulnerability scanning :  â˜‘ Automatically scan images on push

![1-5](/assets/img/pkos/cd/1-5.png)
ì´ëŸ°ì‹ìœ¼ë¡œ ì·¨ì•½ì ì´ ìˆëŠ”ì§€ ìŠ¤ìº” í›„ ì•Œë ¤ì¤€ë‹¤. 


```
# login
(nyoung:default) [root@kops-ec2 ~]# echo 'Harbor12345' > harborpw.txt
(nyoung:default) [root@kops-ec2 ~]# cat harborpw.txt | docker login harbor.nyoung.xyz -u admin --password-stdin

Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
```


## gitlab ì„¤ì •

gitlabì˜ rootê¶Œí•œìœ¼ë¡œ userë¥¼ ìƒì„±í•´ì£¼ê³ , ë§Œë“¤ì–´ì§„ userë¡œ ë“¤ì–´ê°€ ì‚¬ìš©í•œë‹¤. 
ì¢Œì¸¡ìƒë‹¨í–„ë²„ê±° > Admin > Users > new user ìˆœìœ¼ë¡œ ìƒˆ userë¥¼ ë§Œë“¤ê³ 
ì¢Œì¸¡ìƒë‹¨í–„ë²„ê±° > Admin > Users > user_name > impersonation tokenì—ì„œ ìƒì„± í›„ ë³µì‚¬í•´ë‘”ë‹¤.
ë’¤ì— gkeì—ì„œ ì‚¬ìš©ë  userê¹Œì§€ ë‘ê°œ ìƒì„±í–ˆë‹¤.
![1-8](/assets/img/pkos/cd/1-8.png)


user ìƒì„± í›„, ë§Œë“  userë¡œ ì¬ë¡œê·¸ì¸í•˜ì—¬ ê³µê°œ ë ˆë²¨ì„ internalë¡œ ì§€ì •í•œ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•œë‹¤. 
![1-7](/assets/img/pkos/cd/1-7.png)


```
(nyoung:default) [root@kops-ec2 ~]# mkdir ~/gitlab-test && cd ~/gitlab-test

# ê³„ì • ì´ˆê¸°í™”
(nyoung:default) [root@kops-ec2 gitlab-test]# git config --system --unset credential.helper
(nyoung:default) [root@kops-ec2 gitlab-test]# git config --global --unset credential.helper

(nyoung:default) [root@kops-ec2 gitlab-test]# git config --global user.name "nyoung"
(nyoung:default) [root@kops-ec2 gitlab-test]# git config --global user.email "08eychoi@gmail.com"
(nyoung:default) [root@kops-ec2 gitlab-test]# git clone https://gitlab.nyoung.xyz/nyoung/test-prj.git
Cloning into 'test-prj'...
Username for 'https://gitlab.nyoung.xyz': nyoung
Password for 'https://nyoung@gitlab.nyoung.xyz': $token
remote: Enumerating objects: 3, done.
remote: Counting objects: 100% (3/3), done.
remote: Compressing objects: 100% (2/2), done.
remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0
Receiving objects: 100% (3/3), done.
```


## argocd ì„¤ì •

```
# install argocd cli tool
(nyoung:default) [root@kops-ec2 ~]# curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
(nyoung:default) [root@kops-ec2 ~]# install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
(nyoung:default) [root@kops-ec2 ~]# chmod +x /usr/local/bin/argocd

# login argocd
(nyoung:default) [root@kops-ec2 ~]# argocd login argocd.nyoung.xyz --username admin --password ARGOCD_PASSWD
WARN[0000] Failed to invoke grpc call. Use flag --grpc-web in grpc calls. To avoid this warning message, use flag --grpc-web.
'admin:login' logged in successfully
Context 'argocd.nyoung.xyz' updated

# add git repository
(nyoung:default) [root@kops-ec2 ~]# argocd repo add https://gitlab.nyoung.xyz/nyoung/test-prj.git --username nyoung --password GIT_PASSWD
WARN[0000] Failed to invoke grpc call. Use flag --grpc-web in grpc calls. To avoid this warning message, use flag --grpc-web.
Repository 'https://gitlab.nyoung.xyz/nyoung/test-prj.git' added

# repoê°€ ì˜ ë“±ë¡ëœ ê²ƒì„ í™•ì¸
(nyoung:default) [root@kops-ec2 ~]# argocd repo list --grpc-web
TYPE  NAME  REPO                                           INSECURE  OCI    LFS    CREDS  STATUS      MESSAGE  PROJECT
git         https://gitlab.nyoung.xyz/nyoung/test-prj.git  false     false  false  true   Successful
# argocdê°€ ì„¤ì¹˜ëœ clusterê°€ ì¶”ê°€ë˜ì–´ìˆëŠ” ê²ƒì„ í™•ì¸
# í˜„ì¬ëŠ” ì•„ë¬´ëŸ° application ì´ ì—†ê¸°ì— Unknown ìƒíƒœ
(nyoung:default) [root@kops-ec2 ~]# argocd cluster list --grpc-web
SERVER                          NAME        VERSION  STATUS   MESSAGE                                                  PROJECT
https://kubernetes.default.svc  in-cluster           Unknown  Cluster has no applications and is not being monitored.
```


gkeë¡œ clusterë¥¼ í•˜ë‚˜ ìƒì„±í•˜ê³  ìœ„ì™€ ë™ì¼í•˜ê²Œ cli ì„¤ì¹˜ì™€ loginì„ í•œ ë’¤, clusterë¥¼ ë“±ë¡í•´ì¤¬ë‹¤.

```
â¯ argocd cluster add gke_PROJECT_ID_asia-northeast3-a_gke-cluster
WARNING: This will create a service account `argocd-manager` on the cluster referenced by context `gke_PROJECT_ID_asia-northeast3-a_gke-cluster` with full cluster level privileges. Do you want to continue [y/N]? y
INFO[0002] ServiceAccount "argocd-manager" created in namespace "kube-system"
INFO[0003] ClusterRole "argocd-manager-role" created
INFO[0003] ClusterRoleBinding "argocd-manager-role-binding" created
INFO[0008] Created bearer token secret for ServiceAccount "argocd-manager"
WARN[0008] Failed to invoke grpc call. Use flag --grpc-web in grpc calls. To avoid this warning message, use flag --grpc-web.
Cluster 'https://34.64.58.154' added

â¯ argocd cluster list
WARN[0000] Failed to invoke grpc call. Use flag --grpc-web in grpc calls. To avoid this warning message, use flag --grpc-web.
SERVER                          NAME                                                   VERSION  STATUS      MESSAGE                                                  PROJECT
https://34.64.58.154            gke_PROJECT_ID_asia-northeast3-a_gke-cluster           Unknown     Cluster has no applications and is not being monitored.
https://kubernetes.default.svc  in-cluster       
```


# í…ŒìŠ¤íŠ¸

ì–´ë–¤ê±¸ í…ŒìŠ¤íŠ¸í•´ì•¼í• ì§€ ìƒê°í•˜ë‹¤ê°€ argocdì— clusterë¥¼ ì¶”ê°€í•œê²Œ ë¬´ìƒ‰í•˜ì§€ë§Œ.. ê°„ëµí•˜ê²Œ í…ŒìŠ¤íŠ¸ í–ˆë‹¤.
harborì— ì˜¬ë¦° ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ëŠ” yamlì„ gitlabì— ë“±ë¡ í›„ í•´ë‹¹ repoë¥¼ syncí•˜ëŠ” appì„ ìƒì„±í–ˆë‹¤.

### harborì— ì´ë¯¸ì§€ ì˜¬ë¦¬ê¸°
```
# pull image 
(nyoung:default) [root@kops-ec2 ~]# docker pull bsord/tetris
Using default tag: latest
latest: Pulling from bsord/tetris
ae13dd578326: Pull complete
6c0ee9353e13: Pull complete
dca7733b187e: Pull complete
352e5a6cac26: Pull complete
9eaf108767c7: Pull complete
be0c016df0be: Pull complete
802dad68ade4: Pull complete
Digest: sha256:2ffffd2f8834dd13734654eeec142aedbd95e6880e52d692a9e59fd9aa2f9634
Status: Downloaded newer image for bsord/tetris:latest
docker.io/bsord/tetris:latest

# retag image
(nyoung:default)[root@kops-ec2 ~]# docker tag bsord/tetris harbor.nyoung.xyz/pkos/tetris:0.1
(nyoung:default)[root@kops-ec2 ~]# docker image ls
REPOSITORY                       TAG       IMAGE ID       CREATED         SIZE
bsord/tetris                     latest    827801013e17   12 months ago   143MB
harbor.nyoung.xyz/pkos/tetris    0.1       827801013e17   12 months ago   143MB

# push image
(nyoung:default)[root@kops-ec2 ~]# docker push harbor.nyoung.xyz/pkos/tetris:0.1
The push refers to repository [harbor.nyoung.xyz/pkos/tetris]
07ebcd9dfb96: Pushed
24037b645d66: Pushed
d00147ef6763: Pushed
2793e885dc34: Pushed
8b8ecda1d12d: Pushed
30c00b5281a1: Pushed
3a626bb08c24: Pushed
0.1: digest: sha256:2ffffd2f8834dd13734654eeec142aedbd95e6880e52d692a9e59fd9aa2f9634 size: 1781
```

![1-6](/assets/img/pkos/cd/1-6.png)
ì•„ì£¼..ë§ì´ ì•ˆì¢‹ì€.. tetris imageë¥¼ ì½˜ì†”ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


### í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•œ yamlíŒŒì¼ì„ gitì— ì—…ë¡œë“œ

```
~/test-prj main*                                                                                                      02:17:53
â¯ git add .

~/test-prj main*                                                                                                      02:18:43
â¯ git commit -m "add tetris"
[main bb746dd] add tetris
 1 file changed, 32 insertions(+)
 create mode 100644 tetris.yaml

~/test-prj main â‡¡                                                                                                     02:19:02
â¯ git push
Username for 'https://gitlab.nyoung.xyz': gcpuser@nyoung.xyz
Password for 'https://gcpuser@nyoung.xyz@gitlab.nyoung.xyz':
ì˜¤ë¸Œì íŠ¸ ë‚˜ì—´í•˜ëŠ” ì¤‘: 4, ì™„ë£Œ.
ì˜¤ë¸Œì íŠ¸ ê°œìˆ˜ ì„¸ëŠ” ì¤‘: 100% (4/4), ì™„ë£Œ.
Delta compression using up to 8 threads
ì˜¤ë¸Œì íŠ¸ ì••ì¶•í•˜ëŠ” ì¤‘: 100% (3/3), ì™„ë£Œ.
ì˜¤ë¸Œì íŠ¸ ì“°ëŠ” ì¤‘: 100% (3/3), 487 bytes | 487.00 KiB/s, ì™„ë£Œ.
Total 3 (delta 0), reused 0 (delta 0), pack-reused 0
To https://gitlab.nyoung.xyz/nyoung/test-prj.git
   68cd98e..bb746dd  main -> main
```

![1-9](/assets/img/pkos/cd/1-9.png)
ì½˜ì†”ì—ì„œ yamlì´ ì˜ ë“¤ì–´ê°„ ê²ƒì„ í™•ì¸


### argocd app ìƒì„±

```
(nyoung:default) [root@kops-ec2 ~]# argocd app create tetris --repo https://gitlab.nyoung.xyz/nyoung/test-prj.git --path tetris --dest-server https://kubernetes.default.svc --dest-namespace default
WARN[0000] Failed to invoke grpc call. Use flag --grpc-web in grpc calls. To avoid this warning message, use flag --grpc-web.
application 'tetris' created

(nyoung:default) [root@kops-ec2 ~]# argocd app list
WARN[0000] Failed to invoke grpc call. Use flag --grpc-web in grpc calls. To avoid this warning message, use flag --grpc-web.
NAME           CLUSTER                         NAMESPACE  PROJECT  STATUS     HEALTH   SYNCPOLICY  CONDITIONS  REPO                                           PATH    TARGET
argocd/tetris  https://kubernetes.default.svc  default    default  OutOfSync  Missing  <none>      <none>      https://gitlab.nyoung.xyz/nyoung/test-prj.git  tetris
```

![1-10](/assets/img/pkos/cd/1-10.png)
í˜„ì¬ëŠ” syncê°€ ìë™ì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— argocdì—ì„œ appì„ ìƒì„±í•˜ì—¬ íŒŒì¼ì„ ì½ì—ˆì§€ë§Œ, ì‹¤ì œë¡œëŠ” ë™ì‘í•˜ì§€ ì•Šì€ ìƒíƒœì´ë‹¤. 



### argocd sync 

```
(nyoung:default) [root@kops-ec2 ~]# argocd app sync tetris
WARN[0000] Failed to invoke grpc call. Use flag --grpc-web in grpc calls. To avoid this warning message, use flag --grpc-web.
TIMESTAMP                  GROUP        KIND   NAMESPACE                  NAME    STATUS    HEALTH        HOOK  MESSAGE
2023-03-25T02:27:24+09:00            Service     default                tetris  OutOfSync  Missing
2023-03-25T02:27:24+09:00   apps  Deployment     default                tetris  OutOfSync  Missing
2023-03-25T02:27:24+09:00            Service     default                tetris    Synced  Healthy
2023-03-25T02:27:24+09:00            Service     default                tetris    Synced   Healthy              service/tetris created
2023-03-25T02:27:24+09:00   apps  Deployment     default                tetris  OutOfSync  Missing              deployment.apps/tetris created
2023-03-25T02:27:24+09:00   apps  Deployment     default                tetris    Synced  Progressing              deployment.apps/tetris created

Name:               argocd/tetris
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.nyoung.xyz/applications/tetris
Repo:               https://gitlab.nyoung.xyz/nyoung/test-prj.git
Target:
Path:               tetris
SyncWindow:         Sync Allowed
Sync Policy:        <none>
Sync Status:        Synced to  (71db351)
Health Status:      Progressing

Operation:          Sync
Sync Revision:      71db351f6657ca967a72e175c84b002c2eb737fc
Phase:              Succeeded
Start:              2023-03-25 02:27:24 +0900 KST
Finished:           2023-03-25 02:27:24 +0900 KST
Duration:           0s
Message:            successfully synced (all tasks run)

GROUP  KIND        NAMESPACE  NAME    STATUS  HEALTH       HOOK  MESSAGE
       Service     default    tetris  Synced  Healthy            service/tetris created
apps   Deployment  default    tetris  Synced  Progressing        deployment.apps/tetris created


# ë¦¬ì†ŒìŠ¤ê°€ ìƒì„±ëœ ê²ƒì„ í™•ì¸ ê°€ëŠ¥
(nyoung:default) [root@kops-ec2 ~]# k get po,svc
NAME                           READY   STATUS    RESTARTS   AGE
pod/busybox-7846c844fb-lzth4   1/1     Running   0          24h
pod/tetris-7f86b95884-tv28x    1/1     Running   0          26s

NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
service/kubernetes   ClusterIP   100.64.0.1       <none>        443/TCP        25h
service/tetris       NodePort    100.66.131.183   <none>        80:30262/TCP   26s

# synced ìƒíƒœì¸ ê²ƒì„ í™•ì¸ ê°€ëŠ¥
(nyoung:default) [root@kops-ec2 ~]# argocd app list
WARN[0000] Failed to invoke grpc call. Use flag --grpc-web in grpc calls. To avoid this warning message, use flag --grpc-web.
NAME           CLUSTER                         NAMESPACE  PROJECT  STATUS  HEALTH   SYNCPOLICY  CONDITIONS  REPO                                           PATH    TARGET
argocd/tetris  https://kubernetes.default.svc  default    default  Synced  Healthy  <none>      <none>      https://gitlab.nyoung.xyz/nyoung/test-prj.git  tetris

```

![1-11](/assets/img/pkos/cd/1-11.png)



### automated sync

```
# automated sync ì„¤ì •
(nyoung:default) [root@kops-ec2 ~]# argocd app set tetris --sync-policy automated
```

ê¸°ì¡´ yamlì˜ svc typeì„ NodePortì—ì„œ LoadBalancerë¡œ ë³€ê²½í•˜ì—¬ gitê³¼ clusterì— ë°°í¬ëœ ìƒíƒœê°€ ë‹¤ë¥´ê²Œë” í•´ì£¼ì—ˆë‹¤.
argocdëŠ” desired stateë¥¼ ë°”ë¼ë³´ë©° ê³„ì†í•´ì„œ syncí•˜ë ¤í•˜ê¸° ë•Œë¬¸ì—, ìœ„ ì„¤ì •ì„ í•´ë‘ì—ˆë‹¤ë©´ ìˆ˜ë™ìœ¼ë¡œ syncí•˜ì§€ ì•Šì•„ë„ ìë™ìœ¼ë¡œ í•˜ê²Œëœë‹¤.
 

```
(nyoung:default) [root@kops-ec2 ~]# k get svc -w
NAME         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP      100.64.0.1       <none>        443/TCP        25h
tetris       LoadBalancer   100.66.131.183   <pending>     80:30262/TCP   17m
tetris       LoadBalancer   100.66.131.183   af0de4e9339c641d4a0401f9f47cc428-697233320.ap-northeast-2.elb.amazonaws.com   80:30262/TCP   19m
```

ì•„ë˜ ì´ë¯¸ì§€ë¥¼ ë³´ë©´ ë‹¤ë¥¸ ê²ƒì„ ë°œê²¬í•˜ê²Œ ëœë‹¤ë©´ syncí•˜ê¸° ìœ„í•œ progressìƒíƒœë¡œ ì „í™˜ëœë‹¤.

![1-12](/assets/img/pkos/cd/1-12.png)

![1-13](/assets/img/pkos/cd/1-13.png)


lbë¡œ ë°°í¬ëœ ì„œë²„ì—ë„ ì ‘ê·¼ì´ ì˜ëœë‹¤ ~ 

![1-14](/assets/img/pkos/cd/1-14.png)



clusterë¥¼ ë“±ë¡í•´ì¤€ê¹€ì— gkeì—ë„ ë˜‘ê°™ì´ ë°°í¬í•´ë´¤ë‹¤.

```
â¯ k create ns test
namespace/test created

â¯ argocd app create tetris-gke --repo https://gitlab.nyoung.xyz/nyoung/test-prj.git --path tetris --dest-server https://34.64.58.154  --dest-namespace test   --sync-policy automated
application 'tetris-gke' created

# create ì§í›„
â¯ argocd app list
NAME               CLUSTER                         NAMESPACE  PROJECT  STATUS  HEALTH       SYNCPOLICY  CONDITIONS  REPO                                           PATH    TARGET
argocd/tetris      https://kubernetes.default.svc  default    default  Synced  Healthy      Auto        <none>      https://gitlab.nyoung.xyz/nyoung/test-prj.git  tetris
argocd/tetris-gke  https://34.64.58.154            test       default  Synced  Progressing  Auto        <none>      https://gitlab.nyoung.xyz/nyoung/test-prj.git  tetris

# syncê°€ ì™„ë£Œë¨
â¯ argocd app list
NAME               CLUSTER                         NAMESPACE  PROJECT  STATUS  HEALTH   SYNCPOLICY  CONDITIONS  REPO                                           PATH    TARGET
argocd/tetris      https://kubernetes.default.svc  default    default  Synced  Healthy  Auto        <none>      https://gitlab.nyoung.xyz/nyoung/test-prj.git  tetris
argocd/tetris-gke  https://34.64.58.154            test       default  Synced  Healthy  Auto        <none>      https://gitlab.nyoung.xyz/nyoung/test-prj.git  tetris

â¯ k get svc -n test
NAME     TYPE           CLUSTER-IP    EXTERNAL-IP    PORT(S)        AGE
tetris   LoadBalancer   10.64.8.132   34.64.209.72   80:30498/TCP   15m
```


ì½˜ì†”ì—ì„œë„ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.

![1-15](/assets/img/pkos/cd/1-15.png)

![1-16](/assets/img/pkos/cd/1-16.png)


ğŸ˜
![1-17](/assets/img/pkos/cd/1-17.png)



---
ì°¸ê³ 
- [https://argo-cd.readthedocs.io/en/stable/user-guide/auto_sync/](https://argo-cd.readthedocs.io/en/stable/user-guide/auto_sync/)
- [https://www.youtube.com/watch?v=cLgzqc_hwIg&list=PL1mta2YyMpPWItLT-9XCaSsdF_EysOS4Z](https://www.youtube.com/watch?v=cLgzqc_hwIg&list=PL1mta2YyMpPWItLT-9XCaSsdF_EysOS4Z)

