---
layout: post
title: KANS3) ì»¨í…Œì´ë„ˆ ë™ì‘ì— ëŒ€í•˜ì—¬
category: study
tags: study
---

ì˜¬ ì´ˆ ì´í›„ë¡œ, ì˜¤ëœë§Œì— ë‹¤ì‹œ ìŠ¤í„°ë””ë¥¼ ì‹œì‘í–ˆë‹¤. ì²« ì£¼ì°¨ì˜ ë‚´ìš©ì€ ì»¨í…Œì´ë„ˆì— ëŒ€í•´ ê³µë¶€í•˜ê³ , ê·¸ì— ëŒ€í•´ ì •ë¦¬í•˜ì˜€ë‹¤. [ğŸ”—](https://netpple.github.io/docs/make-container-without-docker/)


## ë„ì»¤ì™€ ì»¨í…Œì´ë„ˆ

DockerëŠ” ê°€ìƒ í™˜ê²½ì¸ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ê³  ê´€ë¦¬í•˜ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ í”„ë¡œì íŠ¸ì´ë‹¤.
ì»¨í…Œì´ë„ˆëŠ” ê°€ìƒí™”ì™€ ë‹¤ë¥´ê²Œ, osë¥¼ í˜¸ìŠ¤íŠ¸ì˜ osë¡œ ê³µìœ í•˜ì—¬ ì‚¬ìš©í•œë‹¤. ê·¸ë˜ì„œ ê° ì»¨í…Œì´ë„ˆëŠ” osê°€ í•„ìš”ì—†ì´ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì™€ ê·¸ì— í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë§Œ ì¡´ì¬í•˜ê²Œëœë‹¤. ì´ë ‡ê¸°ì— ì¥ì ìœ¼ë¡œëŠ” ê°€ë³ì§€ë§Œ, ë‹¨ì ìœ¼ë¡œëŠ” ì»¤ë„ë‹¨ì´ ê³µìœ ë˜ê¸° ë•Œë¬¸ì— ë¹„êµì  ë³´ì•ˆì— ì·¨ì•½í•˜ë‹¤.
í•˜ì´í¼ë°”ì´ì € ê°€ìƒí™”ì˜ ê²½ìš°, í•˜ë“œì›¨ì–´ ë ˆë²¨ì—ì„œ ê°€ìƒí™”í•˜ì—¬ ì—¬ëŸ¬ guest osê°€ ì˜¬ë¼ê°ˆ ìˆ˜ ìˆë„ë¡ í•œë‹¤. ì´ì™€ ë‹¤ë¥´ê²Œ ì»¨í…Œì´ë„ˆì˜ ê²½ìš°, í•˜ë“œì›¨ì–´ê°€ ì•„ë‹Œ í˜¸ìŠ¤íŠ¸ì˜ ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì„ ê³µìœ í•˜ë©° ì—¬ëŸ¬ ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ë™ì‘í•  ìˆ˜ ìˆë‹¤.

![1-0](/assets/img/kans3-2024/w1/1-0.png)
[ì´ë¯¸ì§€ ì¶œì²˜](https://netpple.github.io/docs/make-container-without-docker/container-internal-1)


## ì»¨í…Œì´ë„ˆì™€ ë¦¬ëˆ…ìŠ¤ ì»¤ë„

ì»¨í…Œì´ë„ˆëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í˜¸ìŠ¤íŠ¸ ì»¤ë„ì„ ê³µìœ í•˜ì§€ë§Œ, ê°ê° user spaceë¥¼ ê°€ì§€ê²Œ ëœë‹¤. ê°ê°ì˜ user spaceë¥¼ ê°€ì§€ê¸° ìœ„í•´ pivot-root, namespace, cgroupì˜ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì„¸ìŠ¤ ë‹¨ìœ„ë¡œ ê²©ë¦¬ í™˜ê²½ì„ ì œê³µí•œë‹¤.[ğŸ”—](https://speakerdeck.com/kakao/ige-dwaeyo-dokeo-eobsi-keonteineo-mandeulgi?slide=38) 
í”„ë¡œì„¸ìŠ¤ ë‹¨ìœ„ë¡œ ê²©ë¦¬ í™˜ê²½ì´ ì œê³µë˜ê¸° ë•Œë¬¸ì—, í•˜ë‚˜ì˜ ê²©ë¦¬ëœ í”„ë¡œì„¸ìŠ¤ê°€ ì»¨í…Œì´ë„ˆë¼ê³  í•  ìˆ˜ ìˆë‹¤. í˜¸ìŠ¤íŠ¸ osì—ì„œ í”„ë¡œì„¸ìŠ¤ ì •ë³´ë¥¼ í™•ì¸í•´ë³´ë©´, ì˜¬ë ¤ ë‘” ì»¨í…Œì´ë„ˆ í”„ë¡œì„¸ìŠ¤ë„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤. ë¬¼ë¡ , ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œì˜ pidÂ ì™€ëŠ” ë‹¤ë¥´ë‹¤.
ì´ë ‡ê²Œ í˜¸ìŠ¤íŠ¸ osë¥¼ ê³µìœ í•˜ê¸° ë•Œë¬¸ì—, ê° ì»¨í…Œì´ë„ˆì˜ ì •ë³´ë„ í˜¸ìŠ¤íŠ¸ osì—ì„œ í™•ì¸ í•  ìˆ˜ê°€ ìˆë‹¤. ë¦¬ëˆ…ìŠ¤ /proc íŒŒì¼ ì‹œìŠ¤í…œì—ëŠ” í˜„ì¬ ì»¤ë„ì´ ë©”ëª¨ë¦¬ì—ì„œ ì‚¬ìš©í•˜ê³  ìˆëŠ” ëª¨ë“  ìì›ë“¤ì— ëŒ€í•œ ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ procí•˜ìœ„ì˜ í˜„ì¬ ì˜¬ë¼ì™€ìˆëŠ” í”„ë¡œì„¸ìŠ¤ì˜ pidì˜ í´ë”ë“¤ì´ ìˆëŠ”ë°, ê·¸ í•˜ìœ„ì—ëŠ” ê°ê°ì˜ ì •ë³´ë¡œ êµ¬ì„±ë˜ì–´ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, /proc/PID/cmdline ëŠ” í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰í•˜ê³  ìˆëŠ” ëª…ë ¹ì´ë‚˜ í”„ë¡œê·¸ë¨ì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤. ì´ëŸ° ì‹ìœ¼ë¡œ ê°ê°ì˜ ì»¨í…Œì´ë„ˆì—ì„œ ìì› ì‚¬ìš© í˜„í™© ë“±ì„ í™•ì¸ í•  ìˆ˜ ì‡ë‹¤.

/proc í•˜ìœ„ì— ê° í”„ë¡œì„¸ìŠ¤ì˜ PIDë²ˆí˜¸ì˜ í´ë”ë“¤ì´ êµ¬ì„±ë˜ì–´ìˆê³ , ê·¸ í•˜ìœ„ì—ëŠ” í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ ì •ë³´ë¥¼ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.
![2-0](/assets/img/kans3-2024/w1/2-0.png)

ì‹¤í–‰í•œ nginx container PIDë¥¼ ì°¾ì•„ì„œ í•˜ìœ„ì˜ ì •ë³´ë¥¼ í™•ì¸í•´ ë³¸ ê²°ê³¼
![2-1](/assets/img/kans3-2024/w1/2-1.png)


## ë„ì»¤ ì„¤ì¹˜ 

```
root@MyServer:~# curl -fsSL https://get.docker.com | sh
# Executing docker install script, commit: 0d6f72e671ba87f7aa4c6991646a1a5b9f9dae84
+ sh -c apt-get update -qq >/dev/null
+ sh -c DEBIAN_FRONTEND=noninteractive apt-get install -y -qq ca-certificates curl >/dev/null
+ sh -c install -m 0755 -d /etc/apt/keyrings
+ sh -c curl -fsSL "https://download.docker.com/linux/ubuntu/gpg" -o /etc/apt/keyrings/docker.asc
+ sh -c chmod a+r /etc/apt/keyrings/docker.asc
+ sh -c echo "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu jammy stable" > /etc/apt/sources.list.d/docker.list
+ sh -c apt-get update -qq >/dev/null
+ sh -c DEBIAN_FRONTEND=noninteractive apt-get install -y -qq docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-ce-rootless-extras docker-buildx-plugin >/dev/null
+ sh -c docker version
Client: Docker Engine - Community
 Version:           27.2.0
 API version:       1.47
 Go version:        go1.21.13
 Git commit:        3ab4256
 Built:             Tue Aug 27 14:15:13 2024
 OS/Arch:           linux/amd64
 Context:           default

Server: Docker Engine - Community
 Engine:
  Version:          27.2.0
  API version:      1.47 (minimum version 1.24)
  Go version:       go1.21.13
  Git commit:       3ab5c7d
  Built:            Tue Aug 27 14:15:13 2024
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.7.21
  GitCommit:        472731909fa34bd7bc9c087e4c27943f9835f111
 runc:
  Version:          1.1.13
  GitCommit:        v1.1.13-0-g58aa920
 docker-init:
  Version:          0.19.0
  GitCommit:        de40ad0
```

ìœ„ì™€ ê°™ì´ ë„ì»¤ëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì˜ ì—¬ëŸ¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ëœë‹¤. ì»¨í…Œì´ë„ˆì—ì„œ rootë¼ í•˜ë”ë¼ë„ ê²©ë¦¬ëœ ê³µê°„ìœ¼ë¡œ ê¶Œí•œì´ ì œí•œë˜ì§€ë§Œ, í˜¸ìŠ¤íŠ¸ì—ì„œëŠ” root ê¶Œí•œì„ ì‚¬ìš© í•  ìˆ˜ ìˆê¸°ì— ë³´ì•ˆìƒì˜ ìœ„í˜‘ì´ ìˆì„ ìˆ˜ ìˆë‹¤. ê·¸ë˜ì„œ ë„ì»¤ ê³µì‹ ë¬¸ì„œì—ì„œë„ rootless modeë¡œ ì‹¤í–‰í•˜ëŠ” ë°©ì•ˆì— ëŒ€í•´ ì•ˆë‚´ë¥¼ í•˜ê³  ìˆë‹¤. [ğŸ”—](https://docs.docker.com/engine/security/rootless/)

![3-1](/assets/img/kans3-2024/w1/3-1.png)

ë„ì»¤ ë™ì‘ ë°©ì‹ì„ ë³´ë©´ docker clië¥¼ ë‚ ë¦¬ë©´ docker daemon ì„ í˜¸ì¶œí•˜ê¸° ìœ„í•´ rest api endpointë¡œ ì ‘ê·¼í•œë‹¤. ì´ë•Œ, 127.0.0.1ì— ë°”ì¸ë”©ëœ tcp ì†Œì¼“ì´ ì•„ë‹Œ unix ì†Œì¼“ì„ ì‚¬ìš©í•œë‹¤. ì™œê·¸ëŸ°ì§€ ì´ìœ ëŠ”.. . tcp ì†Œì¼“ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° csrf(cross site request forgery) ê³µê²© ë°›ê¸° ì‰½ê¸° ë•Œë¬¸ì´ë¼ê³ , ë…ìŠ¤ì— ë‚˜ì™€ìˆë‹¤. [ğŸ”—](https://docs.docker.com/engine/security/#docker-daemon-attack-surface) ì›ê²© ì ‘ì† ê°€ëŠ¥í•´ì§€ë©´, ì™¸ë¶€ì—ì„œ docker daemonì— ì ‘ê·¼í•´ ì•…ì˜ì ì¸ ëª…ë ¹ì„ ì‹¤í–‰ í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ unix ì†Œì¼“ì„ ì‚¬ìš©í•˜ì—¬ ë¡œì»¬ë¡œ ì ‘ê·¼ ì œí•œì„ í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.

![3-0](/assets/img/kans3-2024/w1/3-0.png)
[ì´ë¯¸ì§€ ì¶œì²˜](https://docs.docker.com/get-started/docker-overview/#docker-architecture)


## unix socket

uds(unix domain socket)ì€ ë™ì¼í•œ ì‹œìŠ¤í…œ ë‚´ì—ì„œ ì‹¤í–‰ë˜ëŠ” í”„ë¡œì„¸ìŠ¤ ê°„ í†µì‹ ì„ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ì†Œì¼“ì´ë‹¤. ë¡œì»¬ì—ì„œë§Œ ë™ì‘í•´ì„œ local socketì´ë‚˜ IPC(Inter-Process Communications)ì†Œì¼“ì´ë¼ í•˜ê¸°ë„ í•œë‹¤.

![4-0](/assets/img/kans3-2024/w1/4-0.png)
[ì´ë¯¸ì§€ ì¶œì²˜](https://www.verycosy.net/posts/2023/09/unix-domain-socket)

tcp sockekì™€ ë‹¤ë¥¸ ì ì€ ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ ê°„ í†µì‹ ì„ ìœ„í•´ ë§Œë“¤ì–´ì¡Œê¸° ë•Œë¬¸ì— ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì„ ê±°ì¹˜ì§€ ì•Šê³  ì»¤ë„ ë‚´ì—ì„œ ì§ì ‘ í†µì‹ í•˜ë¯€ë¡œ ë„¤íŠ¸ì›Œí¬ ì˜¤ë²„í—¤ë“œê°€ ì—†ì´ ë¹ ë¥´ë‹¤. tcp socketê³¼ ì¸í„°í˜ì´ìŠ¤ê°€ ìœ ì‚¬í•´ì„œ tcp í†µì‹ ì—ì„œ ì‚¬ìš©í•˜ë˜ í•¨ìˆ˜ì— ip:portê°€ ì•„ë‹Œ name.sockìœ¼ë¡œ ë„£ì–´ë„ tcpì²˜ëŸ¼ ì‘ë™ëœë‹¤. (ê·¸ë ‡ë‹¤ê³  ip:port í†µì‹ í•œë‹¤ëŠ” ê²ƒì´ ì•„ë‹ˆë¼... ì†Œì¼“íŒŒì¼ë¡œ í†µì‹ )

![4-1](/assets/img/kans3-2024/w1/4-1.png)

ì´ëŸ¬í•œ ìœ ë‹‰ìŠ¤ ì†Œì¼“ì„ ì‚¬ìš©í•´ì„œ ì»¨í…Œì´ë„ˆì—ì„œ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆë¥¼ ê´€ë¦¬ í•  ë•Œ ì‚¬ìš© í•  ìˆ˜ë„ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ cicd ì‘ì—…ì˜ ê²½ìš°, cicd íˆ´ì´ ì˜¬ë¼ê°€ ìˆëŠ” ì»¨í…Œì´ë„ˆëŠ” í˜¸ìŠ¤íŠ¸ì—ì„œ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„± ë“±ì˜ ê¶Œí•œì´ í•„ìš”í•˜ë‹¤. ì´ ë•Œ, ë³¼ë¥¨ì„ ìœ ë‹‰ìŠ¤ ì†Œì¼“ì„ ë¶™ì—¬ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤. 


## DooD(Docker Out Of Docker) ì™€ DinD [ğŸ”—](https://blog.nestybox.com/2019/09/14/dind.html#docker-in-docker-approaches)

ì»¨í…Œì´ë„ˆì— docker.socketì„ ë³¼ë¥¨ìœ¼ë¡œ ë¶™ì—¬ì„œ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ DooDë¼ê³  í•œë‹¤. ë– ìˆëŠ” ì»¨í…Œì´ë„ˆì—ì„œ docker cli ë¥¼ ë‚ ë¦¬ê²Œ ë˜ë©´ í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œì˜ docker daemonì´ í˜¸ì¶œë˜ì–´ í˜¸ìŠ¤íŠ¸ì—ì„œ ì»¨í…Œì´ë„ˆê°€ ìƒì„±ëœë‹¤.

![5-4](/assets/img/kans3-2024/w1/5-4.png)

```
root@MyServer:~# docker run --rm -it -v /run/docker.sock:/run/docker.sock -v /usr/bin/docker:/usr/bin/docker ubuntu:latest bash
Unable to find image 'ubuntu:latest' locally
latest: Pulling from library/ubuntu
31e907dcc94a: Pull complete
Digest: sha256:8a37d68f4f73ebf3d4efafbcf66379bf3728902a8038616808f04e34a9ab63ee
Status: Downloaded newer image for ubuntu:latest
root@bd82d8318a4b:/# docker info
Client: Docker Engine - Community
 Version:    27.2.0
 Context:    default
 Debug Mode: false

Server:
 Containers: 1
 ...
 Total Memory: 1.857GiB
 Name: MyServer
 ID: 9810e509-651c-4b23-9b86-4e99fec2bc42
 Docker Root Dir: /var/lib/docker
 Debug Mode: false
 Experimental: false
 Insecure Registries:
  127.0.0.0/8
 Live Restore Enabled: false

root@bd82d8318a4b:/# docker run -d --rm --name webserver nginx:alpine
Unable to find image 'nginx:alpine' locally
...
Status: Downloaded newer image for nginx:alpine
edd74d3aeb73b64b9e61895e73d4201e20ff754bd2e15112d4eec47cdc49eea0
root@bd82d8318a4b:/#


# ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ nginx ì»¨í…Œì´ë„ˆë¥¼ ë§Œë“¤ì€ ê²ƒì„ í™•ì¸
root@bd82d8318a4b:/# docker ps
CONTAINER ID   IMAGE           COMMAND                  CREATED         STATUS         PORTS     NAMES
edd74d3aeb73   nginx:alpine    "/docker-entrypoint.â€¦"   2 minutes ago   Up 2 minutes   80/tcp    webserver
bd82d8318a4b   ubuntu:latest   "bash"                   2 minutes ago   Up 2 minutes             cranky_lewin
root@bd82d8318a4b:/# exit
exit

# í˜¸ìŠ¤íŠ¸ì—ì„œ nginx ì»¨í…Œì´ë„ˆë¥¼ ë§Œë“¤ì€ ê²ƒì„ í™•ì¸
root@MyServer:~# docker ps
CONTAINER ID   IMAGE           COMMAND                  CREATED          STATUS          PORTS     NAMES
edd74d3aeb73   nginx:alpine    "/docker-entrypoint.â€¦"   31 seconds ago   Up 30 seconds   80/tcp    webserver
bd82d8318a4b   ubuntu:latest   "bash"                   55 seconds ago   Up 54 seconds             cranky_lewin
```

![5-0](/assets/img/kans3-2024/w1/5-0.png)


ë¹„ìŠ·í•œ ë°©ì‹ìœ¼ë¡œëŠ” DinD(Docker in Docker)ê°€ ìˆëŠ”ë°, ì´ ê²½ìš°ëŠ” í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œì˜ docker daemonê³¼ëŠ” ë³„ê°œë¡œ ì»¨í…Œì´ë„ˆ ë‚´ì— docker daemonì„ ì‹¤í–‰ ì‹œí‚¤ëŠ” ê²ƒì´ë‹¤. 
ì´ ë•Œ, í˜¸ìŠ¤íŠ¸ ì‹œìŠ¤í…œì˜ ê¶Œí•œì„ ì–»ì„ìˆ˜ ìˆê²Œ --privilegedì˜µì…˜ì„ ì‚¬ìš©í•´ì•¼í•œë‹¤. privilegedë¥¼ ê°€ì§„ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ë©´ ì»¨í…Œì´ë„ˆì™€ í˜¸ìŠ¤íŠ¸ ê°„ì˜ ê²©ë¦¬ê°€ ëœ ë˜ê¸°ë„í•˜ê³ , ìœ„ì—ì„œ ë§í•œ ê²ƒì²˜ëŸ¼ í˜¸ìŠ¤íŠ¸ì™€ ê°™ì´ root ì‚¬ìš©ìì™€ ë™ì¼í•œ ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— ë³´ì•ˆì ìœ¼ë¡œ ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆë‹¤. ì´ëŸ° ì´ìœ ë“¤ë¡œ DinDë³´ë‹¤ëŠ” DooD ë°©ì•ˆì„ ë” ê¶Œì¥í•˜ëŠ” ë¶„ìœ„ê¸°ë‹¤.

![5-3](/assets/img/kans3-2024/w1/5-3.png)


```
root@MyServer:~# docker run --privileged --name dind-container -d docker:dind
70c421b51eae9dd33443dfd181dcd99a6ef33e45f8d68dcb2aca05e470956f98
root@MyServer:~# docker ps
CONTAINER ID   IMAGE             COMMAND                  CREATED             STATUS             PORTS                                                                                      NAMES
70c421b51eae   docker:dind       "dockerd-entrypoint.â€¦"   6 seconds ago       Up 5 seconds       2375-2376/tcp                                                                              dind-container

root@MyServer:~# docker exec -it 70 sh
/ # docker run -d --rm --name webserver nginx:alpine
Unable to find image 'nginx:alpine' locally
alpine: Pulling from library/nginx
...
Status: Downloaded newer image for nginx:alpine
3106590f6649bc8fbec7675eacdc70ba62672d74337705ead81d274c4193e115
/ # docker ps
CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS     NAMES
3106590f6649   nginx:alpine   "/docker-entrypoint.â€¦"   55 seconds ago   Up 54 seconds   80/tcp    webserver

# í˜¸ìŠ¤íŠ¸ì—ì„œëŠ” nginx ì»¨í…Œì´ë„ˆê°€ ì•ˆë³´ì´ëŠ” ê²ƒì„ í™•ì¸
root@MyServer:~# docker ps
CONTAINER ID   IMAGE             COMMAND                  CREATED             STATUS             PORTS                                                                                      NAMES
70c421b51eae   docker:dind       "dockerd-entrypoint.â€¦"   2 minutes ago       Up 2 minutes       2375-2376/tcp                                                                              dind-container
```

![5-1](/assets/img/kans3-2024/w1/5-1.png)


