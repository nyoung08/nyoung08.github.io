---
layout: post
title: pkos) gcpì—ì„œì˜ kops ì²´í—˜ê¸°
category: study
tags: study
---


ì˜¬í•´ë„ ì–´ê¹€ì—†ì´ ìŠ¤í„°ë””ì— ì°¸ì—¬í•  ìˆ˜ ìˆëŠ” ê¸°íšŒê°€ ìƒê²¨ì„œ â€˜24ë‹¨ê³„ ì‹¤ìŠµìœ¼ë¡œ ì •ë³µí•˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤â€™ ì±…ê³¼ í•¨ê»˜ ì§„í–‰ë˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ ìš´ì˜ í™˜ê²½ ìŠ¤í„°ë””ì— ì°¸ì—¬í•˜ê²Œ ë˜ì—ˆë‹¤.


# kops [ğŸ”—](https://kops.sigs.k8s.io/)

kops(Kubernetes Operations)ëŠ” kubernetes clusterë¥¼ ì‰½ê²Œ ë°°í¬, ê´€ë¦¬í•´ì£¼ëŠ” íˆ´ì´ë‹¤. kops controller serverê°€ kubernetesì˜ ì„¤ì •íŒŒì¼ì„ gcsì— ìƒì„±í•˜ê³  í•´ë‹¹ íŒŒì¼ì„ ë”°ë¼ clusterê°€ ìƒì„±ëœë‹¤. ìŠ¤í„°ë”” ë•Œì—ëŠ” awsí™˜ê²½ì—ì„œ ì§„í–‰ë˜ì—ˆì—ˆëŠ”ë°, ì–´ë–¤ì‹ìœ¼ë¡œ êµ¬ì„±ë˜ëŠ”ì§€ ê¶ê¸ˆí•˜ì—¬ gcpì—ì„œ í…ŒìŠ¤íŠ¸í•´ë³´ì•˜ë‹¤. ë¬¸ì„œë¥¼ ë³´ë©´ gcpë„ ê³µì‹ì§€ì›í•œë‹¤ê³ ëŠ” í•˜ì§€ë§Œ, ë§‰ìƒ í…ŒìŠ¤íŠ¸í•´ë³´ë‹ˆ awsë§Œí¼ê¹Œì§€ëŠ” ì•„ë‹Œ ê²ƒ ê°™ë‹¤. 


# kops controller server ìƒì„±

test server osëŠ” centos7ì´ê³  ë³„ë‹¤ë¥¸ ìˆ˜ì •í•˜ì§€ ì•Šê³  ê¸°ë³¸ê°’ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í–ˆë‹¤. ë³€ê²½ í•œ ê²ƒì€ gcsì— ì ‘ê·¼í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— cloud api access scopesì„ ì¡°ì •í•´ì¤€ ê²ƒê³¼ ì‹œì‘ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í–ˆë‹¤. ê³„ì† ì“¸ ê²ƒì´ ì•„ë‹ˆê³  ì¼íšŒì„±ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ í•  ê²ƒì´ë¼ ë“¤ì–´ê°”ì„ ë•Œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆë„ë¡ ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë„£ì—ˆë‹¤.  

```
### startup-script
### install kubectl, helm, yh(yaml syntax highlighter)

#!/bin/bash
hostnamectl --static set-hostname kops
# Change Timezone
ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime
# Install Packages
cd /root
yum -y install tree jq git htop wget unzip
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
curl -Lo kops https://github.com/kubernetes/kops/releases/download/$(curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | grep tag_name | cut -d '"' -f 4)/kops-linux-amd64
chmod +x kops
mv kops /usr/local/bin/kops
ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa
echo 'alias vi=vim' >> /etc/profile
echo 'sudo su -' >> /home/$USER/.bashrc
curl -s https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
wget https://github.com/andreazorzetto/yh/releases/download/v0.4.0/yh-linux-amd64.zip
unzip yh-linux-amd64.zip
mv yh /usr/local/bin/
```

ìƒì„± í™•ì¸

```
[root@kops ~]# kubectl version --client=true -o yaml | yh
clientVersion:
  buildDate: "2023-02-22T13:39:03Z"
  compiler: gc
  gitCommit: fc04e732bb3e7198d2fa44efa5457c7c6f8c0f5b
  gitTreeState: clean
  gitVersion: v1.26.2
  goVersion: go1.19.6
  major: "1"
  minor: "26"
  platform: linux/amd64
kustomizeVersion: v4.5.7

[root@kops ~]# kops version
Client version: 1.25.3 (git-v1.25.3)
```


# kops cluster ì„¤ì¹˜ [ğŸ”—](https://kops.sigs.k8s.io/getting_started/gce/)

âœï¸  cloud dnsì— publicìœ¼ë¡œ dns zoneì´ ìƒì„±ë˜ì–´ìˆì–´ì•¼ í•œë‹¤.

```
# create kops config storage
[root@kops ~]# gcloud storage buckets create gs://nyoung-k8s --location=asia-northeast3
Creating gs://nyoung-k8s/...

# set environment variables
[root@kops ~]# export REGION=asia-northeast3
[root@kops ~]# export KOPS_CLUSTER_NAME=test.nyoung.xyz
[root@kops ~]# export KOPS_STATE_STORE=gs://nyoung-k8s
[root@kops ~]# export PROJECT=`gcloud config get-value project`
[root@kops ~]# echo 'export REGION=asia-northeast3' >>~/.bashrc
[root@kops ~]# echo 'export KOPS_CLUSTER_NAME=test.nyoung.xyz' >>~/.bashrc
[root@kops ~]# echo 'export KOPS_STATE_STORE=gs://nyoung-k8s' >>~/.bashrc
[root@kops ~]# echo 'export PROJECT=`gcloud config get-value project`' >>~/.bashrc

# create cluster
# saê¶Œí•œì€ editorì™€ storage object adminë¥¼ ë¶€ì—¬í•¨  
[root@kops ~]# kops create cluster --name=$KOPS_CLUSTER_NAME --networking=kubenet \
--cloud=gce --master-size=e2-medium --node-size=e2-medium --node-count=2 \
--zones="$REGION"-a --state=$KOPS_STATE_STORE --project=$PROJECT -y \
--gce-service-account="kops-855@$PROJECT_ID.iam.gserviceaccount.com" \
--api-loadbalancer-type=public 
.
.
.
Cluster is starting.  It should be ready in a few minutes.
```

clusterê°€ ì‹œì‘í•œë‹¤ëŠ” ë©”ì„¸ì§€ë¥¼ ë³´ê³  cloud dnsì— ë ˆì½”ë“œ ì¶”ê°€ê°€ í•„ìš”í•˜ë‹¤. ì›ë˜ëŠ” ìë™ë“±ë¡ë˜ëŠ” ê²ƒì´ ë§ì§€ë§Œ.. gcpëŠ” api.masterpublicnameì´ ë“±ë¡ë˜ì–´ìˆì§€ ì•Šì•˜ë‹¤. ë§Œë“¤ì–´ì ¸ìˆëŠ” cloud dnsë¥¼ ë³´ë©´ ë‹¤ë¥¸ apië“¤ì— ëŒ€í•´ í™•ì¸ í•  ìˆ˜ ìˆë‹¤. 
validateì„ ìœ„í•´, master nodeì˜ lb ipì™€ í•¨ê»˜ a ë ˆì½”ë“œë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.


```
# validate
# master nodeê°€ health checkì— í†µê³¼ë˜ê¸°ê¹Œì§€ ì¡°ê¸ˆ ê¸°ë‹¤ë ¤ì•¼í•œë‹¤.

[root@kops ~]# kops validate cluster
Validating cluster test.nyoung.xyz

I0310 01:02:47.095337    2309 gce_cloud.go:295] Scanning zones: [asia-northeast3-a asia-northeast3-b asia-northeast3-c]
INSTANCE GROUPS
NAME				ROLE	MACHINETYPE	MIN	MAX	SUBNETS
master-asia-northeast3-a	Master	e2-medium	1	1	asia-northeast3
nodes-asia-northeast3-a		Node	e2-medium	2	2	asia-northeast3

NODE STATUS
NAME				ROLE	READY
master-asia-northeast3-a-pd4x	master	True
nodes-asia-northeast3-a-4xqs	node	True
nodes-asia-northeast3-a-b2jd	node	True

Your cluster test.nyoung.xyz is ready
```

# í™•ì¸ í…ŒìŠ¤íŠ¸

ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì–´ í™•ì¸ í›„ í…ŒìŠ¤íŠ¸ë¥¼ ë„ì›Œë³´ì•˜ë‹¤.

```
# dns í™•ì¸
[root@kops ~]# gcloud dns record-sets list -z test-nyoung-xyz  --filter="type=A"
NAME                                       TYPE  TTL  DATA
api.test.nyoung.xyz.                       A     300  34.64.90.59
api.internal.test.nyoung.xyz.              A     60   10.0.16.4
kops-controller.internal.test.nyoung.xyz.  A     60   10.0.16.4

# cluster í™•ì¸
[root@kops ~]# kops get cluster
NAME		CLOUD	ZONES
test.nyoung.xyz	gce
[root@kops ~]# kubectl cluster-info
Kubernetes control plane is running at https://api.test.nyoung.xyz
CoreDNS is running at https://api.test.nyoung.xyz/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

# node í™•ì¸
[root@kops ~]# kops get ig
NAME				ROLE	MACHINETYPE	MIN	MAX	ZONES
master-asia-northeast3-a	Master	e2-medium	1	1	asia-northeast3-a
nodes-asia-northeast3-a		Node	e2-medium	2	2	asia-northeast3-a
[root@kops ~]# kubectl get no
NAME                            STATUS   ROLES           AGE     VERSION
master-asia-northeast3-a-pd4x	  Ready    control-plane   7m55s   v1.25.7
nodes-asia-northeast3-a-4xqs    Ready    node            6m41s   v1.25.7
nodes-asia-northeast3-a-b2jd    Ready    node            6m41s   v1.25.7

# kubenetes compoenets podë“¤ë„ ì˜ ë– ìˆëŠ” ê²ƒì„ í™•ì¸ ê°€ëŠ¥
[root@kops ~]# kubectl get pod -n kube-system -o=custom-columns=NAME:.metadata.name,IP:.status.podIP,STATUS:.status.phase
NAME                                                    IP           STATUS
cloud-controller-manager-p6h2c                          10.0.16.4    Running
coredns-5687f9bc7f-btxcr                                100.96.2.2   Running
coredns-5687f9bc7f-vmqjw                                100.96.1.2   Running
coredns-autoscaler-975545559-8kb4l                      100.96.1.3   Running
dns-controller-6d6bfdfb95-6t4gk                         10.0.16.4    Running
etcd-manager-events-master-asia-northeast3-a-pd4x       10.0.16.4    Running
etcd-manager-main-master-asia-northeast3-a-pd4x         10.0.16.4    Running
kops-controller-946pz                                   10.0.16.4    Running
kube-apiserver-master-asia-northeast3-a-pd4x            10.0.16.4    Running
kube-controller-manager-master-asia-northeast3-a-pd4x   10.0.16.4    Running
kube-proxy-master-asia-northeast3-a-pd4x                10.0.16.4    Running
kube-proxy-nodes-asia-northeast3-a-4xqs                 10.0.16.2    Running
kube-proxy-nodes-asia-northeast3-a-b2jd                 10.0.16.3    Running
kube-scheduler-master-asia-northeast3-a-pd4x            10.0.16.4    Running


# í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ìƒì„±
[root@kops ~]# curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/1/mario.yaml
[root@kops ~]# kubectl apply -f mario.yaml
deployment.apps/mario created
service/mario created
[root@kops ~]# kubectl get deploy,svc,ep mario
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/mario   1/1     1            1           3m27s

NAME            TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)        AGE
service/mario   LoadBalancer   100.70.23.173   34.64.179.13   80:31077/TCP   3m27s

NAME              ENDPOINTS         AGE
endpoints/mario   100.96.2.3:8080   3m26s
```

ğŸ¤—
![1-1](/assets/img/pkos/kops/1-1.png)


# external dns [ğŸ”—](https://github.com/kubernetes-sigs/external-dns)

ìŠ¤í„°ë”” ì‹œê°„ì— ì• ë“œì˜¨ìœ¼ë¡œ ìˆëŠ” external dnsë¥¼ ë´¤ëŠ”ë°, ë„ˆë¬´ í¸ë¦¬í•˜ê³  ì¢‹ì•„ë³´ì—¬ì„œ gcpì—ì„œë„ í•´ë³´ê³  ì‹¶ì—ˆë‹¤. ë¬¸ì„œì—ëŠ” gkeì—ì„œ ì ìš©í•˜ëŠ” ê²ƒ ë§ê³ ëŠ” ëª»ì°¾ê² ì–´ì„œ, ê·¸ëƒ¥ í•´ë´¤ëŠ”ë° ëë‹¤..!
awsì—ì„œëŠ” masterì™€ node instance profilesì—ê²Œ dns record setì— ëŒ€í•´ change, list, get ê¶Œí•œì„ ì¶”ê°€í•´ì£¼ì—ˆê¸° ë•Œë¬¸ì—, gcpì—ì„œë„ ê° ë…¸ë“œë“¤ì´ ê°€ì§€ê³  ìˆëŠ” service accountì˜ ê¶Œí•œì´ ìˆìœ¼ë©´ ë  ê²ƒ ê°™ë‹¤. í˜„ì¬ service accountì€ editorë¡œ dns record setì— ëŒ€í•´ ì½ê±°ë‚˜ ë³€ê²½ì´ ê°€ëŠ¥í•˜ì—¬ ë‹¤ë¥¸ ê¶Œí•œì€ ì¶”ê°€í•˜ì§€ ì•Šì•˜ë‹¤.
 
```
# cluster configì—ì„œ spec í•˜ìœ„ì— externalDnsë¥¼ ì¶”ê°€
[root@kops ~]# kops edit cluste
spec:
  externalDns:
    provider: external-dns

# update
[root@kops ~]# kops update cluster --yes 
[root@kops ~]# kops rolling-update cluster

# lbì— external dns annotation ì¶”ê°€
[root@kops ~]# kubectl annotate service mario "external-dns.alpha.kubernetes.io/hostname=mario.$KOPS_CLUSTER_NAME"

# í™•ì¸
[root@kops ~]# dig +short mario.$KOPS_CLUSTER_NAME
34.64.179.13
[root@kops ~]# echo -e "Maria Game URL = http://mario.$KOPS_CLUSTER_NAME"
Maria Game URL = http://mario.test.nyoung.xyz
```

![1-2](/assets/img/pkos/kops/1-2.png)

```
# cloud dnsë¥¼ í™•ì¸í•´ë³´ë©´ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸ ê°€ëŠ¥
[root@kops ~]# gcloud dns record-sets list -z test-nyoung-xyz  --filter="type=A"
NAME                                       TYPE  TTL  DATA
api.test.nyoung.xyz.                       A     300  34.64.116.234
api.internal.test.nyoung.xyz.              A     60   10.0.16.4
kops-controller.internal.test.nyoung.xyz.  A     60   10.0.16.4
mario.test.nyoung.xyz.                     A     300  34.64.179.13
```



ğŸš§ í•´ë‹¹ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ë©° ë§ˆì£¼í–ˆë˜ ì˜¤ë¥˜ë“¤
ëª¨ë“  ì˜¤ë¥˜ê°€.. cluster ìƒì„±í•˜ë©´ì„œ ë°œìƒí–ˆì—ˆë‹¤.. .ğŸ˜‡

ì˜¤ë¥˜ 1 
Error: error populating configuration: error fetching network "2-nyoung-xyz": googleapi: Error 400: Invalid value for field 'network': '2-nyoung-xyz'. Must be a match of regex '[a-z](?:[-a-z0-9]{0,61}[a-z0-9])?|[1-9][0-9]{0,19}', invalid

â–¶ï¸ Â ë§¨ ì•ì´ ë¬¸ìë¡œ ì§€ì •ë˜ì–´ìˆì–´ì„œ dnsëŠ” ìˆ«ìë¡œ ì‹œì‘í•˜ë©´ ì•ˆëœë‹¤. dns ë³€ê²½..
 
ì˜¤ë¥˜2
Error: error running tasks: deadline exceeded executing task ProjectIAMBinding/serviceaccount-nodes. Example error: error updating IAM for project $PROJECT_ID: googleapi: Error 403: Policy update access denied., forbidden

â–¶ï¸Â  --gce-service-account: ...if not set, VMs will run as default compute service account. ë¼ê³  ë˜ì–´ìˆì§€ë§Œ.. ë³´ë©´ instanceë¥¼ ë§Œë“¤ë©´ì„œ ì²˜ìŒë³´ëŠ” service accountë¡œ ì§€ì •í•´ë²„ë¦°ë‹¤.. 

ì˜¤ë¥˜3
error running task "ServiceAccount/shared" (3m44s remaining to succeed): unexpected format for ServiceAccount email "$default_compute_engine_sa@developer.gserviceaccount.com"

â–¶ï¸Â  ì˜¤ë¥˜2ì™€ ê°™ì€ ìƒí™©ì—ì„œ compute engine default saë¡œ ì§€ì •í•˜ê³  ìƒì„±í•˜ë ¤ëŠ” í˜•ì‹ì´ ë‹¤ë¥´ë‹¤ê³  ì˜¤ë¥˜ê°€ ë‚¬ë‹¤. ì—¬ê¸°ë„ ì˜¤ë¥˜1ì²˜ëŸ¼ saì— ëŒ€í•œ í˜•ì‹ì„ ì§€ì •í•œê±°ê°™ì€ë°, ê·¸ê²Œ ì•„ë¬´ë˜ë„ ë¬¸ìì—´@project_id.iam.gserviceaccount.com ì¸ ê²ƒ ê°™ë‹¤. ìƒˆë¡œ ë§Œë“¤ì–´ì„œ ìƒì„± ì‹œ ì´ìƒì—†ì´ ì˜ëœë‹¤.

ì˜¤ë¥˜4
unexpected error during validation: unable to resolve Kubernetes cluster API URL dns: lookup api.test.nyoung.xyz on 169.254.169.254:53: no such host

â–¶ï¸Â  validate í•˜ë ¤ëŠ”ë° api.nyoung.xyzê°€ ì—†ë‹¤í•˜ì—¬ ì§ì ‘ ë“±ë¡í•¨

ì˜¤ë¥˜5
ì„¤ì¹˜ í›„ ì•„ë¬´ë¦¬ ê¸°ë‹¤ë ¤ë„ master nodeì˜ health checkê°€ í†µê³¼ë˜ì§€ ì•Šì•„ ë¡œê·¸ë¥¼ í™•ì¸í•´ë´¤ë‹¤.
got error running nodeup (will retry in 30s): error loading Cluster "gs://nyoung-k8s/test.nyoung.xyz/cluster-completed.spec": error reading gs://nyoung-k8s/test.nyoung.xyz/cluster-completed.spec: googleapi: got HTTP response code 403 with body: kops-855@$PROJECT_ID.iam.gserviceaccount.com does not have storage.objects.get access to the Google Cloud Storage object. Permission &#39;storage.objects.get&#39; denied on resource (or it may not exist).

â–¶ï¸Â  storage.objects.get ê¶Œí•œ í•„ìš”. ì°¸ê³ ë¡œ editorì—ëŠ” ì—†ìŒ.. 



ë§Œì•½, ë°°í¬í•˜ë‹¤ ì˜¤ë¥˜ê°€ ë‚œë‹¤ë©´ í•˜ë‚˜ì”© ì‚­ì œë¥¼ í•´ì•¼í•œë‹¤.
1. kops delete cluster --yes ì‹œë„ (ì˜ ì§€ì›Œì§„ ê²ƒì²˜ëŸ¼ ë‚˜ì™€ë„ ì•„ë˜ ì ˆì°¨ë¥¼ í™•ì¸í•´ì•¼í•¨)
2. gce instance group, template, vpc ì‚­ì œ
3. storage bucket ë¹„ìš°ê¸°
4. cloud dns a ë ˆì½”ë“œ ì‚­ì œ


---
ì°¸ê³ 
- [https://kops.sigs.k8s.io/getting_started/gce/](https://kops.sigs.k8s.io/getting_started/gce/)
- [https://github.com/kubernetes-sigs/external-dns](https://github.com/kubernetes-sigs/external-dns)
