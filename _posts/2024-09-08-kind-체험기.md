---
layout: post
title: KANS3) kind ì²´í—˜ê¸°
category: study
tags: study
---


# kind

ì§€ë‚œë²ˆì— ì‘ì„±í–ˆë˜ docker in dockerì˜ ë°©ì‹ìœ¼ë¡œ, docker container ì•ˆì— ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ì„ ë§Œë“¤ì–´ì£¼ëŠ” ë„êµ¬ì´ë‹¤. [ğŸ”—](https://kind.sigs.k8s.io/)
ì•„ë˜ ì‹¤ìŠµ í™˜ê²½ì€ virtualboxì— ìš°ë¶„íˆ¬ë¥¼ ì˜¬ë ¤ì„œ ì‚¬ìš©í–ˆëŠ”ë°, ì´ê±´ ê°€ì‹œë‹¤ë‹˜ì´ ë§ë“¤ì–´ë‘” vagrant íŒŒì¼ì„ ì‚¬ìš©í–ˆë‹¤. varantfileì—ì„œ provisionì‹œ ì°¸ê³ í•˜ëŠ” init_cfg.sh íŒŒì¼ì— ê¸°ë³¸ì ìœ¼ë¡œ kind, kubectl ë“± íˆ´ ì„¤ì¹˜ê¹Œì§€ í¬í•¨ë˜ì–´ìˆë‹¤.

![1-0](/assets/img/kans3-2024/w2/1-0.png)


## ì„¤ì¹˜ ë° í™˜ê²½ í™•ì¸
```
# Ubuntu ë°°í¬ ê´€ë ¨ Vagrantfile, init_cfg.sh íŒŒì¼ ë‹¤ìš´ë¡œë“œ
â¯ curl -O https://raw.githubusercontent.com/gasida/KANS/main/kind/Vagrantfile
â¯ curl -O https://raw.githubusercontent.com/gasida/KANS/main/kind/init_cfg.sh

# vagrant ë¡œ ubuntu ê°€ìƒë¨¸ì‹  1ëŒ€ í”„ë¡œë¹„ì €ë‹
â¯ vagrant up
... 
# vagrant ìƒíƒœ í™•ì¸ ë° ì ‘ì†
â¯ vagrant status
â¯ vagrant ssh

# kind vm ë‚´ë¶€
root@kind:~# whoami
root
root@kind:~# hostnamectl
 Static hostname: kind
       Icon name: computer-vm
         Chassis: vm
      Machine ID: 70eaa6d6c91f4656a250c177368ecc20
         Boot ID: 2e90dc616d85469494b4a84bec8e0c02
  Virtualization: oracle
Operating System: Ubuntu 22.04.4 LTS
          Kernel: Linux 5.15.0-119-generic
    Architecture: x86-64
 Hardware Vendor: innotek GmbH
  Hardware Model: VirtualBox
 
root@kind:~# ip -c a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 02:c6:f7:1b:46:08 brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 metric 100 brd 10.0.2.255 scope global dynamic enp0s3
       valid_lft 86227sec preferred_lft 86227sec
    inet6 fe80::c6:f7ff:fe1b:4608/64 scope link
       valid_lft forever preferred_lft forever
3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:0f:e2:89 brd ff:ff:ff:ff:ff:ff
    inet 192.168.50.10/24 brd 192.168.50.255 scope global enp0s8
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fe0f:e289/64 scope link
       valid_lft forever preferred_lft forever
4: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default
    link/ether 02:42:21:71:08:60 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
```


ì²«ë²ˆì§¸ ì¸í„°í˜ì´ìŠ¤ enp0s3ì€ natëª¨ë“œë¡œ êµ¬ì„±ë˜ì–´ìˆë‹¤. vm ë‚´ë¶€ì—ì„œ ë‚˜ì˜¬ ì‹œ, í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ host ipë¥¼ ë¬¼ê³  ë‚˜ê°€ê²Œëœë‹¤. 
í˜„ì¬ ì´ë¶€ë¶„ ì„¤ì •ì— sshë¥¼ 60000ë²ˆ í¬íŠ¸ë¡œ ì ‘ê·¼ í•  ìˆ˜ ìˆë„ë¡ í¬íŠ¸í¬ì›Œë”© ì„¤ì •ì´ ë˜ì–´ìˆëŠ” ìƒíƒœì´ë‹¤.

<img src="/assets/img/kans3-2024/w2/2-0.png" width="400" height="300"/>
<img src="/assets/img/kans3-2024/w2/2-1.png" width="400" height="300"/>

ë‘ë²ˆì§¸ ì¸í„°í˜ì´ìŠ¤ì¸ enp0s8ì€ í˜¸ìŠ¤íŠ¸ ì „ìš© ë„¤íŠ¸ì›Œí¬ë¡œ êµ¬ì„±ë˜ì–´ìˆë‹¤. vmë¼ë¦¬ í˜¹ì€ hostì™€ vmê°„ì˜ í†µì‹  í•„ìš”ì‹œ ì‚¬ìš©ëœë‹¤. 

<img src="/assets/img/kans3-2024/w2/2-3.png" width="400" height="300"/>


```
# hostì—ì„œ telnetìœ¼ë¡œ í™•ì¸í•´ë´¤ë‹¤
# enp0s3ì˜ ê²½ìš°, 6000ë²ˆìœ¼ë¡œ í¬íŠ¸í¬ì›Œë”© í–ˆê¸°ì— 127.0.0.2:6000 
â¯ telnet 127.0.0.1 60000
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.10
# enp0s8ì˜ ê²½ìš°, hostì™€ vmê°„ natì—†ì´ í†µì‹ ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— vm ip:22ë¡œ í™•ì¸ ê°€ëŠ¥
â¯ telnet 192.168.50.10 22
Trying 192.168.50.10...
Connected to nyoung.com.
Escape character is '^]'.
SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.10

# enp0s3ì˜ ip:22ì™€ 10.0.2.2:58115ëŠ” sshd: vagrant í”„ë¡œì„¸ìŠ¤ë¡œ ì—°ê²°ëœ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŒ
## natëª¨ë“œì˜ ê²½ìš° 10.0.2.2ëŠ” gw ip
root@kind:~# netstat -napl | grep ssh
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      2137/sshd: /usr/sbi
tcp        0      0 10.0.2.15:22            10.0.2.2:58115          ESTABLISHED 4301/sshd: vagrant
tcp6       0      0 :::22                   :::*                    LISTEN      2137/sshd: /usr/sbi
```

ì—°ê²°ëœ ê²ƒì´ 192.168.50.10:22ì´ ì•„ë‹Œ 10.0.2.15:22ì´ê¸° ë•Œë¬¸ì—, nat modeì¸ enp0s3ì˜ í¬íŠ¸í¬ì›Œë”©ì„ í†µí•´ ì—°ê²°ëœ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.
ssh ì—°ê²° íë¦„ì„ ë³´ìë©´ ì•„ë˜ì™€ ê°™ë‹¤.
127.0.0.1:60000 â†’ 10.0.2.2:58115 â†’ 10.0.2.15:22


## kind cluster ìƒì„± ë° í™˜ê²½ í™•ì¸

### network

```
# cluster ìƒì„± ì „ 
root@kind:~# docker network ls
NETWORK ID     NAME      DRIVER    SCOPE
c4a3e6bcfdff   bridge    bridge    local
36a9773d81fa   host      host      local
aacb4af19c13   none      null      local

# cluster ìƒì„±
root@kind:~# cat << EOT > kind-2node.yaml
# two node (one workers) cluster config
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
EOT
root@kind:~# kind create cluster --config kind-2node.yaml --name myk8s
Creating cluster "myk8s" ...
 âœ“ Ensuring node image (kindest/node:v1.31.0) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦ ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
 âœ“ Joining worker nodes ğŸšœ
Set kubectl context to "kind-myk8s"
You can now use your cluster with:

kubectl cluster-info --context kind-myk8s

Have a nice day! ğŸ‘‹

# cluster í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# kind get nodes --name myk8s
myk8s-worker
myk8s-control-plane
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl cluster-info
Kubernetes control plane is running at https://127.0.0.1:33455
CoreDNS is running at https://127.0.0.1:33455/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

# ì»¨í…Œì´ë„ˆë¥¼ í™•ì¸í•´ë³´ë©´, ê° ì»¨í…Œì´ë„ˆì˜ ì´ë¦„ì´ ì»¨í”„ë¡¤í”Œë ˆì¸, ì›Œì»¤ë…¸ë“œë¡œ ë˜ì–´ìˆë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS         PORTS                       NAMES
bc4534e3ecac   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   2 minutes ago   Up 2 minutes                               myk8s-worker
5891b81cfe35   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   2 minutes ago   Up 2 minutes   127.0.0.1:33455->6443/tcp   myk8s-control-plane

# ì»¨í”„ë¡¤í”Œë ˆì¸ ì»¨í…Œì´ë„ˆì˜ 6443 í¬íŠ¸ê°€ ì–´ë–¤ í”„ë¡œì„¸ìŠ¤ë¡œ ì“°ì´ëŠ”ì§€ í™•ì¸í•´ë³´ë©´, kube-apiserverë¡œ ë‚˜ì˜¨ë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-control-plane ss -tnlp | grep 6443
LISTEN 0      4096               *:6443             *:*    users:(("kube-apiserver",pid=575,fd=3))

# ì»¨í”„ë¡¤í”Œë ˆì¸ ì»¨í…Œì´ë„ˆì—ì„œ ëŒê³  ìˆëŠ” kube-apiserver í”„ë¡œì„¸ìŠ¤ëŠ” í•˜ë‚˜ì˜ íŒŒë“œë¡œ ë™ì‘ ì¤‘ì„
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get pod -n kube-system -l component=kube-apiserver -owide
NAME                                 READY   STATUS    RESTARTS   AGE     IP           NODE                  NOMINATED NODE   READINESS GATES
kube-apiserver-myk8s-control-plane   1/1     Running   0          2m38s   172.18.0.2   myk8s-control-plane   <none>           <none>


# ë§¨ì²˜ìŒ í™•ì¸í–ˆë˜ docker network lsë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ë©´, network nameì— kindê°€ ìƒê²¨ìˆë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# docker network ls
NETWORK ID     NAME      DRIVER    SCOPE
c4a3e6bcfdff   bridge    bridge    local
36a9773d81fa   host      host      local
9fb3efb629ed   kind      bridge    local
aacb4af19c13   none      null      local

# kindì—ì„œ ì‚¬ìš©í•˜ëŠ” ëŒ€ì—­ëŒ€: 172.18.0.0/16
(âˆ|kind-myk8s:N/A) root@kind:~# docker inspect kind | jq
[
  {
    "Name": "kind",
    "Id": "9fb3efb629ede680c24bdf527c5c221b18c69f8ea2929dbdfdc242e2ec344917",
    "Created": "2024-09-08T00:27:02.831474838+09:00",
    "Scope": "local",
    "Driver": "bridge",
    "EnableIPv6": true,
    "IPAM": {
      "Driver": "default",
      "Options": {},
      "Config": [
        {
          "Subnet": "fc00:f853:ccd:e793::/64"
        },
        {
          "Subnet": "172.18.0.0/16",
          "Gateway": "172.18.0.1"
        }
      ]
   ...
]

# í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜ í›„ ì¶”ê°€ëœ kind ì¸í„°í˜ì´ìŠ¤
(âˆ|kind-myk8s:N/A) root@kind:~# ip -c a
...
5: br-9fb3efb629ed: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:af:1a:63:36 brd ff:ff:ff:ff:ff:ff
    inet 172.18.0.1/16 brd 172.18.255.255 scope global br-9fb3efb629ed
...
```

### kubectl ëª…ë ¹ì–´ë¥¼ í†µí•œ í™•ì¸

```
# cri: containerd
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get node -owide
NAME                  STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION       CONTAINER-RUNTIME
myk8s-control-plane   Ready    control-plane   19m   v1.31.0   172.18.0.2    <none>        Debian GNU/Linux 12 (bookworm)   5.15.0-119-generic   containerd://1.7.18
myk8s-worker          Ready    <none>          19m   v1.31.0   172.18.0.3    <none>        Debian GNU/Linux 12 (bookworm)   5.15.0-119-generic   containerd://1.7.18

# cni: kindnet
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get pod -A -owide
NAMESPACE            NAME                                          READY   STATUS    RESTARTS   AGE   IP           NODE                  NOMINATED NODE   READINESS GATES
kube-system          coredns-6f6b679f8f-s9czc                      1/1     Running   0          20m   10.244.0.4   myk8s-control-plane   <none>           <none>
kube-system          coredns-6f6b679f8f-vh5fb                      1/1     Running   0          20m   10.244.0.3   myk8s-control-plane   <none>           <none>
kube-system          etcd-myk8s-control-plane                      1/1     Running   0          20m   172.18.0.2   myk8s-control-plane   <none>           <none>
kube-system          kindnet-8x77g                                 1/1     Running   0          19m   172.18.0.3   myk8s-worker          <none>           <none>
kube-system          kindnet-v6rwq                                 1/1     Running   0          20m   172.18.0.2   myk8s-control-plane   <none>           <none>
kube-system          kube-apiserver-myk8s-control-plane            1/1     Running   0          20m   172.18.0.2   myk8s-control-plane   <none>           <none>
kube-system          kube-controller-manager-myk8s-control-plane   1/1     Running   0          20m   172.18.0.2   myk8s-control-plane   <none>           <none>
kube-system          kube-proxy-l97cd                              1/1     Running   0          20m   172.18.0.2   myk8s-control-plane   <none>           <none>
kube-system          kube-proxy-tvqp6                              1/1     Running   0          19m   172.18.0.3   myk8s-worker          <none>           <none>
kube-system          kube-scheduler-myk8s-control-plane            1/1     Running   0          20m   172.18.0.2   myk8s-control-plane   <none>           <none>
local-path-storage   local-path-provisioner-57c5987fd4-j65ll       1/1     Running   0          20m   10.244.0.2   myk8s-control-plane   <none>           <none>
# local-path-storageëŠ” ë³¼ë¥¨ì„ ê´€ë¦¬í•œë‹¤.

# local-pathë¼ëŠ” storageClassê°€ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì¹˜ë˜ì–´, ë…¸ë“œì˜ ë¡œì»¬ ì €ì¥ì†Œë¥¼ í™œìš©í•˜ê²Œëœë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get sc
NAME                 PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
standard (default)   rancher.io/local-path   Delete          WaitForFirstConsumer   false                  25m

(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get deploy -n local-path-storage
NAME                     READY   UP-TO-DATE   AVAILABLE   AGE
local-path-provisioner   1/1     1            1           25m

```

### ì»¨í…Œì´ë„ˆ ì ‘ê·¼ì„ í†µí•œ í™•ì¸

```
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-control-plane tree /etc/kubernetes/manifests/
/etc/kubernetes/manifests/
|-- etcd.yaml
|-- kube-apiserver.yaml
|-- kube-controller-manager.yaml
`-- kube-scheduler.yaml

1 directory, 4 files

# ì»¨í”„ë¡¤í”Œë ˆì¸ ì»¨í…Œì´ë„ˆ ì ‘ì†
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-control-plane bash

root@myk8s-control-plane:/# systemctl status kubelet
â— kubelet.service - kubelet: The Kubernetes Node Agent
     Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; preset: enabled)
    Drop-In: /etc/systemd/system/kubelet.service.d
             â””â”€10-kubeadm.conf, 11-kind.conf
     Active: active (running) since Sat 2024-09-07 15:27:31 UTC; 3h 27min ago
     ...
root@myk8s-control-plane:/# systemctl status containerd
â— containerd.service - containerd container runtime
     Loaded: loaded (/etc/systemd/system/containerd.service; enabled; preset: enabled)
     Active: active (running) since Sat 2024-09-07 15:27:12 UTC; 3h 36min ago
     ...
     

# ë…¸ë“œ ë‚´ì˜ ì»¨í…Œì´ë„ˆë¥¼ í™•ì¸í•˜ë ¤ë©´, dockerê°€ ì•„ë‹Œ crictl ì„ ì‚¬ìš©í•´ì•¼í•œë‹¤.
root@myk8s-control-plane:/# docker ps
bash: docker: command not found

# í™•ì¸í•´ë³´ë©´, ë…¸ë“œ ì»¨í…Œì´ë„ˆ ë°–ì—ì„œ ë´¤ë˜ $docker psì—ì„œëŠ” í™•ì¸í•˜ì§€ ëª»í•œ ì»¨í…Œì´ë„ˆë“¤ì„ ë³¼ ìˆ˜ ìˆë‹¤.
root@myk8s-control-plane:/# crictl ps
CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID              POD
afe2d8015c2e3       cbb01a7bd410d       3 hours ago         Running             coredns                   0                   21d473a40b515       coredns-6f6b679f8f-vh5fb
b76926dc718ff       cbb01a7bd410d       3 hours ago         Running             coredns                   0                   f1754c08ce8d1       coredns-6f6b679f8f-s9czc
7887c1f9ae9b0       3a195b56ff154       3 hours ago         Running             local-path-provisioner    0                   d125d965756df       local-path-provisioner-57c5987fd4-j65ll
3f8ac2aaefdaf       12968670680f4       3 hours ago         Running             kindnet-cni               0                   25cd30c024e19       kindnet-v6rwq
43e8e4fd649ff       af3ec60a3d89b       3 hours ago         Running             kube-proxy                0                   691137d82fefc       kube-proxy-l97cd
f82ebfc4c13d5       2e96e5913fc06       3 hours ago         Running             etcd                      0                   e9e4e10d71678       etcd-myk8s-control-plane
80597733e1b9e       7e9a7dc204d9d       3 hours ago         Running             kube-controller-manager   0                   4cfbd9fdffbd2       kube-controller-manager-myk8s-control-plane
51c5a1b80615e       4f8c99889f8e4       3 hours ago         Running             kube-apiserver            0                   c3b19bed36904       kube-apiserver-myk8s-control-plane
c827d2bd0516d       418e326664bd2       3 hours ago         Running             kube-scheduler            0                   e6aab7c36a0f5       kube-scheduler-myk8s-control-plane

# ê°ê°ì˜ ì»¨í…Œì´ë„ˆì¸ í”„ë¡œì„¸ìŠ¤ë“¤
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-control-plane bash
root@myk8s-control-plane:/# pstree
systemd-+-containerd---19*[{containerd}]
        |-containerd-shim-+-kube-apiserver---11*[{kube-apiserver}]
        |                 |-pause
        |                 `-12*[{containerd-shim}]
        |-containerd-shim-+-etcd---10*[{etcd}]
        |                 |-pause
        |                 `-12*[{containerd-shim}]
        |-containerd-shim-+-kube-controller---6*[{kube-controller}]
        |                 |-pause
        |                 `-12*[{containerd-shim}]
        |-containerd-shim-+-kube-scheduler---9*[{kube-scheduler}]
        |                 |-pause
        |                 `-12*[{containerd-shim}]
        |-containerd-shim-+-kube-proxy---6*[{kube-proxy}]
        |                 |-pause
        |                 `-12*[{containerd-shim}]
        |-containerd-shim-+-kindnetd---9*[{kindnetd}]
        |                 |-pause
        |                 `-12*[{containerd-shim}]
        |-containerd-shim-+-local-path-prov---9*[{local-path-prov}]
        |                 |-pause
        |                 `-12*[{containerd-shim}]
        |-containerd-shim-+-coredns---9*[{coredns}]
        |                 |-pause
        |                 `-12*[{containerd-shim}]
        |-containerd-shim-+-coredns---10*[{coredns}]
        |                 |-pause
        |                 `-12*[{containerd-shim}]
        |-kubelet---13*[{kubelet}]
        `-systemd-journal
```


kind ëª…ë ¹ì–´ë¥¼ í†µí•´ ì†ì‰½ê²Œ ë…¸ë“œ ì»¨í…Œì´ë„ˆ ë‚´ì— í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤. ì•„ë˜ ì´ë¯¸ì§€ì™€ ê°™ì´ ë…¸ë“œ ì»¨í…Œì´ë„ˆ ë‚´ì— ì¿ ë²„ë„¤í‹°ìŠ¤ ì»´í¬ë„ŒíŠ¸ë“¤ì´ ì»¨í…Œì´ë„ˆë¡œ ì˜¬ë¼ì™€ìˆëŠ”ë°, ì´ê±¸ kind ëª…ë ¹ì–´ í•œë°©ìœ¼ë¡œ ë‹¤ í•´ê²° ê°€ëŠ¥í•˜ë‹¤.
- Host(Workstation) = ë²„ì¶”ì–¼ë°•ìŠ¤ì˜ VM
- Node Container = ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ì»¨í…Œì´ë„ˆ

![3-0](/assets/img/kans3-2024/w2/3-0.png)


## multi node cluster(Control-plane, Nodes)

```
# í´ëŸ¬ìŠ¤í„° ìƒì„±ì‹œ ë°˜ì˜ì´ í•„ìš”í•œ portë¶€ë¶„ì„ ì—…ë°ì´íŠ¸í•˜ì—¬ ìƒˆë¡œ ìƒì„±
(âˆ|kind-myk8s:N/A) root@kind:~# cat <<EOT> kind-2node.yaml
# two node (one workers) cluster config
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
    listenAddress: "0.0.0.0" # Optional, defaults to "0.0.0.0"
    protocol: tcp # Optional, defaults to tcp
  - containerPort: 30001
    hostPort: 30001
EOT

(âˆ|kind-myk8s:N/A) root@kind:~# kind create cluster --config kind-2node.yaml --name myk8s
Creating cluster "myk8s" ...
 âœ“ Ensuring node image (kindest/node:v1.31.0) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦ ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
 âœ“ Joining worker nodes ğŸšœ
 ...
 
(âˆ|kind-myk8s:N/A) root@kind:~# kind get clusters
myk8s
(âˆ|kind-myk8s:N/A) root@kind:~# kind get nodes --name myk8s
myk8s-control-plane
myk8s-worker

# ë…¸ë“œ í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get nodes -o wide
NAME                  STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION       CONTAINER-RUNTIME
myk8s-control-plane   Ready    control-plane   3m46s   v1.31.0   172.18.0.2    <none>        Debian GNU/Linux 12 (bookworm)   5.15.0-119-generic   containerd://1.7.18
myk8s-worker          Ready    <none>          3m31s   v1.31.0   172.18.0.3    <none>        Debian GNU/Linux 12 (bookworm)   5.15.0-119-generic   containerd://1.7.18

# ì»¨í…Œì´ë„ˆì¸ ë…¸ë“œ í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                  NAMES
9eeb73110096   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   39 minutes ago   Up 38 minutes   127.0.0.1:33763->6443/tcp              myk8s-control-plane
2ef49f5b3f11   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   39 minutes ago   Up 38 minutes   0.0.0.0:30000-30001->30000-30001/tcp   myk8s-worker

# docker ps ê²°ê³¼ì˜ PORTS ì—ì„œ ë³¸ ê²ƒê³¼ ê°™ì´ host_ip:30000 -> ì›Œì»¤ ë…¸ë“œ ì»¨í…Œì´ë„ˆ:30000ë¡œ í¬íŠ¸í¬ì›Œë”©ëœë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# docker port myk8s-worker
30000/tcp -> 0.0.0.0:30000
30001/tcp -> 0.0.0.0:30001

# 30000 portê°€ ë…¸ë“œ í¬íŠ¸ë¡œ svc ìƒì„±ë˜ëŠ” kube-ops-vie ì„¤ì¹˜
(âˆ|kind-myk8s:N/A) root@kind:~# helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
(âˆ|kind-myk8s:N/A) root@kind:~# helm install kube-ops-view geek-cookbook/kube-ops-view --version 1.2.2 --set service.main.type=NodePort,service.main.ports.http.nodePort=30000 --set env.TZ="Asia/Seoul" --namespace kube-system

```

![4-1](/assets/img/kans3-2024/w2/4-1.png)


## ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ

```
# index.html íŒŒì¼ 
echo "Hello TestPage" > index.html

# Dockerfile íŒŒì¼ 
cat << EOF > Dockerfile
FROM nginx:alpine
COPY index.html /usr/share/nginx/html/
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
EOF

# ì´ë¯¸ì§€ ë¹Œë“œ
(âˆ|kind-myk8s:N/A) root@kind:~# docker build -t nyoung-web:1.0 .
[+] Building 6.1s (7/7) FINISHED
(âˆ|kind-myk8s:N/A) root@kind:~# docker images
REPOSITORY     TAG       IMAGE ID       CREATED          SIZE
nyoung-web     1.0       2ff91a6a9931   29 seconds ago   43.2MB
kindest/node   <none>    b5cb8c3b1441   3 weeks ago      1.03GB

# í˜„ì¬ ì´ë¯¸ì§€ ê²€ìƒ‰ ê²°ê³¼ nyoungì„ ê°€ì§„ ì´ë¯¸ì§€ëŠ” ì—†ìŒ
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-control-plane crictl images | grep nyoung
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-worker crictl images | grep nyoung

# ë„ì»¤ ì´ë¯¸ì§€ë¥¼ kindë¡œ load
(âˆ|kind-myk8s:N/A) root@kind:~# kind load docker-image nyoung-web:1.0 --name myk8s
Image: "nyoung-web:1.0" with ID "sha256:2ff91a6a99314a4d6af2654795f7a9c85f18f6aa562b55927571f011335b0d1e" not yet present on node "myk8s-control-plane", loading...
Image: "nyoung-web:1.0" with ID "sha256:2ff91a6a99314a4d6af2654795f7a9c85f18f6aa562b55927571f011335b0d1e" not yet present on node "myk8s-worker", loading...

# ì¬ê²€ìƒ‰ì‹œ í™•ì¸ ê°€ëŠ¥
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-control-plane crictl images | grep nyoung
docker.io/library/nyoung-web                    1.0                  2ff91a6a99314       44.6MB
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-worker crictl images | grep nyoung
docker.io/library/nyoung-web                    1.0                  2ff91a6a99314       44.6MB

# ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ deployment ìƒì„±
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl create deployment deploy-myweb --image=nyoung-web:1.0
deployment.apps/deploy-myweb created
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get deploy,pod
NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/deploy-myweb   1/1     1            1           8s

NAME                                READY   STATUS    RESTARTS   AGE
pod/deploy-myweb-7648bb6c46-dljxz   1/1     Running   0          8s

# ë…¸ë“œ í¬íŠ¸ë¥¼ ì‚¬ìš©í•œ ì„œë¹„ìŠ¤ ë°°í¬
cat <<EOF | kubectl create -f -
apiVersion: v1
kind: Service
metadata:
  name: deploy-myweb
spec:
  type: NodePort
  ports:
  - name: svc-mywebport
    nodePort: 30001
    port: 80
  selector:
    app: deploy-myweb
EOF

(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get svc,ep deploy-myweb
NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
service/deploy-myweb   NodePort   10.96.18.139   <none>        80:31001/TCP   34s

NAME                     ENDPOINTS       AGE
endpoints/deploy-myweb   10.244.1.3:80   34s

(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get po -owide
NAME                            READY   STATUS    RESTARTS   AGE    IP           NODE           NOMINATED NODE   READINESS GATES
deploy-myweb-7648bb6c46-dljxz   1/1     Running   0          6m1s   10.244.1.3   myk8s-worker   <none>           <none>

# Hostì—ì„œ ì‹¤í–‰
â¯ curl 192.168.50.10:30001
Hello TestPage
```

![5-0](/assets/img/kans3-2024/w2/5-0.png)


## ingress

```
# í´ëŸ¬ìŠ¤í„° ë°°í¬ìš© yaml
cat <<EOT> kind-ingress.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  kubeadmConfigPatches:
  - |
    kind: InitConfiguration
    nodeRegistration:
      kubeletExtraArgs:
        node-labels: "ingress-ready=true"
  extraPortMappings:
  - containerPort: 80
    hostPort: 80
    protocol: TCP
  - containerPort: 443
    hostPort: 443
    protocol: TCP
  - containerPort: 30000
    hostPort: 30000
EOT

(âˆ|N/A:N/A) root@kind:~# kind create cluster --config kind-ingress.yaml --name myk8s
Creating cluster "myk8s" ...
 âœ“ Ensuring node image (kindest/node:v1.31.0) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾


(âˆ|kind-myk8s:N/A) root@kind:~# docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                                                                           NAMES
2dd75c82d061   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   56 seconds ago   Up 52 seconds   0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp, 0.0.0.0:30000->30000/tcp, 127.0.0.1:36839->6443/tcp   myk8s-control-plane

# í´ëŸ¬ìŠ¤í„° ìƒì„±ì‹œ ì‚¬ìš©í•œ yamlì—ì„œ í¬íŠ¸ë§¤í•‘í•œ ê²ƒê³¼ ê°™ì€ ê²ƒì„ í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# docker port myk8s-control-plane
80/tcp -> 0.0.0.0:80
443/tcp -> 0.0.0.0:443
6443/tcp -> 127.0.0.1:36839
30000/tcp -> 0.0.0.0:30000

# í´ëŸ¬ìŠ¤í„° ë°°í¬ ì‹œ ì§€ì •í•œ ingress-ready label í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get nodes myk8s-control-plane -o jsonpath={.metadata.labels.ingress-ready}
true

# ingress controller ì„¤ì¹˜
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml

(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get deploy,svc,ep ingress-nginx-controller -n ingress-nginx -owide
NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES                                                                                                                     SELECTOR
deployment.apps/ingress-nginx-controller   1/1     1            1           83s   controller   registry.k8s.io/ingress-nginx/controller:v1.11.2@sha256:d5f8217feeac4887cb1ed21f27c2674e58be06bd8f5184cacea2a69abaf78dce   app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx

NAME                               TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE   SELECTOR
service/ingress-nginx-controller   NodePort   10.96.114.249   <none>        80:30243/TCP,443:31344/TCP   85s   app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx

NAME                                 ENDPOINTS                      AGE
endpoints/ingress-nginx-controller   10.244.0.7:443,10.244.0.7:80   85s

# ingress controller pod ip
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get po -owide -n ingress-nginx
NAME                                        READY   STATUS      RESTARTS   AGE     IP           NODE                  NOMINATED NODE   READINESS GATES
ingress-nginx-admission-create-fvgjv        0/1     Completed   0          3m43s   10.244.0.5   myk8s-control-plane   <none>           <none>
ingress-nginx-admission-patch-c4rrw         0/1     Completed   0          3m43s   10.244.0.6   myk8s-control-plane   <none>           <none>
ingress-nginx-controller-6b8cfc8d84-d8m6g   1/1     Running     0          3m43s   10.244.0.7   myk8s-control-plane   <none>           <none>

# ì»¨í”„ë¡¤í”Œë ˆì¸ì—ì„œ ingress controller pod ipê°€ ê±¸ë¦° iptables í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-control-plane iptables -t nat -L -n -v | grep '10.244.0.7'
    0     0 DNAT       6    --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:10.244.0.7:80
    0     0 DNAT       6    --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443 to:10.244.0.7:443
```

### í…ŒìŠ¤íŠ¸ ë°°í¬

*ip*

```
# foo, barë¥¼ ë¶„ê¸°ë¡œ ë‚˜ëˆ ì§€ëŠ” ìƒ˜í”Œ
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl apply -f https://kind.sigs.k8s.io/examples/ingress/usage.yaml
pod/foo-app created
service/foo-service created
pod/bar-app created
service/bar-service created
ingress.networking.k8s.io/example-ingress created

(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get ingress,pod -owide
NAME                                        CLASS    HOSTS   ADDRESS     PORTS   AGE
ingress.networking.k8s.io/example-ingress   <none>   *       localhost   80      37s

NAME          READY   STATUS    RESTARTS   AGE   IP           NODE                  NOMINATED NODE   READINESS GATES
pod/bar-app   1/1     Running   0          37s   10.244.0.9   myk8s-control-plane   <none>           <none>
pod/foo-app   1/1     Running   0          37s   10.244.0.8   myk8s-control-plane   <none>           <none>

(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get svc,ep foo-service bar-service
NAME                  TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
service/foo-service   ClusterIP   10.96.179.35   <none>        8080/TCP   41s
service/bar-service   ClusterIP   10.96.50.31    <none>        8080/TCP   41s

NAME                    ENDPOINTS         AGE
endpoints/foo-service   10.244.0.8:8080   41s
endpoints/bar-service   10.244.0.9:8080   41s

# pathì— ë”°ë¼ ê° ì„œë¹„ìŠ¤ê°€ ë§¤í•‘ë¨
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl describe ingress example-ingress
Name:             example-ingress
Labels:           <none>
Namespace:        default
Address:          localhost
Ingress Class:    <none>
Default backend:  <default>
Rules:
  Host        Path  Backends
  ----        ----  --------
  *
              /foo(/|$)(.*)   foo-service:8080 (10.244.0.8:8080)
              /bar(/|$)(.*)   bar-service:8080 (10.244.0.9:8080)
Annotations:  nginx.ingress.kubernetes.io/rewrite-target: /$2
Events:
  Type    Reason  Age                From                      Message
  ----    ------  ----               ----                      -------
  Normal  Sync    24s (x2 over 46s)  nginx-ingress-controller  Scheduled for sync
  
  
# í„°ë¯¸ë„1ì—ì„œ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ì„ ì¼œë‘ê³ 
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl logs -n ingress-nginx deploy/ingress-nginx-controller -f
...
192.168.50.1 - - [07/Sep/2024:20:56:15 +0000] "GET /foo/hostname HTTP/1.1" 200 7 "-" "curl/8.4.0" 88 0.003 [default-foo-service-8080] [] 10.244.0.8:8080 7 0.002 200 7d3935849d0f386b3adfb37f74a60ae2
192.168.50.1 - - [07/Sep/2024:20:56:25 +0000] "GET /bar/hostname HTTP/1.1" 200 7 "-" "curl/8.4.0" 88 0.002 [default-bar-service-8080] [] 10.244.0.9:8080 7 0.002 200 61ae6d42666949f4f73b0c846cc3410f

# í„°ë¯¸ë„2ì—ì„œ ì•„ë˜ì™€ ê°™ì´ ìˆ˜í–‰
â¯ curl 192.168.50.10/foo/hostname
foo-app%                                                                                                                                    05:56:15
â¯ curl 192.168.50.10/bar/hostname
bar-app%
```

*domain*

hostì—ì„œ ë„ë©”ì¸ì„ ì•Œì•„ì•¼í•˜ê¸° ë•Œë¬¸ì— ë¨¼ì € /etc/hosts íŒŒì¼ì„ ìˆ˜ì •í–ˆë‹¤.
enp0s8 ip domain ì„ ë§¤í•‘í•˜ì—¬ ì‘ì„±

![5-1](/assets/img/kans3-2024/w2/5-1.png)

```
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get ingress example-ingress -o yaml > ingress.yaml
(âˆ|kind-myk8s:N/A) root@kind:~# vi ingress.yaml
...
spec:
  rules:
    - host: nyoung.com
      http:
        paths:
        - path: /foo
          backend:
            serviceName: foo-service
            servicePort: 8080
        - path: /bar
          backend:
            serviceName: bar-service
            servicePort: 8080
...

# í˜¸ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰     
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl apply -f ingress.yaml
â¯ curl nyoung.com/foo/hostname
foo-app%
                                                                                                                      
â¯ curl nyoung.com/bar/hostname
bar-app%
```

---
ì°¸ê³ 
- [https://www.virtualbox.org/manual/ch06.html#network_internal](https://www.virtualbox.org/manual/ch06.html#network_internal)
- [https://owner0220.github.io/product/2021/04/15/Virtualbox_NETWORK/](https://owner0220.github.io/product/2021/04/15/Virtualbox_NETWORK/)
- [https://mya.sh/blog/2020/10/21/local-ingress-domains-kind/](https://mya.sh/blog/2020/10/21/local-ingress-domains-kind/)
