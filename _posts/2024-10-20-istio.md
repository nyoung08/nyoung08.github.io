---
layout: post
title: kans3) istio egressgw ì‹¤íŒ¨ê¸°..
category: 
  - study
tags:
  - study
---


# service mesh

ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ê°€ ë‚˜ì˜¤ë©´ì„œ ë‚´ë¶€ ê°„ì˜ íŠ¸ë˜í”½ ê´€ë¦¬ë‚˜ ë³´ì•ˆì„±ì„ ê°•í™”í•˜ê¸° ìœ„í•´ ì„œë¹„ìŠ¤ë©”ì‹œê°€ ë“±ì¥í•˜ê²Œë˜ì—ˆë‹¤. [ğŸ”—](https://www.samsungsds.com/kr/insights/service_mesh.html) ê·¸ ì¤‘ í•˜ë‚˜ì¸ istioì— ëŒ€í•´ ê³µë¶€í–ˆë‹¤. ì–´í”Œë¦¬ì¼€ì´ì…˜ ê°„ì˜ íŠ¸ë˜í”½ì„ ì œì–´í•˜ë ¤ê³  ê° íŒŒë“œì— ì‚¬ì´ë“œì¹´ë¡œ proxyê°€ í•¨ê»˜ ë– ìˆë‹¤. íŒŒë“œì— ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ì´ proxyê°€ ê°€ë¡œì±„ê³  ê´€ë¦¬í•˜ëŠ” ê²ƒì´ë‹¤. ì´ê±¸ í•˜ê¸° ìœ„í•´ì„œ íŒŒë“œ ì•ˆì— iptablesë¥¼ ì“°ê²Œë˜ëŠ”ë°.. í•œë²ˆ ë“¤ì–´ì˜¤ëŠ” íŒ¨í‚·ì€ ì •ì‹ ì—†ê²Œ Iptablesë¥¼ íƒ€ê³  ë‚˜ê°€ê²Œë˜ëŠ”ê±°ë‹¤..

![1-0](/assets/img/kans3-2024/w7/1-0.jpg)
ì´ë¯¸ì§€ ì¶œì²˜ [ğŸ”—](https://linkerd.io/)


# envoy

istioì—ì„œ í”„ë¡ì‹œë¡œ ì‚¬ìš©ë˜ëŠ” Envoy proxyëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ê°„ ë„¤íŠ¸ì›Œí¬ê°€ íˆ¬ëª…í•˜ê²Œ ë³´ì—¬ì•¼ í•˜ê³ , ë¬¸ì œê°€ ìƒê¸°ë©´ ê·¸ ì›ì¸ì„ ì‰½ê²Œ íŒŒì•…í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤ëŠ” ì² í•™ì—ì„œ ì‹œì‘ë˜ì—ˆë‹¤ê³  ë¬¸ì„œì— ë‚˜ì™€ìˆë‹¤. [ğŸ”—](https://www.envoyproxy.io/docs/envoy/latest/intro/what_is_envoy)

## êµ¬ì„±ìš”ì†Œ

![2-0](/assets/img/kans3-2024/w7/2-0.svg)

- upstream: envoyê°€ ìš”ì²­ì„ ì „ë‹¬í•˜ëŠ” ì„œë²„ ë˜ëŠ” ì„œë¹„ìŠ¤
- downstream: envoyì— ì—°ê²°í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜
- listener: íŠ¹ì • IPì™€ í¬íŠ¸ì—ì„œ ìš”ì²­ì„ ë°›ì•„ë“¤ì´ëŠ” ì—­í• 
- filter: listenerì™€ cluster ì—°ê²°, ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” íŒŒì´í”„ë¼ì¸ ëª¨ë“ˆ
- cluster: endpointë“¤ì˜ ì§‘í•©ìœ¼ë¡œ, envoyê°€ ìš”ì²­ í•  ìˆ˜ ìˆëŠ” ë…¼ë¦¬ì  ì„œë¹„ìŠ¤
- endpoint: ì‹¤ì œ ì ‘ê·¼ ê°€ëŠ¥í•œ endpoint ip. ë„¤íŠ¸ì›Œí¬ ë…¸ë“œ

ê·¸ë¦¼ì—ì„œ ë³´ë©´ ì™¼ìª½ì—ì„œ listenerë¡œ ë“¤ì–´ì™€ì„œ ì •ì˜ëœ ë„¤íŠ¸ì›Œí¬ í•„í„°ì— ì˜í•´ í´ëŸ¬ìŠ¤í„°ë¡œ ì „ë‹¬ë˜ê³ , í´ëŸ¬ìŠ¤í„°ëŠ” ë¡œë“œë°¸ëŸ°ì‹±ìœ¼ë¡œ ì•Œë§ì€ ì—”ë“œí¬ì¸ë“œë¡œ íŠ¸ë˜í”½ì„ ì „ë‹¬í•˜ê²Œ ëœë‹¤.


# istio

envoy proxyì—ì„œ ëª¨ë“  ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ê°€ë¡œì±„ì„œ Istioì—ì„œ ì„¤ì •í•œ êµ¬ì„±ì— ë”°ë¼ íŒ¨í‚·ì´ ì „ë‹¬ ë  ìˆ˜ ìˆë„ë¡ í•œë‹¤. êµ¬ì„±ì„ í¬ê²Œ ì‚´í´ë³´ë©´, controlplaneì—ì„œ í”„ë¡ì‹œë¥¼ êµ¬ì„±í•˜ê³ , dataplaneì—ëŠ” ì‹¤ì œ ë™ì‘ í•˜ëŠ” ë¶€ë¶„ìœ¼ë¡œ ì‚¬ì´ë“œì¹´ë¡œ ë°°í¬ë˜ì–´ìˆëŠ” envoy proxyê°€ ìˆë‹¤.

## êµ¬ì„±ìš”ì†Œ

![3-1](/assets/img/kans3-2024/w7/3-1.jpeg)

controlplaneì— ìˆëŠ” istod ë°ëª¬ íŒŒë“œ í•˜ë‚˜ì— ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ê°€ ë– ìˆë‹¤. 
- galley: êµ¬ì„± ê´€ë¦¬, ìˆ˜ì§‘, ë°°í¬ë¥¼ ë‹´ë‹¹. í´ëŸ¬ìŠ¤í„° ë‚´ì˜ ì •ë³´ë¥¼ ìˆ˜ì§‘í•œ ê²ƒì„ pilotì— ì „ë‹¬í•œë‹¤.
- pilot: ê° ì„œë¹„ìŠ¤ì— ëŒ€í•œ ë¼ìš°íŒ… ê·œì¹™ì„ ì„¤ì •í•˜ê³ , ì´ë¥¼ proxyì—ê²Œ ë°°í¬í•œë‹¤.
- citadel: ë³´ì•ˆ ê´€ë ¨ ìš”ì†Œë¡œ, ì—°ê²° ì‹œ mTLSë¥¼ ì‚¬ìš©í•˜ì—¬ ì•”í˜¸í™”, ì¸ì¦ì„œ ê´€ë¦¬ ë“±ì„ í•œë‹¤.


## ì‹¤ìŠµí™˜ê²½

```
# ìŠ¤í„°ë””ì—ì„œ ì œê³µí•´ì£¼ëŠ” ìŠ¤íƒíŒŒì¼ë¡œ ì˜¬ë ¸ë‹¤.
â¯ curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/kans/kans-7w.yaml
â¯ aws cloudformation deploy --template-file kans-7w.yaml --stack-name mylab --parameter-overrides KeyName=nyoung SgIngressSshCidr=$(curl -s ipinfo.io/ip)/32 --region ap-northeast-2

â¯ aws ec2 describe-instances --query "Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,InstanceName:Tags[?Key=='Name']|[0].Value,Status:State.Name}" --filters Name=instance-state-name,Values=running --output text
testpc     13.125.214.128  running
k3s-s   54.180.162.246  running
k3s-w2  3.38.104.74     running
k3s-w1  3.35.53.185     running

â¯ ssh -i ./nyoung.pem ubuntu@54.180.162.246 

(âˆ|default:N/A) root@k3s-s:~# k get no
NAME     STATUS   ROLES                  AGE     VERSION
k3s-s    Ready    control-plane,master   3h10m   v1.30.5+k3s1
k3s-w1   Ready    <none>                 3h10m   v1.30.5+k3s1
k3s-w2   Ready    <none>                 3h10m   v1.30.5+k3s1
```


### istio ì„¤ì¹˜

istio ì„¤ì¹˜í•  ë•Œ, profileì„ ì„ íƒí•´ì„œ ì„¤ì¹˜ í•  ìˆ˜ê°€ ìˆë‹¤. ì–´ë–¤ êµ¬ì„±ìš”ì†Œë¥´ ì„¤ì¹˜í• ê±´ì§€ì—ë”°ë¼ ì„ íƒí•  ìˆ˜ ìˆë‹¤. ì•„ë˜ ì‹¤ìŠµì—ì„œëŠ” demo profileì„ ì„ íƒí•´ì„œ ì„¤ì¹˜í–ˆë‹¤. [ğŸ”—](https://istio.io/latest/docs/setup/additional-setup/config-profiles/)

```
# istioctl ì„¤ì¹˜
(âˆ|default:N/A) root@k3s-s:~# export ISTIOV=1.23.2
(âˆ|default:N/A) root@k3s-s:~# echo "export ISTIOV=1.23.2" >> /etc/profile
(âˆ|default:N/A) root@k3s-s:~# curl -s -L https://istio.io/downloadIstio | ISTIO_VERSION=$ISTIOV TARGET_ARCH=x86_64 sh -
(âˆ|default:N/A) root@k3s-s:~# tree istio-$ISTIOV -L 2 
(âˆ|default:N/A) root@k3s-s:~# cp istio-$ISTIOV/bin/istioctl /usr/local/bin/istioctl
(âˆ|default:N/A) root@k3s-s:~# istioctl version --remote=false

(âˆ|default:N/A) root@k3s-s:~# istioctl profile dump --config-path components.ingressGateways
- enabled: true
  name: istio-ingressgateway
(âˆ|default:N/A) root@k3s-s:~# istioctl profile dump --config-path values.gateways.istio-ingressgateway
{}

(âˆ|default:N/A) root@k3s-s:~# istioctl profile dump demo
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  components:
    base:
      enabled: true
    # egressgatewayì™€ ingressgateway í™œì„±í™”
    egressGateways:
    - enabled: true
      name: istio-egressgateway
    ingressGateways:
    - enabled: true
      name: istio-ingressgateway
    pilot:
      enabled: true
  hub: docker.io/istio
  profile: demo
  tag: 1.23.2
  values:
    defaultRevision: ""
    gateways:
      istio-egressgateway: {}
      istio-ingressgateway: {}
    global:
      configValidation: true
      istioNamespace: istio-system
    profile: demo
       
(âˆ|default:N/A) root@k3s-s:~# istioctl profile dump demo > demo-profile.yaml
(âˆ|default:N/A) root@k3s-s:~# istioctl install -f demo-profile.yaml -y
        |\
        | \
        |  \
        |   \
      /||    \
     / ||     \
    /  ||      \
   /   ||       \
  /    ||        \
 /     ||         \
/______||__________\
____________________
  \__       _____/
     \_____/

âœ” Istio core installed â›µï¸
âœ” Istiod installed ğŸ§ 
...

# ê¸°ë³¸ìœ¼ë¡œ ìƒì„±ë˜ì–´ìˆëŠ” pod,svc
(âˆ|default:N/A) root@k3s-s:~# k get all -n istio-system
NAME                                        READY   STATUS    RESTARTS   AGE
pod/istio-egressgateway-57b6df4bcd-lpsdv    1/1     Running   0          72s
pod/istio-ingressgateway-5f9f654d46-pswq8   1/1     Running   0          72s
pod/istiod-7f8b586864-zrhkw                 1/1     Running   0          80s

NAME                           TYPE           CLUSTER-IP      EXTERNAL-IP                                   PORT(S)                                                                      AGE
service/istio-egressgateway    ClusterIP      10.10.200.109   <none>                                        80/TCP,443/TCP                                                               72s
service/istio-ingressgateway   LoadBalancer   10.10.200.31    192.168.10.10,192.168.10.101,192.168.10.102   15021:31535/TCP,80:30465/TCP,443:31462/TCP,31400:31633/TCP,15443:30813/TCP   72s
service/istiod                 ClusterIP      10.10.200.121   <none>                                        15010/TCP,15012/TCP,443/TCP,15014/TCP                                        80s

NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/istio-egressgateway    1/1     1            1           72s
deployment.apps/istio-ingressgateway   1/1     1            1           72s
deployment.apps/istiod                 1/1     1            1           80s

NAME                                              DESIRED   CURRENT   READY   AGE
replicaset.apps/istio-egressgateway-57b6df4bcd    1         1         1       72s
replicaset.apps/istio-ingressgateway-5f9f654d46   1         1         1       72s
replicaset.apps/istiod-7f8b586864                 1         1         1       80s


# ëˆˆìœ¼ë¡œ ë³´ê¸° ì¢‹ê²Œ kialië¥¼ ì„¤ì¹˜
(âˆ|default:N/A) root@k3s-s:~# kubectl apply -f ~/istio-1.23.2/samples/addons 
(âˆ|default:N/A) root@k3s-s:~# kubectl rollout status deployment/kiali -n istio-system
(âˆ|default:N/A) root@k3s-s:~# kubectl patch svc -n istio-system kiali -p '{"spec":{"type":"NodePort"}}'

(âˆ|default:N/A) root@k3s-s:~# KIALINodePort=$(kubectl get svc -n istio-system kiali -o jsonpath={.spec.ports[0].nodePort})
(âˆ|default:N/A) root@k3s-s:~# echo -e "KIALI UI URL = http://$(curl -s ipinfo.io/ip):$KIALINodePort"
KIALI UI URL = http://54.180.162.246:31034
```

ì›¹ì½˜ì†”ì— ë“¤ì–´ê°€ì„œ íŠ¸ë˜í”½ ê·¸ë˜í”„ì— ê°€ë©´, ì•„ë¬´ëŸ° í†µì‹ ì´ ì—†ì—ˆê¸° ë•Œë¬¸ì— ë¹ˆí˜ì´ì§€ë¥¼ í™•ì¼ í•  ìˆ˜ ìˆìŒ

```
# envoy containerê°€ ìƒì„±ë  ìˆ˜ ìˆê²Œ namespaceì— ë¼ë²¨ì„ ë‹¬ì•„ì¤¬ë‹¤.
(âˆ|default:N/A) root@k3s-s:~# kubectl label namespace default istio-injection=enabled
namespace/default labeled
(âˆ|default:N/A) root@k3s-s:~# kubectl get ns -L istio-injection
NAME              STATUS   AGE     ISTIO-INJECTION
default           Active   3h51m   enabled
istio-system      Active   8m38s
kube-node-lease   Active   3h51m
kube-public       Active   3h51m
kube-system       Active   3h51m


# netshootì´ë¯¸ì§€ë¡œ ë§Œë“  í…ŒìŠ¤íŠ¸ íŒŒë“œë¥¼ ë³´ë©´, 2/2ë¡œ ì»¨í…Œì´ë„ˆê°€ ë‘ê°œì¸ ê²ƒìœ¼ë¡œ í™•ì¸
(âˆ|default:N/A) root@k3s-s:~# k describe pod pod1
...
# init containerê°€ ëœ¨ë©´ì„œ iptablesë¥¼ ì„¤ì •
Init Containers:
  istio-init:
    ...
    Image:         docker.io/istio/proxyv2:1.23.2
    Args:
      istio-iptables
      -p
      15001
      -z
      15006
      -u
      1337
      -m
      REDIRECT
      -i
      *
      -x

      -b
      *
      -d
      15090,15021,15020
      --log_output_level=default:info
Containers:
# ìƒì„± ì‹œ, ì§€ì •í–ˆë˜ ì´ë¯¸ì§€
  pod1:
    Image:         nicolaka/netshoot
    ... 
# envoy proxyê°€ ì˜¬ë¼ì˜¤ëŠ” ì‚¬ì´ë“œì¹´ ì»¨í…Œì´ë„ˆ
  istio-proxy:
    Image:         docker.io/istio/proxyv2:1.23.2
    Args:
      proxy
      sidecar
      --domain
      $(POD_NAMESPACE).svc.cluster.local
      --proxyLogLevel=warning
      --proxyComponentLogLevel=misc:error
      --log_output_level=default:info
# íŒŒë“œ ì´ë²¤íŠ¸ ë³´ë©´, init container > nginx container > istio-proxy container ìˆœìœ¼ë¡œ ì˜¬ë¼ì™”ë‹¤.    
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  60s   default-scheduler  Successfully assigned default/deploy-websrv-7cdd458999-pxgll to k3s-w1
  Normal  Pulled     60s   kubelet            Container image "docker.io/istio/proxyv2:1.23.2" already present on machine
  Normal  Created    60s   kubelet            Created container istio-init
  Normal  Started    60s   kubelet            Started container istio-init
  Normal  Pulling    59s   kubelet            Pulling image "nicolaka/netshoot"
  Normal  Pulled     55s   kubelet            Successfully pulled image "nicolaka/netshoot" in 4.921s (4.921s including waiting). Image size: 20506631 bytes.
  Normal  Created    55s   kubelet            Created container pod1
  Normal  Started    54s   kubelet            Started container pod1
  Normal  Pulled     54s   kubelet            Container image "docker.io/istio/proxyv2:1.23.2" already present on machine
  Normal  Created    54s   kubelet            Created container istio-proxy
  Normal  Started    54s   kubelet            Started container istio-proxy   

# nodeê°€ public ipë¥¼ ê°€ì§€ê³  ìˆê¸° ë–„ë¬¸ì—, ì™¸ë¶€ í˜¸ì¶œì€ ì˜ëœë‹¤.  
(âˆ|default:N/A) root@k3s-s:~# k exec pod1 -it -- curl ifconfig.me
54.180.162.246   
```


### egress gateway

ì•„ë˜ì²˜ëŸ¼ í–ˆëŠ”ë°.. ì˜ì•ˆë˜ì—ˆë‹¤. ì°¸ê³ í•œ ë¬¸ì„œ [ğŸ”—](https://istio.io/latest/blog/2023/egress-sni/)
ìƒì„±ì€ gateway > virtual service > destinationRule > service > deploy ì´ë ‡ê²Œ ì´ì–´ì§€ê²Œ ì‘ì„±í–ˆë‹¤ê³  í–ˆëŠ”ë°.. 

```
(âˆ|default:N/A) root@k3s-s:~# k apply -f egress.yaml

(âˆ|default:N/A) root@k3s-s:~# cat egress.yaml
---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: egressgateway
  namespace: istio-system
spec:
  selector:
    istio: egressgateway  
  servers:
  - port:
      number: 443
      name: tls
      protocol: TLS
    hosts:
    - "*.wikipedia.org"
    tls:
      mode: PASSTHROUGH  
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: eg1
  namespace: istio-system
spec:
  hosts:
  - "*.wikipedia.org"
  gateways:
  - mesh
  - egressgateway
  tls:
  - match:
    - gateways:
      - mesh
      port: 443
      sniHosts:
      - "*.wikipedia.org"
    route:
    - destination:
        host: istio-egressgateway.istio-system.svc.cluster.local
        subset: wildcard  
      weight: 100
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: egressgateway
  namespace: istio-system
spec:
  host: istio-egressgateway.istio-system.svc.cluster.local
  subsets:
  - name: wildcard
    labels:
      version: v1
---
apiVersion: v1
kind: Service
metadata:
  name: istio-egressgateway
  namespace: istio-system
  labels:
    istio: egressgateway
spec:
  ports:
  - name: https
    protocol: TCP
    port: 443
    targetPort: 443
  selector:
    istio: egressgateway
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: istio-egressgateway
  namespace: istio-system
  labels:
    istio: egressgateway
spec:
  replicas: 1
  selector:
    matchLabels:
      istio: egressgateway
  template:
    metadata:
      labels:
        istio: egressgateway
    spec:
      containers:
      - name: istio-proxy
        image: docker.io/istio/proxyv2:1.23.2  
        ports:
        - containerPort: 443
        args:
        - proxy
        - router
        - --domain
        - $(POD_NAMESPACE).svc.cluster.local
        env:
        - name: JWT_POLICY
          value: first-party-jwt
        - name: PILOT_CERT_PROVIDER
          value: istiod
        - name: CA_ADDR
          value: istiod.istio-system.svc:15012
        resources:
          limits:
            cpu: 2000m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 128Mi
        volumeMounts:
        - name: istio-certs
          mountPath: /etc/certs
      volumes:
      - name: istio-certs
        emptyDir: {}


(âˆ|default:N/A) root@k3s-s:~# kubectl label pods pod1 version=v1
(âˆ|default:N/A) root@k3s-s:~# k exec pod1 -it -- curl -s https://en.wikipedia.org/wiki/Main_Page | grep -o "<title>.*</title>"
<title>Wikipedia, the free encyclopedia</title>
```

![4-1](/assets/img/kans3-2024/w7/4-1.png)
![4-2](/assets/img/kans3-2024/w7/4-2.png)

istio configìª½ì— ê°€ë©´ ë¬¸ë²•ì˜¤ë¥˜ ë‚œê±°ë¥¼ ë³¼ ìˆ˜ê°€ ìˆëŠ”ë°, dr yamlì˜ spec.hostë¶€ë¶„ì—ì„œ ìê¾¸ ì˜¤ë¥˜ê°€ ë‚œë‹¤.. ìœ„ì—ì²˜ëŸ¼í•˜ë©´ ë§¤ì¹­ë˜ëŠ”ê²Œ ì—†ë‹¤ê³  ì˜¤ë¥˜ë‚˜ì„œ drì—ì„œ host ì •ë³´ë¥¼ ë‹¤ë¥¸ê±¸ë¡œ ë°”ê¿”ë³´ë©´ drì´ë‘ vgì—ì„œ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ì„œë¹„ìŠ¤ëŠ” íŠ¸ë˜í”½ì„ ì „ì†¡ ëª»í•œë‹¤ ê·¸ëŸ° ì˜¤ë¥˜ê°€ ë‚˜ê²Œëœë‹¤. ì´ì œ ì—¬ê¸°ì„œ ë˜ svcëª…ì„ ë§ì¶°ì„œ ë³€ê²½í•˜ë‹¤ë³´ë©´ gatewayì—ì„œ subsetì„ ì°¾ì„ ìˆ˜ ì—†ë‹¤ê³  ì˜¤ë¥˜ê°€ ë‚œë‹¤.. ì´ê±¸ ë˜ ë°”ê¾¸ë©´ ë‹¤ì‹œ drì˜¤ë¥˜ê°€ ë‚˜ë©´ì„œ ëŒê³  ëˆë‹¤. 

