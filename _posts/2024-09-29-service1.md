---
layout: post
title: KANS3) Service 1
category:
  - study
  - gcp
tags:
  - study
  - gcp
---

ì´ë²ˆ ì£¼ì°¨ëŠ” ì„œë¹„ìŠ¤ê°€ ì–´ë–»ê²Œ íŒŒë“œë¡œ íŒ¨í‚·ì„ ì „ë‹¬í•˜ëŠ”ì§€ì™€ ì„œë¹„ìŠ¤ ì¢…ë¥˜ì— ëŒ€í•´ ì•Œì•„ë³´ëŠ” ì£¼ì°¨ì˜€ë‹¤.
í…ŒìŠ¤íŠ¸ í™˜ê²½ì€ ê°€ì‹œë‹¤ë‹˜ì´ ì œê³µì£¼ì‹  vagrant fileì„ ì‚¬ìš©í•˜ì—¬ ê°€ìƒë¨¸ì‹  ì˜¬ë ¤ì„œ ì‚¬ìš©í–ˆë‹¤.


# í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •

```
curl -O https://raw.githubusercontent.com/gasida/KANS/main/kind/Vagrantfile
curl -O https://raw.githubusercontent.com/gasida/KANS/main/kind/init_cfg.sh

â¯ vagrant up

â¯ vagrant status
Current machine states:

default                   running (virtualbox)
...
â¯ vagrant ssh

# kind cnië¥¼ ì‚¬ìš©í•˜ëŠ” clusterë¥¼ ë°°í¬
root@kind:~# cat <<EOT> kind-svc-1w.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
featureGates:
  "InPlacePodVerticalScaling": true
  "MultiCIDRServiceAllocator": true
nodes:
- role: control-plane
  labels:
    mynode: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  kubeadmConfigPatches:
  - |
    kind: ClusterConfiguration
    apiServer:
      extraArgs:
        runtime-config: api/all=true
- role: worker
  labels:
EOTerviceSubnet: 10.200.1.0/24

root@kind:~# kind create cluster --config kind-svc-1w.yaml --name myk8s --image kindest/node:v1.31.0
Creating cluster "myk8s" ...
...

# docker psë¡œ ë…¸ë“œ í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                                             NAMES
ec7adbe5350c   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   31 minutes ago   Up 31 minutes                                                                     myk8s-worker
f15642db9183   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   31 minutes ago   Up 31 minutes   0.0.0.0:30000-30002->30000-30002/tcp, 127.0.0.1:42371->6443/tcp   myk8s-control-plane
9418511b3e6f   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   31 minutes ago   Up 31 minutes                                                                     myk8s-worker2
5d730ae049de   kindest/node:v1.31.0   "/usr/local/bin/entrâ€¦"   31 minutes ago   Up 31 minutes   

# ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì™€ ì›Œì»¤ë…¸ë“œì— í•„ìš”í•œ íˆ´ë“¤ ì„¤ì¹˜
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-control-plane sh -c 'apt update && apt install tree psmisc lsof wget bsdmainutils bridge-utils net-tools ipset ipvsadm nfacct tcpdump ngrep iputils-ping arping git vim arp-scan -y'
(âˆ|kind-myk8s:N/A) root@kind:~# for i in worker worker2 worker3; do echo ">> node myk8s-$i <<"; docker exec -it myk8s-$i sh -c 'apt update && apt install tree psmisc lsof wget bsdmainutils bridge-utils net-tools ipset ipvsadm nfacct tcpdump ngrep iputils-ping arping -y'; echo; done

# ë…¸ë“œì— ë¶™ì€ ë¼ë²¨ í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get nodes -o jsonpath="{.items[*].metadata.labels}" | jq | grep mynode
  "mynode": "control-plane",
  "mynode": "worker1"
  "mynode": "worker2"
  "mynode": "worker3"

# ë…¸ë“œ ì»¨í…Œì´ë„ˆ ëŒ€ì—­ëŒ€ í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# docker ps -q | xargs docker inspect --format '{{.Name}} {{.NetworkSettings.Networks.kind.IPAddress}}'
/myk8s-worker 172.18.0.2
/myk8s-control-plane 172.18.0.5
/myk8s-worker2 172.18.0.4
/myk8s-worker3 172.18.0.3

# íŒŒë“œì™€ Service ëŒ€ì—­ í™•ì¸ 
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get cm -n kube-system kubeadm-config -oyaml | grep -i subnet
      podSubnet: 10.10.0.0/16
      serviceSubnet: 10.200.1.0/24
      
# ë…¸ë“œë§ˆë‹¤ í• ë‹¹ëœ íŒŒë“œ ê³ ì • ëŒ€ì—­ëŒ€ í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get nodes -o custom-columns='NODE_NAME:.metadata.name,POD_CIDR:.spec.podCIDR'
NODE_NAME             POD_CIDR
myk8s-control-plane   10.10.0.0/24
myk8s-worker          10.10.1.0/24
myk8s-worker2         10.10.2.0/24
myk8s-worker3         10.10.3.0/24
```


# kindnet [ğŸ”—](https://www.tkng.io/cni/kindnet/)

```
# kind networkë¥¼ ì‚¬ìš©
(âˆ|kind-myk8s:N/A) root@kind:~# docker network ls
NETWORK ID     NAME      DRIVER    SCOPE
a7cb493939e6   bridge    bridge    local
bd171c4c05b9   host      host      local
b2152e16fdcb   kind      bridge    local
32658cbe2101   none      null      local

# ë§¨ ë§ˆì§€ë§‰ ì´ë¦„(=kind network id)
(âˆ|kind-myk8s:N/A) root@kind:~# ip -br -4 addr show
lo               UNKNOWN        127.0.0.1/8
enp0s3           UP             10.0.2.15/24 metric 100
enp0s8           UP             192.168.50.10/24
docker0          DOWN           172.17.0.1/16
br-b2152e16fdcb  UP             172.18.0.1/16


# controlplaneì— ë“¤ì–´ê°€ì„œ í™•ì¸í•´ë³´ì•˜ë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-control-plane bash

# ëª¨ë“  vethì¸í„°í˜ì´ìŠ¤ë“¤ì´ ë™ì¼í•œ IP ì£¼ì†Œë¥¼ ê°–ëŠ”ë‹¤.
# ê° íŒŒë“œë“¤ì´ ê¸°ë³¸ gwì—­í• ì„ í•´ì„œ bridgeë¥¼ í†µí•´ í†µì‹  í•˜ëŠ” ê²ƒì´ ì•„ë‹˜
root@myk8s-control-plane:/# ip -br -4 addr show
lo               UNKNOWN        127.0.0.1/8
vethe37588be@if2 UP             10.10.0.1/32
vethb19fa5cc@if2 UP             10.10.0.1/32
vethcbf739f8@if2 UP             10.10.0.1/32
veth5011a3b2@if2 UP             10.10.0.1/32
eth0@if13        UP             172.18.0.5/16

    
# type: ptp = point to point ë¡œ ë‘ ì—”íŠ¸í¬ì¸íŠ¸ê°„ì˜ ì§ì ‘ì ì¸ ì—°ê²°ì„ ì˜ë¯¸í•œë‹¤. 
# ë„¤íŠ¸ì›Œí¬ ë ˆì´ì–´ì—ì„œ ip ì£¼ì†Œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© í•˜ëŠ” ê²ƒ
root@myk8s-control-plane:/# cat /etc/cni/net.d/10-kindnet.conflist
{
	"cniVersion": "0.3.1",
	"name": "kindnet",
	"plugins": [
	{
		"type": "ptp",
		"ipMasq": false,
		"ipam": {
			"type": "host-local",
	...
```

í…ŒìŠ¤íŠ¸ íŒŒë“œë¥¼ ë„ì›Œì„œ í™•ì¸í•´ë³´ì•˜ë‹¤.

```
(âˆ|kind-myk8s:N/A) root@kind:~# cat test.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod1
spec:
  containers:
  - name: pod1
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: pod2
spec:
  containers:
  - name: pod2
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
  
  
(âˆ|kind-myk8s:N/A) root@kind:~# k apply -f test.yaml
pod/pod1 created
pod/pod2 created

(âˆ|kind-myk8s:N/A) root@kind:~# k get po -owide
pod2   1/1     Running             0          103s   10.10.1.2   myk8s-worker    <none>           <none>
pod1   1/1     Running             0          103s   10.10.2.3   myk8s-worker2   <none>           <none>


# pod1ì—ì„œ pod2ë¡œ ê°€ëŠ” ê¸¸ì„ í™•ì¸í•´ë³´ë©´,
# pod1ì—ì„œ Pod2ë¡œ ê°€ê¸° ìœ„í•´ eht0ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ 10.10.2.1ì— íŒ¨í‚·ì„ ì „ì†¡í•˜ê²Œ ëœë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl exec -it pod1 -- ip route get 10.10.1.2
10.10.1.2 via 10.10.2.1 dev eth0 src 10.10.2.3 uid 0

# 10.10.2.1ì€ pod1ì´ ìˆëŠ” worker2 nodeì—ì„œì˜ ê°€ìƒì¸í„°í˜ì´ìŠ¤
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-worker2 ip -br -4 add show
lo               UNKNOWN        127.0.0.1/8
veth9fddd097@if2 UP             10.10.2.1/32
eth0@if11        UP             172.18.0.4/16

# worker2 nodeì—ì„œ pod2 ê²½ë¡œë¥¼ í™”ì¸í•´ë³´ë©´,
# eth0í„°ë„ì„ í†µí•´ 172.18.0.2ë¡œ ì „ë‹¬ëœë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-worker2 ip route get 10.10.1.2
10.10.1.2 via 172.18.0.2 dev eth0 src 172.18.0.4 uid 0
    
# 172.18.0.2ëŠ” pod2ê°€ ìœ„ì¹˜í•œ myk8s-worker node
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-worker ip -br -4 add show
lo               UNKNOWN        127.0.0.1/8
veth1af37920@if2 UP             10.10.1.1/32
eth0@if7         UP             172.18.0.2/16

# í•´ë‹¹ ë…¸ë“œì—ì„œ pod2ì˜ ê²½ë¡œë¥¼ í™•ì¸í•´ë³´ë©´, pod2ì— ì—°ê²°ëœ ê°€ìƒì¸í„°í˜ì´ìŠ¤ë¡œ ì—°ê²°ëœë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-worker ip route get 10.10.1.2
10.10.1.2 dev veth1af37920 src 10.10.1.1 uid 0
```

ìœ„ì™€ ê°™ì´ ë³´ë©´ ë¸Œë¦¿ì§€ë¥¼ ì‚¬ìš©í•œ ì˜¤ë²„ë ˆì´ ë„¤íŠ¸ì›Œí¬ì²˜ëŸ¼ ë³´ì¼ ìˆ˜ ìˆì§€ë§Œ, ì‹¤ì œ í†µì‹ ì€ l3 ë¼ìš°íŒ…ì„ í†µí•´ ì´ë¤„ì§€ê¸° ë•Œë¬¸ì— pod ipê°€ ë³€ê²½ë˜ì§€ ì•Šê³  ì „ë‹¬ëœë‹¤.

```
# pod1 > pod2
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl exec -it pod1 -- /bin/sh
~ # ping -c 3 10.10.1.2

# pod2ì—ì„œ tcpdumpë¡œ í™•ì¸í•´ë³´ë©´, pod1ì˜ client ipë¥¼ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl exec -it pod2 -- /bin/sh
~ # tcpdump
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
18:58:36.180460 ARP, Request who-has pod2 tell 10.10.1.1, length 28
18:58:36.180469 ARP, Reply pod2 is-at 36:56:b7:dc:58:9d (oui Unknown), length 28
18:58:36.180471 IP 10.10.2.3 > pod2: ICMP echo request, id 57, seq 1, length 64
18:58:36.181208 IP pod2 > 10.10.2.3: ICMP echo reply, id 57, seq 1, length 64
...
```

# Service

podëŠ” ìƒì„±ë˜ì—ˆë‹¤ ì£½ì—ˆë‹¤ í•˜ë‹¤ë³´ë‹ˆ ê³ ì •í•˜ì—¬ í˜¸ì¶œ í•  ìˆ˜ ìˆëŠ” ê³ ì •ëœ vipë‚˜ domain ì£¼ì†Œê°€ í•„ìš”í•˜ì—¬ ë“±ì¥í•œ ê²ƒì´ Serviceë‹¤. ì´ Serviceì˜ ìš”ì²­ì„ íŒŒë“œë¡œ ì „ë‹¬í•˜ëŠ” ê³¼ì •ì„ kube-proxyì—ì„œ ê¸°ëŠ¥ì„ ì œê³µí•´ì¤€ë‹¤. ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì„¤ì¹˜í•˜ë©´ kube-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë°ëª¬ì…‹ìœ¼ë¡œ ìƒì„±ë˜ëŠ”ë°, í•´ë‹¹ ì»´í¬ë„ŒíŠ¸ê°€ í´ëŸ¬ìŠ¤í„°ì˜ ì„œë¹„ìŠ¤ì™€ íŒŒë“œê°„ì˜ ë„¤íŠ¸ì›Œí¬ í†µì‹ ì„ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ë‹¤.


## kube-proxy 

kube-proxy ë™ì‘í•˜ëŠ”ë°ì— ì—¬ëŸ¬ modeê°€ ìˆëŠ”ë°, ì´ì „ì— ì‚¬ìš©ë˜ì—ˆë˜ user space proxy modeì™€ í˜„ì¬ defaultë¡œ ì‚¬ìš©ë˜ëŠ” iptables proxy mode, ê·¸ë¦¬ê³  ipvs proxy mode ë“±ì´ ìˆë‹¤. 
 

### user space proxy mode

ì²˜ìŒì—ëŠ” user space proxy modeë¡œ ë™ì‘í–ˆì—ˆë‹¤. 

1. í´ë¼ì´ì–¸íŠ¸ê°€ svc ipë¡œ ìš”ì²­ì„ ë³´ë‚´ë©´, ë¨¼ì € ì»¤ë„ ìŠ¤í˜ì´ìŠ¤ì— ë„ì°©í•œë‹¤. 
2. ì»¤ë„ì—ì„œëŠ” netfilterë¼ëŠ” í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ íŒ¨í‚·ì„ í•„í„°ë§í•˜ê³  ì¡°ì‘í•  ìˆ˜ ìˆëŠ”ë°, ì´ ë•Œ, ì„œë¹„ìŠ¤ IPë¡œ ë“¤ì–´ì˜¨ íŒ¨í‚·ì´ netfilterì— ì˜í•´ ê°€ë¡œì±„ì–´ì§€ê³ , ì´ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ user spaceì˜ kube-proxy í”„ë¡œì„¸ìŠ¤ê°€ í˜¸ì¶œëœë‹¤. 
3. íŒ¨í‚·ì´ ì»¤ë„ì—ì„œ user spaceë¡œ ì´ë™í•˜ëŠ” ê³¼ì •ì—ì„œ ì»¤ë„ì€ user spaceì—ì„œ ì‹¤í–‰ ì¤‘ì¸ kube-proxy í”„ë¡œì„¸ìŠ¤ì— íŒ¨í‚·ì„ ì „ë‹¬í•œë‹¤. 
4. user spaceì—ì„œ ì‹¤í–‰ë˜ëŠ” kube-proxyëŠ” íŒ¨í‚·ì„ ìˆ˜ì‹ í•˜ê³  ì´ì— ë§ëŠ” podë¥¼ ì„ íƒí•˜ê³  ê·¸ ì •ë³´ë¥¼ ì»¤ë„ ìŠ¤í˜ì´ìŠ¤ë¡œ ì „ë‹¬í•œë‹¤. 
5. ì´ë ‡ê²Œ ì»¤ë„ë¡œ ë‹¤ì‹œ ì „ë‹¬ëœ íŒ¨í‚·ì€ netfilterë¥¼ í†µí•´ ë‹¤ì‹œ í•œë²ˆ ì²˜ë¦¬ë˜ë©´ì„œ, ìµœì¢…ì ìœ¼ë¡œ podì— ì „ë‹¬ë˜ëŠ” ë°©ì‹ì´ë‹¤.

í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì´ kernel spaceì—ì„œ user spaceë¡œ ë„˜ì–´ê°€ê³  kernel space ëŒì•„ì˜¤ëŠ” ê³¼ì •ì´ ë°œìƒí•˜ê²Œ ë˜ëŠ”ë°, ì´ëŸ° ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ì´ ë¹ˆë²ˆí•˜ê²Œ ì¼ì–´ë‚˜ë©´ì„œ ì˜¤ë²„í—¤ë“œê°€ ì¦ê°€í•˜ê²Œë˜ì–´ ì„±ëŠ¥ì´ ì¢‹ì§€ ì•Šì•„ ë”ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šê²Œ ë˜ì—ˆë‹¤.

### iptables proxy mode

í˜„ì¬ ê¸°ë³¸ìœ¼ë¡œ ì“°ì´ëŠ” ê²ƒì€ Iptables proxy modeì´ë‹¤.

1. í´ë¼ì´ì–¸íŠ¸ê°€ svc ipë¡œ ìš”ì²­ì„ ë³´ë‚´ë©´, ì»¤ë„ìŠ¤í˜ì´ìŠ¤ì— ë„ì°©í•œë‹¤. 
2. ì»¤ë„ì˜ netfilterëŠ” ì´ë¯¸ user spaceì—ì„œ ì„¤ì •í•œ iptables ê·œì¹™ì— ë”°ë¼ ì„¤ì •ë˜ì–´ìˆì–´, user spaceê¹Œì§€ ê°€ì§€ ì•Šê³  netfilterì—ì„œ ê·œì¹™ì— ë§ëŠ” íŒŒë“œë¡œ ì—°ê²°í•´ì¤€ë‹¤.

iptables modeì—ì„œëŠ” kube-proxyê°€ í´ëŸ¬ìŠ¤í„°ì˜ ì„œë¹„ìŠ¤ì™€ Pod ê°„ì˜ ë¼ìš°íŒ… ì •ë³´ë¥¼ ê´€ë¦¬í•˜ë©°, ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ iptables ê·œì¹™ì„ ì—…ë°ì´íŠ¸í•˜ëŠ”ë°, ì´ëŸ¬í•œ ê·œì¹™ë“¤ì€ NAT ë° FORWARD ì²´ì¸ì— ì¶”ê°€ë˜ì–´ ì‹¤ì œ íŒ¨í‚·ì„ í•„í„°ë§í•˜ê³  ë¼ìš°íŒ…í•˜ëŠ”ë°ì— ì‚¬ìš©ëœë‹¤.
kube-proxyì—ì„œëŠ” ì§ì ‘ì ì¸ ê´€ì—¬ë¥¼ í•˜ì§€ ì•Šì§€ë§Œ, iptables ê·œì¹™ì˜ ìˆ˜ê°€ ë§ì•„ì§€ë©´  iptables ì•Œê³ ë¦¬ì¦˜ì— ë”°ë¼ ìˆœì°¨ì ìœ¼ë¡œ ê·œì¹™ì„ ì¡°íšŒí•´ì•¼í•˜ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ì— ì˜í–¥ì„ ë¼ì¹  ìˆ˜ ìˆë‹¤. (ê·œì¹™ ìˆ˜ê°€ ë§ì„ ê²½ìš° íŒ¨í‚· ì²˜ë¦¬ ì§€ì—° ë°œìƒ ê°€ëŠ¥)

ì´ëŸ° ë‹¨ì ì´ ìˆì–´ l4 lbì¸ ipvsë¥¼ ì‚¬ìš©í•œ ipvs proxy modeê°€ ìˆë‹¤. ipvs ëª¨ë“œëŠ” ì»¤ë„ ìŠ¤í˜ì´ìŠ¤ì—ì„œ ë™ì‘í•˜ê³ , ë°ì´í„° êµ¬ì¡°ë¥¼ í•´ì‹œ í…Œì´ë¸”ë¡œ ì €ì¥í•˜ëŠ” ë“± ë¹ ë¥´ê³  ì„±ëŠ¥ì´ ì¢‹ë‹¤. ë‹¤ì–‘í•œ ë¡œë“œë°¸ëŸ°ì‹± ì•Œê³ ë¦¬ì¦˜ì„ ì§€ì›ë˜ëŠ”ë°, ipvsì— ëŒ€í•´ì„œëŠ” ë‹¤ìŒ ì£¼ì°¨ì—ì„œ í™•ì¸ í•  ì˜ˆì •ì´ë‹¤.


# Service type

ì´ë ‡ê²Œ kube-proxyë¡œ ë™ì‘í•˜ëŠ” svc ì¢…ë¥˜ì—ëŠ” cluster ipì™€ node portê°€ ìˆë‹¤. 
- cluster ip: í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ í†µì‹ 
- node port: í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ í†µì‹ 

í˜„ì¬ í…ŒìŠ¤íŠ¸ í´ëŸ¬ìŠ¤í„°ëŠ” defaultì¸ iptables proxy modeë¡œ ì„¤ì •ë˜ì–´ìˆë‹¤.

```
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl describe cm -n kube-system kube-proxy
...
iptables:
  localhostNodePorts: null
  masqueradeAll: false
  masqueradeBit: null
  minSyncPeriod: 1s
  syncPeriod: 0s
...
mode: iptables
...
```

## Custer IP

```
# ì„œë¹„ìŠ¤ íŒŒë“œ ë°°í¬
(âˆ|kind-myk8s:N/A) root@kind:~# cat <<EOT> 3pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: webpod1
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod2
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker2
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod3
  labels:
    app: webpod
spec:
  nodeName: myk8s-worker3
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
EOT
(âˆ|kind-myk8s:N/A) root@kind:~# k apply -f 3pod.yaml
pod/webpod1 created
pod/webpod2 created
pod/webpod3 created

# í…ŒìŠ¤íŠ¸ íŒŒë“œ ë°°í¬
(âˆ|kind-myk8s:N/A) root@kind:~# cat <<EOT> netpod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: net-pod
spec:
  nodeName: myk8s-control-plane
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
EOT
(âˆ|kind-myk8s:N/A) root@kind:~# k apply -f netpod.yaml
pod/net-pod created

# ì„œë¹„ìŠ¤ ë°°í¬
(âˆ|kind-myk8s:N/A) root@kind:~# cat <<EOT> svc-clusterip.yaml
apiVersion: v1
kind: Service
metadata:
  name: svc-clusterip
spec:
  ports:
    - name: svc-webport
      port: 9000        # svcì˜ port
      targetPort: 80    # ì—°ê²° í•  podì˜ port
  selector:
    app: webpod         # ì—°ê²° í•  podì˜ selector
  type: ClusterIP       # ì„œë¹„ìŠ¤ íƒ€ì…
EOT
(âˆ|kind-myk8s:N/A) root@kind:~# k apply -f svc-clusterip.yaml
service/svc-clusterip created


(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get pod -owide
NAME      READY   STATUS    RESTARTS   AGE   IP          NODE                  NOMINATED NODE   READINESS GATES
net-pod   1/1     Running   0          24m   10.10.0.6   myk8s-control-plane   <none>           <none>
webpod1   1/1     Running   0          26m   10.10.1.3   myk8s-worker          <none>           <none>
webpod2   1/1     Running   0          26m   10.10.2.4   myk8s-worker2         <none>           <none>
webpod3   1/1     Running   0          26m   10.10.3.3   myk8s-worker3         <none>           <none>

(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get svc -owide
NAME            TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE   SELECTOR
kubernetes      ClusterIP   10.200.1.1    <none>        443/TCP    18h   <none>
svc-clusterip   ClusterIP   10.200.1.63   <none>        9000/TCP   23m   app=webpod

(âˆ|kind-myk8s:N/A) root@kind:~# kubectl get endpoints svc-clusterip
NAME            ENDPOINTS                                AGE
svc-clusterip   10.10.1.3:80,10.10.2.4:80,10.10.3.3:80   22m
```

clustIPë¡œ ì–´ë–»ê²Œ ì ‘ê·¼í•˜ëŠ”ì§€ í™•ì¸

```
# í…ŒìŠ¤íŠ¸ íŒŒë“œì—ì„œ svcì™€ pod ipë¡œ ì ‘ê·¼ ê°€ëŠ¥í•œ ê²ƒì„ í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# k exec -it net-pod -- /bin/sh
~ # curl -s  10.200.1.63:9000 | grep Hostname
Hostname: webpod3
~ # curl -s 10.10.1.3 | grep Hostname
Hostname: webpod1

# net-podì—ì„œ svc clusterip:portë¡œ í˜¸ì¶œí•˜ëŠ” ë™ì•ˆì˜ tcpdumpë¥¼ í™•ì¸í•´ë³´ë©´,
(âˆ|kind-myk8s:N/A) root@kind:~# k exec -it net-pod -- curl -s 10.200.1.63:9000
Hostname: webpod1

# webpod1ì˜ nodeì— ì ‘ê·¼í•˜ì—¬ í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-worker bash
root@myk8s-worker:/# tcpdump
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on vethe9251aa3, link-type EN10MB (Ethernet), snapshot length 262144 bytes
22:08:23.864882 IP 10.10.0.6.38158 > 10.10.1.3.http: Flags [S], seq 2027460615, win 64240, options [mss 1460,sackOK,TS val 1215853224 ecr 0,nop,wscale 7], length 0
22:08:23.866038 IP 10.10.1.3.http > 10.10.0.6.38158: Flags [S.], seq 1612625038, ack 2027460616, win 65160, options [mss 1460,sackOK,TS val 2760627948 ecr 1215853224,nop,wscale 7], length 0
22:08:23.866107 IP 10.10.0.6.38158 > 10.10.1.3.http: Flags [.], ack 1, win 502, options [nop,nop,TS val 1215853226 ecr 2760627948], length 0
...

# í•´ë‹¹ ì›Œì»¤ ë…¸ë“œì—ì„œ ë“¤ì–´ì˜¤ë©´ ì–´ë–¤ ë£°ì„ íƒ€ê³  ê°€ëŠ”ì§€ iptablesë¥¼ í™•ì¸
# iptablesë¡œ ë“¤ì–´ì˜¬ ë•Œ ê°€ì¥ ë¨¼ì € PREROUTINGì„ íƒ€ì„œ ì—¬ê¸°ì„œ ë¨¼ì € í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it myk8s-control-plane bash

# packet ìˆ˜ ë³€í•œê±°ë¥¼ >> ìœ¼ë¡œ í•˜ì—¬ í‘œì‹œí•¨ 
# ê³„ì†í•´ì„œ packet ìˆ˜ ë³€í•œ ê²ƒì„ ë³´ê³  ì«“ì•„ê°„ë‹¤
root@myk8s-control-plane:/# iptables -v --numeric --table nat --list PREROUTING | column -t
Chain  PREROUTING  (policy        ACCEPT  242  packets,  14662  bytes)
pkts   bytes       target         prot    opt  in        out    source     destination
271    16510       KUBE-SERVICES  0       --   *         *      0.0.0.0/0  0.0.0.0/0    /*  kubernetes  service  portals  */
>>
275    16750       KUBE-SERVICES  0       --   *         *      0.0.0.0/0  0.0.0.0/0    /*  kubernetes  service  portals  */

# KUBE-SERVICESë¥¼ í™•ì¸í•´ë³´ë©´
root@myk8s-control-plane:/# iptables -v --numeric --table nat --list KUBE-SERVICES | column
Chain KUBE-SERVICES (2 references)
 pkts bytes target     prot opt in     out     source               destination
   42  2520 KUBE-SVC-KBDEBIL6IU6WL7RF  6    --  *      *       0.0.0.0/0            10.200.1.63          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000
>>
   43  2580 KUBE-SVC-KBDEBIL6IU6WL7RF  6    --  *      *       0.0.0.0/0            10.200.1.63          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000
 
# KUBE-SVC-KBDEBIL6IU6WL7RF
 root@myk8s-control-plane:/# iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF | column
Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)
 pkts bytes target     prot opt in     out     source               destination
   16   960 KUBE-SEP-W5ROWLZT7Z7YVFGJ  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 10.10.2.4:80 */ statistic mode random probability 0.50000000000
 >>
   17  1020 KUBE-SEP-W5ROWLZT7Z7YVFGJ  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 10.10.2.4:80 */ statistic mode random probability 0.50000000000

# KUBE-SEP-K7ALM6KJRBAYOHKX
# ë§ˆì§€ë§‰ìœ¼ë¡œ  DNATë˜ëŠ” ê²ƒì„ í™•ì¸
root@myk8s-control-plane:/# iptables -v --numeric --table nat --list KUBE-SEP-K7ALM6KJRBAYOHKX
Chain KUBE-SEP-K7ALM6KJRBAYOHKX (1 references)
 pkts bytes target     prot opt in     out     source               destination
   17  1020 DNAT       6    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport */ tcp to:10.10.3.3:80
>>
   18  1080 DNAT       6    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport */ tcp to:10.10.3.3:80


# ë‚˜ê°ˆ ë•ŒëŠ” ì–´ë–»ê²Œ ë‚˜ê°€ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ POSTROUTING ì„ ëª¨ë‹ˆí„°ë§ìœ¼ë¡œ í™•ì¸
# RETURNì— ê±¸ë ¤ì„œ ë£°ì²˜ë¦¬ ë˜ëŠ” ê²ƒì„ í™•ì¸í•¨
root@myk8s-control-plane:/# watch -d 'iptables -v --numeric --table nat --list POSTROUTING | column; echo ; iptables -v --numeric --table nat --list KUBE-POSTROUTING | column'
Every 2.0s: iptables -v --numeric --table nat --list POSTROUTING | column; echo ; iptables -v --numeric --table nat --list...  myk8s-control-plane: Sat Sep 28 22:28:12 2024
...
Chain KUBE-POSTROUTING (1 references)
 pkts bytes target     prot opt in     out     source               destination
  853 51180 RETURN     0    --  *      *       0.0.0.0/0            0.0.0.0/0            mark match ! 0x4000/0x4000
    0     0 MARK       0    --  *      *       0.0.0.0/0            0.0.0.0/0            MARK xor 0x4000
    0     0 MASQUERADE  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service traffic requiring SNAT */ random-fully


# conntrack ëª…ë ¹ì–´ë¡œ ì—°ê²° ìƒíƒœ í™•ì¸
# í…ŒìŠ¤íŠ¸ íŒŒë“œ(10.10.0.6)ì„ ì†ŒìŠ¤ë¡œ ì¡ê³  ë³´ë©´, svc ip(10.200.1.63): dport(9000)ìœ¼ë¡œ í˜¸ì¶œí•˜ê³ 
# ì›ë³¸ íŒŒë“œ(10.10.1.3í˜¹ì€10.10.2.4): ì›ë˜ í¬íŠ¸(80)ì—ì„œ í…ŒìŠ¤íŠ¸ íŒŒë“œ(10.10.0.6)ë¡œ ì—°ê²°í•œ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.
root@myk8s-control-plane:/# conntrack -L --src 10.10.0.6
tcp      6 42 TIME_WAIT src=10.10.0.6 dst=10.200.1.63 sport=55702 dport=9000 src=10.10.1.3 dst=10.10.0.6 sport=80 dport=55702 [ASSURED] mark=0 use=1
tcp      6 72 TIME_WAIT src=10.10.0.6 dst=10.200.1.63 sport=42890 dport=9000 src=10.10.2.4 dst=10.10.0.6 sport=80 dport=42890 [ASSURED] mark=0 use=1
conntrack v1.4.7 (conntrack-tools): 2 flow entries have been shown.

```

clientIPë¡œ ë¶„ì‚° ì²˜ë¦¬ê°€ ë˜ëŠ”ë° ë¶„ì‚°ìœ¨ì— ëŒ€í•˜ì—¬..

```
# ìœ„ì—ì„œ í™•ì¸ í•œ ê²ƒì²˜ëŸ¼ ë³´ë©´ ê° epì— í¼ì„¼íŠ¸ê°€ ì¨ìˆë‹¤.
root@myk8s-control-plane:/# iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF | column
Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 KUBE-MARK-MASQ  6    --  *      *      !10.10.0.0/16         10.200.1.63          /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:9000
   11   660 KUBE-SEP-2WDU4O4C4SDCYWRE  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 10.10.1.3:80 */ statistic mode random probability 0.33333333349
   17  1020 KUBE-SEP-W5ROWLZT7Z7YVFGJ  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 10.10.2.4:80 */ statistic mode random probability 0.50000000000
   17  1020 KUBE-SEP-K7ALM6KJRBAYOHKX  0    --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 10.10.3.3:80 */
```   

ë³´ê¸° í¸í•˜ê²Œ ëì— ì»¬ëŸ¼ë§Œ ë–¼ì˜¤ë©´...
- 1/3 ë§Œí¼ ì´ê³³ìœ¼ë¡œ > default/svc-clusterip:svc-webport -> 10.10.1.3:80 */ statistic mode random probability 0.33333333349
- 1/2 ë§Œí¼ ì´ê³³ìœ¼ë¡œ.. > default/svc-clusterip:svc-webport -> 10.10.2.4:80 */ statistic mode random probability 0.50000000000
- í•˜ë‚˜ ë‚¨ì•˜ìœ¼ë‹ˆ, ì´ê³³ì— ëª¨ë‘ ë³´ë‚´ê²Œ ëœë‹¤. > default/svc-clusterip:svc-webport -> 10.10.3.3:80 */
iptables ê·œì¹™ì´ ìœ„ì—ì„œë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ í•˜ê¸° ë•Œë¬¸ì— ìœ„ì™€ ê°™ì´ í™•ë¥  ê¸°ë°˜ìœ¼ë¡œ ì ìš©ëœë‹¤.

```
# ì‹¤ì œë¡œ ë³´ë‚´ë³´ë©´ ë¹„ìŠ·í•œ ë¹„ìœ¨ë¡œ í˜¸ì¶œëœë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl exec -it net-pod -- zsh -c "for i in {1..100};  do curl -s 10.200.1.63:9000 | grep Hostname; done | sort | uniq -c | sort -nr"
     34 Hostname: webpod3
     33 Hostname: webpod2
     33 Hostname: webpod1

# Client IPë¡œ ì„¸ì…˜ì„ ì„¤ì •í•˜ê²Œ ë˜ë©´
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl patch svc svc-clusterip -p '{"spec":{"sessionAffinity":"ClientIP"}}'
service/svc-clusterip patched

# ìµœê·¼ì— ì—°ê²°í•œ podë¡œë§Œ ì „ì†¡ëœë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl exec -it net-pod -- zsh -c "for i in {1..100};  do curl -s 10.200.1.63:9000 | grep Hostname; done | sort | uniq -c | sort -nr"
    100 Hostname: webpod2
    

# iptables ê·œì¹™ì„ í™•ì¸ë³´ë©´, ëª¨ë“ˆì— recentê°€ ì¶”ê°€ë˜ì–´ ìµœê·¼ íŒ¨í‚·ì„ ì¶”ì í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤.
# --rsource: source IPì— í•´ë‹¹ ê·œì¹™ì„ ì ìš©
root@myk8s-control-plane:/# iptables -t nat -S | grep recent
-A KUBE-SEP-2WDU4O4C4SDCYWRE -p tcp -m comment --comment "default/svc-clusterip:svc-webport" -m recent --set --name KUBE-SEP-2WDU4O4C4SDCYWRE --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.10.1.3:80
-A KUBE-SEP-K7ALM6KJRBAYOHKX -p tcp -m comment --comment "default/svc-clusterip:svc-webport" -m recent --set --name KUBE-SEP-K7ALM6KJRBAYOHKX --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.10.3.3:80
-A KUBE-SEP-W5ROWLZT7Z7YVFGJ -p tcp -m comment --comment "default/svc-clusterip:svc-webport" -m recent --set --name KUBE-SEP-W5ROWLZT7Z7YVFGJ --mask 255.255.255.255 --rsource -m tcp -j DNAT --to-destination 10.10.2.4:80
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.1.3:80" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-2WDU4O4C4SDCYWRE --mask 255.255.255.255 --rsource -j KUBE-SEP-2WDU4O4C4SDCYWRE
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.2.4:80" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-W5ROWLZT7Z7YVFGJ --mask 255.255.255.255 --rsource -j KUBE-SEP-W5ROWLZT7Z7YVFGJ
-A KUBE-SVC-KBDEBIL6IU6WL7RF -m comment --comment "default/svc-clusterip:svc-webport -> 10.10.3.3:80" -m recent --rcheck --seconds 10800 --reap --name KUBE-SEP-K7ALM6KJRBAYOHKX --mask 255.255.255.255 --rsource -j KUBE-SEP-K7ALM6KJRBAYOHKX

```

## NodePort

ì™¸ë¶€ í†µì‹ ì‹œ, node ipì— svcì—ì„œ ì œê³µí•˜ëŠ” node portë¥¼ ë¶™ì—¬ì„œ ì ‘ê·¼í•œë‹¤. (node port í• ë‹¹ë²”ìœ„: 30000~32767)
node port ì ‘ê·¼ í›„ì—ëŠ” cluster ipí†µì‹ ê³¼ ë™ì¼í•˜ë‹¤.

```
# ê¸°ì¡´ íŒŒë“œì™€ ì„œë¹„ìŠ¤ëŠ” ì‚­ì œ í›„ ì§„í–‰í•˜ì˜€ë‹¤.
(âˆ|kind-myk8s:N/A) root@kind:~# cat echo-deploy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-echo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: deploy-websrv
  template:
    metadata:
      labels:
        app: deploy-websrv
    spec:
      terminationGracePeriodSeconds: 0
      containers:
      - name: kans-websrv
        image: mendhak/http-https-echo
        ports:
        - containerPort: 8080

(âˆ|kind-myk8s:N/A) root@kind:~# cat svc-nodeport.yaml
apiVersion: v1
kind: Service
metadata:
  name: svc-nodeport
spec:
  ports:
    - name: svc-webport
      port: 9000        # ë‚´ë¶€ ì ‘ê·¼ì‹œ ì‚¬ìš© (Cluster IPìš©)
      targetPort: 8080  # ì—°ê²° í•  íŒŒë“œ port
  selector:
    app: deploy-websrv
  type: NodePort
  
(âˆ|kind-myk8s:N/A) root@kind:~# kubectl apply -f echo-deploy.yaml,svc-nodeport.yaml
deployment.apps/deploy-echo created
service/svc-nodeport created

# ë°°í¬ëœ íŒŒë“œì™€ ì„œë¹„ìŠ¤ í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# k get po,svc,ep -owide
NAME                               READY   STATUS    RESTARTS   AGE     IP          NODE                  NOMINATED NODE   READINESS GATES
pod/deploy-echo-5c689d5454-mgn4p   1/1     Running   0          84m     10.10.3.5   myk8s-worker3         <none>           <none>
pod/deploy-echo-5c689d5454-w4nb6   1/1     Running   0          84m     10.10.2.8   myk8s-worker2         <none>           <none>
pod/net-pod                        1/1     Running   0          3h13m   10.10.0.6   myk8s-control-plane   <none>           <none>

NAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE   SELECTOR
service/kubernetes     ClusterIP   10.200.1.1     <none>        443/TCP          21h   <none>
service/svc-nodeport   NodePort    10.200.1.217   <none>        9000:31662/TCP   84m   app=deploy-websrv

NAME                     ENDPOINTS                       AGE
endpoints/kubernetes     172.18.0.5:6443                 21h
endpoints/svc-nodeport   10.10.2.8:8080,10.10.3.5:8080   84m


# node ip í™•ì¸
(âˆ|kind-myk8s:N/A) root@kind:~# k get node -owide
NAME                  STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION       CONTAINER-RUNTIME
myk8s-control-plane   Ready    control-plane   19h   v1.31.0   172.18.0.5    <none>        Debian GNU/Linux 12 (bookworm)   5.15.0-119-generic   containerd://1.7.18
myk8s-worker          Ready    <none>          19h   v1.31.0   172.18.0.2    <none>        Debian GNU/Linux 12 (bookworm)   5.15.0-119-generic   containerd://1.7.18
myk8s-worker2         Ready    <none>          19h   v1.31.0   172.18.0.4    <none>        Debian GNU/Linux 12 (bookworm)   5.15.0-119-generic   containerd://1.7.18
myk8s-worker3         Ready    <none>          19h   v1.31.0   172.18.0.3    <none>        Debian GNU/Linux 12 (bookworm)   5.15.0-119-generic   containerd://1.7.18


# í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ë°°í¬
(âˆ|kind-myk8s:N/A) root@kind:~# docker run -d --rm --name mypc --network kind nicolaka/netshoot sleep infinity
0fa3ba5fe630519214de4ac59414d85ec7805dc5b23b56e27eae484c818d8ba4
(âˆ|kind-myk8s:N/A) root@kind:~# docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                                             NAMES
0fa3ba5fe630   nicolaka/netshoot      "sleep infinity"         24 seconds ago   Up 24 seconds                                                                     mypc
...
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it 0f
```

```
# clusterIPë¡œëŠ” ì ‘ê·¼ ë¶ˆê°€
0fa3ba5fe630 î‚° ~ î‚° curl -s 10.200.1.217:9000

# nodeIP:nodePortë¡œ í˜¸ì¶œ
(âˆ|kind-myk8s:N/A) root@kind:~# docker exec -it 0f zsh
0fa3ba5fe630 î‚° ~ î‚° curl -s  172.18.0.2:31662 | grep hostname
  "hostname": "172.18.0.2",
    "hostname": "deploy-echo-5c689d5454-w4nb6"
0fa3ba5fe630 î‚° ~ î‚° curl -s  172.18.0.3:31662 | grep hostname
  "hostname": "172.18.0.3",
    "hostname": "deploy-echo-5c689d5454-mgn4p"
0fa3ba5fe630 î‚° ~ î‚° curl -s  172.18.0.4:31662 | grep hostname
  "hostname": "172.18.0.4",
    "hostname": "deploy-echo-5c689d5454-mgn4p"
0fa3ba5fe630 î‚° ~ î‚° curl -s  172.18.0.5:31662 | grep hostname
  "hostname": "172.18.0.5",
    "hostname": "deploy-echo-5c689d5454-w4nb6"
```

myk8s-worker(172.17.0.2)ë‚˜ myk8s-control-plane(172.17.0.5)ì—ëŠ” svcì— ì—°ê²°ëœ podê°€ ì—†ëŠ”ë°ì—ë„ ì ‘ê·¼ì´ ì˜ë˜ê³ , hostnameì—ë„ ë…¸ë“œ ipê°€ ë°˜í™˜ëœë‹¤.

```
# worker ë…¸ë“œë¥¼ í˜¸ì¶œí•˜ê³  worker ë…¸ë“œì—ì„œ tcpdumpë¡œ í™•ì¸
0fa3ba5fe630 î‚° ~ î‚° curl -s  172.18.0.2:31662 | grep hostname
  "hostname": "172.18.0.2",
    "hostname": "deploy-echo-5c689d5454-w4nb6"

# myk8s-worker = w1
# myk8s-worker2 = w2
 
# í…ŒìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ(mypc)ì—ì„œ ë“¤ì–´ì˜¨ íŒ¨í‚· í™•ì¸
(w1) 00:57:28.215640 IP mypc.kind.40906 > myk8s-worker.31662: Flags [S], seq 2911406569, win 64240, options [mss 1460,sackOK,TS val 470432859 ecr 0,nop,wscale 7], length 0

# w1ì—ì„œ 10.10.2.8(svcì™€ ì—°ê²°ëœ pod ip)ë¡œ ì „ë‹¬
(w2) 00:57:28.215722 IP myk8s-worker.kind.64570 > 10.10.2.8.http-alt: Flags [S], seq 2911406569, win 64240, options [mss 1460,sackOK,TS val 470432859 ecr 0,nop,wscale 7], length 0
(w2) 00:57:28.215736 IP 10.10.2.8.http-alt > myk8s-worker.kind.64570: Flags [S.], seq 2028762515, ack 2911406570, win 65160, options [mss 1460,sackOK,TS val 2654379599 ecr 470432859,nop,wscale 7], length 0

(w1) 00:57:28.215741 IP 10.10.2.8.http-alt > myk8s-worker.64570: Flags [S.], seq 2028762515, ack 2911406570, win 65160, options [mss 1460,sackOK,TS val 2654379599 ecr 470432859,nop,wscale 7], length 0
...
# í™•ì¸í•´ë³´ë©´, w1ëŠ” ë– ìˆëŠ” íŒŒë“œê°€ ì—†ì–´ì„œ íŒŒë“œê°€ ìˆëŠ” w2ì— ê°€ì„œ ì‘ë‹µì„ ê°€ì ¸ì˜¨ ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.
```

iptablesë¥¼ ë”°ë¼ê°€ë³´ì

```
root@myk8s-worker:/# iptables -t nat -S | grep PREROUTING
-A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
...

# node portë¥¼ íƒ€ê³  ì˜¤ê¸° ë•Œë¬¸ì—, ì•„ë˜ì˜ ê·œì¹™ì„ ë”°ë¼ê°„ë‹¤.
root@myk8s-worker:/# iptables -t nat -S | grep KUBE-SERVICES
...
-A KUBE-SERVICES -m comment --comment "kubernetes service nodeports; NOTE: this must be the last rule in this chain" -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS

# node portì¸ 31662ë¥¼ ë”°ë¼..
root@myk8s-worker:/# iptables -t nat -S | grep KUBE-NODEPORTS
...
-A KUBE-NODEPORTS -p tcp -m comment --comment "default/svc-nodeport:svc-webport" -m tcp --dport 31662 -j KUBE-EXT-VTR7MTHHNMFZ3OFS

# source ipë¥¼ node ipë¡œ ë³€ê²½í•œë‹¤
# (w2) 00:57:28.215722 ì—ì„œ, ì´ë ‡ê²Œ ë³€í™˜ë˜ì–´ì„œ w2ì˜ podì—ê²Œ ìš”ì²­ì´ ê°„ ê²ƒ
root@myk8s-worker:/# iptables -t nat -S | grep KUBE-EXT-VTR7MTHHNMFZ3OFS
...
-A KUBE-EXT-VTR7MTHHNMFZ3OFS -m comment --comment "masquerade traffic for default/svc-nodeport:svc-webport external destinations" -j KUBE-MARK-MASQ

# ì´ë ‡ê²Œ ë³€í™˜ì´ ëœ í›„ë¡œëŠ” node ì—ì„œ ìš”ì²­ì´ ê°€ëŠ” ê²ƒìœ¼ë¡œ ë³´ì—¬, clusterIPë¡œ í†µì‹  í•  ë•Œì™€ ë™ì¼í•˜ê²Œ ê·œì¹™ì„ íƒ€ê²Œ ëœë‹¤.

```


