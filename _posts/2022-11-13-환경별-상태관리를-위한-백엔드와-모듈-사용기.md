---
layout: post
title: k101) í™˜ê²½ë³„ ìƒíƒœê´€ë¦¬ë¥¼ ìœ„í•œ ë°±ì—”ë“œì™€ ëª¨ë“ˆ ì‚¬ìš©ê¸° 
category: study
tags: study
---

ë§¤ë²ˆ ìŠ¤í„°ë””ì—ì„œ awsë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë´¤ì—ˆì–´ì„œ ì¤‘ê°„ê³¼ì œ ê²¸ gcpì—ì„œë„ í…ŒìŠ¤íŠ¸ í•´ë³´ì•˜ë‹¤.
ì‹œì‘í•˜ê¸°ì— ì•ì„œ, gcpì—ì„œ í…Œë¼í¼ì„ ì‹œì‘í•˜ê¸° ìœ„í•œ ê¶Œí•œ ì¸ì¦ì´ í•„ìš”í•˜ë‹¤. gcloud auth application-default login í˜¹ì€ ì„œë¹„ìŠ¤ê³„ì •ì˜ jsoníŒŒì¼ì„ í†µí•´ ì¸ì¦ ê°€ëŠ¥í•˜ë‹¤. [ğŸ”—](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference#running-terraform-outside-of-google-cloud)


## êµ¬ì„±
gcsë¥¼ remoteì €ì¥ì†Œë¡œ ì§€ì •í•˜ê³ , ëª¨ë“ˆì— ë¦¬ì†ŒìŠ¤ë³„ íŒŒì¼ì„ ë‘ì–´ ê° í™˜ê²½ë³„ë¡œ ìƒíƒœê´€ë¦¬ë¥¼ í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¡œ í…ŒìŠ¤íŠ¸ í•´ë³´ì•˜ë‹¤.

![1-1](/assets/img/k101/1-1.png)


### ë°±ì—”ë“œ êµ¬ì„±
awsì˜ ê²½ìš° s3ì˜ lock(ìƒíƒœì ê¸ˆ) ê¸°ëŠ¥ì´ ì—†ì–´ dynamoDBì™€ í•¨ê»˜ ì‚¬ìš©í•´ì•¼í•˜ì§€ë§Œ, gcsì˜ ê²½ìš° lockê¸°ëŠ¥ì„ ì œê³µí•˜ê¸° ë•Œë¬¸ì— ë‹¨ë…ìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ëœë‹¤. lockê¸°ëŠ¥ì€ ê¸°ì¡´ì— ì—…ë°ì´íŠ¸ ì¤‘ì¸ ìƒíƒœíŒŒì¼ì´ ì™„ë£Œ í›„ì— ë‹¤ìŒ ì—…ë°ì´íŠ¸ê°€ ê°€ëŠ¥í•˜ë„ë¡ ì ê¸°ëŠ” ê¸°ëŠ¥ì„ ë§í•œë‹¤. [ğŸ”—](https://developer.hashicorp.com/terraform/language/settings/backends/gcs)
[https://developer.hashicorp.com/terraform/language/settings/backends/gcs

```

# ë²„í‚·ëª…ì€ ê³ ìœ í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— ëœë¤í•œ ê°’ì„ ë°›ìŒ
resource "random_id" "bucket_prefix" {
  byte_length = 8
}

# ìœ„ì˜ ê°’ì„ ë°›ì•„ ë²„í‚· ìƒì„±
# ìƒíƒœ íŒŒì¼ì„ ì—…ë°ì´íŠ¸ í•˜ë©´ì„œ ê¸°ì¡´ ë‚´ì—­ë„ í™•ì¸ì´ ë˜ì–´ì•¼í•˜ê¸° ë•Œë¬¸ì— ë²„ì „ ê´€ë¦¬ í•„ìš”
resource "google_storage_bucket" "backend" {
  name          = "${random_id.bucket_prefix.hex}-bucket-tfstate"
  force_destroy = false
  location      = "asia-northeast3"
  storage_class = "STANDARD"
  versioning {
    enabled = true
  }
}


```


### module
ëª¨ë“ˆì€ ì‘ì„±í•´ë‘” íŒŒì¼ì— ë³€ìˆ˜ ê°’ë“¤ë§Œ ë³€ê²½í•˜ì—¬ ì‰½ê²Œ ìƒì„±í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” í™˜ê²½ì´ë‹¤. ì´ëŸ° ê²½ìš° ì—¬ëŸ¬ í™˜ê²½ì—ì„œ ë™ì¼í•œ êµ¬ì„±ìœ¼ë¡œ ìƒì„±í•´ì•¼í•  ë•Œ ìœ ìš©í•˜ê²Œ ì‚¬ìš©ë  ìˆ˜ ìˆë‹¤. 

ì˜ˆì‹œë¡œ modules/gce/main.tf íŒŒì¼ì„ ì‚´í´ë³´ë©´, í™˜ê²½ë³„ë¡œ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆëŠ” ì´ë¦„ì´ë‚˜ ë¨¸ì‹ íƒ€ì…, ì‚¬ìš©ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë“±ì€ ë³€ìˆ˜ë¡œ ë°›ì§€ë§Œ ê·¸ ì™¸ì—ëŠ” ê³ ì •í•´ë’€ë‹¤.


```

## modules/gce/main.tf ##
# default sa ì •ë³´ë¥¼ ê°€ì ¸ì˜´
data "google_compute_default_service_account" "default" {
}

# ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œ ê° ë³€ìˆ˜ë¥¼ ë°›ì•„ì„œ ìƒì„±
resource "google_compute_instance" "default" {
  name         = var.name
  machine_type = var.machine_type
  zone         = var.zone

  tags = var.tags

# ê·¸ ì™¸ì˜ ê°’ë“¤ì€ ê³ ì •
  boot_disk {
    initialize_params {
      image = "debian-cloud/debian-11"
    }
  }
  scratch_disk {
    interface = "SCSI"
  }

  network_interface {
    network = var.network
    access_config {
    }
    subnetwork = var.subnetwork
  }

  metadata_startup_script = <<-EOF
    #!/bin/bash
			sudo apt-get update -y
			sudo apt-get install default-mysql-client -y
			curl -o cloud_sql_proxy https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64
			sudo chmod +x cloud_sql_proxy
			./cloud_sql_proxy -instances=proejctid:asia-northeast3:private-ip-sql-instance=tcp:3306 &
  EOF

  service_account {
    email  = data.google_compute_default_service_account.default.email
    scopes = ["cloud-platform"]
  }
}

```


ì‹¤ì œ í™˜ê²½ì—ì„œ ì‚¬ìš©ì‹œ ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì´ë¯¸ ë¦¬ì†ŒìŠ¤ë“¤ì˜ êµ¬ì„±ì— ëŒ€í•´ì„œëŠ” ìœ„ì˜ ëª¨ë“ˆì—ì„œ ì‘ì„± ë˜ì—ˆê¸° ë•Œë¬¸ì— ì´ ê³³ì—ëŠ” í”„ë¡œë°”ì´ë”ì™€ ì €ì¥ì†Œ ì§€ì •, ëª¨ë“ˆ í˜¸ì¶œë§Œ í•´ì£¼ë©´ëœë‹¤. 


```

## env1/gce/main.tf ##
# ì›ê²©ì €ì¥ì†Œì— í”„ë¦¬í”½ìŠ¤ë¡œ ìƒíƒœíŒŒì¼ì„ êµ¬ë¶„í•¨
terraform {
 backend "gcs" {
   bucket  = "6c33b0b648439490-bucket-tfstate"
   prefix  = "terraform/state/env1/gce"
 }
}

# í”„ë¡œë°”ì´ë” ì§€ì •ì€ ëª¨ë“ˆì´ ì•„ë‹Œ ê° í™˜ê²½ë³„ë¡œ ì‘ì„±í•˜ì—¬ ë¶ˆëŸ¬ì˜¤ê²Œ í•¨
provider "google" {
  project     = var.project_id
  region      = "asia-northeast3"
}

# ëª¨ë“ˆ ì‚¬ìš©ì‹œ ì†ŒìŠ¤ ìœ„ì¹˜ë¥¼ ì§€ì •í•¨
module "gce" {
  source = "../../modules/gce"

  name = var.name
  network = var.network

}

```


ëª¨ë“ˆ ì‚¬ìš© ì‹œ ë³€ê²½ ê°’ì´ í•„ìš”í•˜ê±°ë‚˜ ê¸°ë³¸ ê°’ì´ ì—†ëŠ” ë³€ìˆ˜ë“¤ì— ëŒ€í•œ ê°’ì´ í•„ìš”í•˜ë‹¤.



```

# cat env1/gce/variables.tf
variable "name" {}
variable "network" {}


# cat env1/gce/terraform.tfvars
name = "nyoung-test"
network = "nyoung-vpc"
```


ìœ„ì˜ ë°©ë²•ë“¤ì„ ì‚¬ìš©í•˜ì—¬ private cloud sqlê³¼ í”„ë¡ì‹œ ê¸°ëŠ¥ì„ í•  ìˆ˜ ìˆëŠ” ì¸ìŠ¤í„´ìŠ¤ë¥¼ êµ¬ì„±í•˜ëŠ” íŒŒì¼ì„ ì‘ì„±í•˜ì˜€ë‹¤. ì•„ì§ ì‘ì„±í•˜ëŠ” ê²ƒì´ ìµìˆ™í•˜ì§€ì•Šì•„ ê½¤..  ë‹¤ë“¬ì–´ì•¼ í•˜ì§€ë§Œ ê·¸ë˜ë„ ì—°ê²°í•˜ê³  í†µì‹ í•˜ëŠ”ë°ì—ëŠ” ë¬¸ì œì—†ë‹¤. ì „ì²´ ì½”ë“œëŠ” ê¹ƒí—™ì— ë”°ë¡œ ì˜¬ë ¤ë’€ë‹¤. [ğŸ”—](https://github.com/nyoung08/t101/tree/main/mid)




---
ì°¸ê³ 
- [https://github.com/terraform-google-modules/terraform-google-network](https://github.com/terraform-google-modules/terraform-google-network)
- [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_instance](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_instance)
- [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/sql_database_instance(https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/sql_database_instance)
- [https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference#running-terraform-outside-of-google-cloud](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_reference#running-terraform-outside-of-google-cloud)
- [https://developer.hashicorp.com/terraform/language/settings/backends/gcs](https://developer.hashicorp.com/terraform/language/settings/backends/gcs)
- [https://cloud.google.com/sql/docs/mysql/connect-instance-auth-proxy?hl=ko#get-connection-name](https://cloud.google.com/sql/docs/mysql/connect-instance-auth-proxy?hl=ko#get-connection-name)
- [https://cloud.google.com/docs/terraform/best-practices-for-terraform?hl=ko#test-methods](https://cloud.google.com/docs/terraform/best-practices-for-terraform?hl=ko#test-methods)

