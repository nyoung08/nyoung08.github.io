---
layout: post
title: a101) ansible ì‹œìŠ¤í…œ êµ¬ì¶• ìë™í™” 
category:
  - study
  - ansible
tags:
  - study
  - ansible
---

ì‹œìŠ¤í…œ êµ¬ì¶• ìë™í™”ë¡œ ê³„ì • ìƒì„±, íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë“±ì— ëŒ€í•´ í•™ìŠµí–ˆë‹¤. 

# aws secretmanagerë¥¼ í™œìš©í•˜ì—¬ ì‚¬ìš©ì ê³„ì • ìƒì„±

í…ŒìŠ¤íŠ¸í•˜ëŠ” ansible í™˜ê²½ì€ ì•„ë˜ì™€ ê°™ë‹¤.
```
#ansible.cfg
[defaults]
inventory = ./inventory
remote_user = ubuntu
ask_pass = false
[privilege_escalation]
become = true
become_method = sudo
become_user = root
become_ask_pass = false

#inventory
[tnode]
tnode1
tnode2
tnode3
```

ì‚¬ìš©ì ìƒì„±ì‹œ ì‚¬ìš© í•  ê³„ì • ì •ë³´ë¥¼ ansible-vaultë¥¼ ì´ìš©í•˜ì—¬ ì•”í˜¸í™” í•´ì£¼ì—ˆë‹¤.
```
$ ansible-vault create vars/secret.yaml
New Vault password: qwe123
Confirm New Vault password: qwe123

#vars/secret.yaml
user_info:
  - userid: "testuser1"
    userpw: "test1"
  - userid: "testuser2"
    userpw: "test2"
```

![1-0](/assets/img/a101/3w/1-0.png)
ansible-vaultë¥¼ ì´ìš©í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ secretì— ì•”í˜¸í™”ë˜ì–´ ì €ì¥ëœë‹¤. ì´ì œ ì´ê±¸ ì•„ë˜ì²˜ëŸ¬ ì‚¬ìš© í•  ìˆ˜ê°€ ìˆë‹¤.
ì£¼ì˜ í•  ì ì€ ansible.builtin.user ëª¨ë“ˆì˜ update_password ì˜µì…˜ì´ alwaysê°€ ê¸°ë³¸ê°’ì´ê¸° ë•Œë¬¸ì—, í”Œë ˆì´ë¶ ì‹¤í–‰ì‹œë§ˆë‹¤ passwordê°€ ì—…ë°ì´íŠ¸ ëœë‹¤. ì´ ë•Œ, password_hash(hashtype,salt)ë¶€ë¶„ì˜ saltê°€ ê³µë°±ì¼ì‹œ ëœë¤í•œ ê°’ì´ ë“¤ì–´ê°€ê²Œë˜ë©´ì„œ ë§¤ë²ˆ í•´ë‹¹ í”Œë ˆì´ë¶ì„ ëŒë¦´ë•Œë§ˆë‹¤ ë¹„ë°€ë²ˆí˜¸ì˜ í•´ì‹œê°’ì´ ì¡°ê¸ˆì”© ë³€ê²½ëœë‹¤. ê·¸ë ‡ê¸°ë•Œë¬¸ì—, update_passwordì˜ ì˜µì…˜ì„ on_create(ìƒì„±ì‹œì—ë§Œ ì—…ë°ì´íŠ¸í•˜ë„ë¡) ì§€ì •í•˜ê±°ë‚˜, passwordì—ì„œ salt ê°’ì„ í•˜ë‚˜ ì§€ì •í•´ì£¼ë©´ ëœë‹¤. 


```
- hosts: all

  vars_files:
    - vars/secret.yaml

  tasks:
  - name: Create user
    ansible.builtin.user:
      name: "{{ item.userid }}"
      password: "{{ item.userpw | password_hash('sha512') }}"
      update_password: on_create
      state: present
      shell: /bin/bash
    loop: "{{ user_info }}"


# ì‹¤í–‰
$ ansible-playbook --ask-vault-pass create_user.yaml
Vault password: 
```

ì´ë ‡ê²Œ ansible-vaultë¥¼ ì‚¬ìš©í•˜ì—¬ ì•”í˜¸í™” í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì´ ì•”í˜¸í™” ì‹œ ì‚¬ìš©í•œ ë¹„ë°€ë²ˆí˜¸ê°€ ë¬¸ì œê°€ëœë‹¤. í”Œë ˆì´ë¶ ì‹¤í–‰ì‹œ, ë³µí˜¸í™”ë¥¼ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‹¤í–‰í•  ë•Œë§ˆë‹¤ ì§ì ‘ íƒ€ì´í•‘ì„ í•´ì¤˜ì•¼í•˜ê±°ë‚˜ ìë™í™”ë¥¼ ìœ„í•´ íŒŒì¼ë¡œ ë‚¨ê¸¸ ìˆ˜ë„ ìˆì§€ë§Œ ë¹„ë°€ë²ˆí˜¸ê°€ í•˜ë“œì½”ë”©ë˜ì–´ ì €ì¥ëœë‹¤. ì´ëŸ° ì´ìœ ë¡œ ë³µí˜¸í™” í‚¤ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ê¸° ìœ„í•´ ì™¸ë¶€ ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•  ìˆ˜ê°€ ìˆë‹¤. ì•„ë˜ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” aws secret managerë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µí˜¸í™” í‚¤ë¥¼ ì „ë‹¬ í•˜ì˜€ë‹¤. [ğŸ”—](https://github.com/choisungwook/ansible_practice/tree/main/examples/playbook_ansible_vault)
aws secretmangerì— ìº¡ì³ì™€ ê°™ì´ key-valueí˜•íƒœë¡œ ë³µí˜¸í™” ì‹œ ì‚¬ìš©í•  í‚¤ë¥¼ ë„£ì–´ì£¼ê³ , í”Œë ˆì´ë¶ ì‹¤í–‰ì‹œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë„ë¡ ìŠ¤í¬ë¦½íŠ¸ë„ í•˜ë‚˜ ì‘ì„±í–ˆë‹¤. ì‹¤í–‰í•´ë³´ë©´ ì˜¤ë¥˜ ì—†ì´ ë³µí˜¸í™” í‚¤ë¥¼ ê°€ì ¸ì™€ì„œ í”Œë ˆì´ë¶ì´ ë™ì‘í•œë‹¤.

![1-1](/assets/img/a101/3w/1-1.png)

```
# get_vault_passwd.sh íŒŒì¼ ë‚´ìš©
#!/bin/sh
aws secretsmanager get-secret-value --secret-id ansiblepasswd | jq -r .SecretString | jq -r .ansible_user_info

# í”Œë ˆì´ë¶ ì‹¤í–‰ì‹œ
$ ansible-playbook create_user.yaml --vault-password-file ./get_vault_passwd.sh
```


# ë¡œì»¬ì—ì„œ ìƒì„±í•œ ìœ ì €ì˜ í‚¤ ì „ë‹¬

```
- hosts: localhost
  tasks:
  - name : Create ssh key
    ansible.builtin.user:
      name: "{{ userid }}"
      generate_ssh_key: true
      ssh_key_bits: 2048
      ssh_key_file: /home/{{ userid }}/.ssh/id_rsa

- hosts: tnode 
  tasks:
  - name: Copy SSH Pub key
    ansible.posix.authorized_key:
      user: "{{ userid }}"
      state: present
      key: "{{ lookup('file', '/home/{{ userid }}/.ssh/id_rsa.pub') }}"
# lookupì€ playbook ì™¸ë¶€ ì†ŒìŠ¤ ì ‘ê·¼ì‹œ ì‚¬ìš© í•  ìˆ˜ ìˆë‹¤.
# ì˜ˆë¥¼ ë“¤ì–´, ì—¬ê¸°ì„œëŠ” '/home/{{ userid }}/.ssh/id_rsa.pub'ì¸ íŒŒì¼ì„ ì°¾ì•„ì˜¨ë‹¤.
```

ì´ ë•Œ, ë‘ë²ˆì§¸ taskì¸ copy ssh pub keyë¶€ë¶„ì—ì„œ ê¶Œí•œ ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤. ì°¾ì•„ë³´ë‹ˆ, becomeì˜ ê²½ìš° íƒ€ê²Ÿë…¸ë“œ(ì—¬ê¸°ì„œëŠ” tnode) ì—ë§Œ ì ìš© ë˜ëŠ” ê²ƒì´ë¼, localì— ìˆëŠ” í‚¤ë¥¼ ì½ì§€ ëª»í•˜ëŠ” ê²ƒì´ë¼ê³ í•œë‹¤. ê·¸ë˜ì„œ create ssh keyì— registerë¡œ ë°›ì€ ê°’ì„ {{ hostvars.localhost.newuser.ssh_public_key }}ë¡œ í‚¤ë¥¼ ì…ë ¥í•´ë³´ê³ .. tmpê°™ì€ ë‹¤ë¥¸ ë””ë ‰í† ë¦¬ì— í‚¤ë¥¼ ì˜®ê²¨ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ë„ í•´ë´¤ëŠ”ë°.. ì™œì¸ì§€ ì˜¤ë¥˜ë§Œ ë‚˜ì„œ ansible.cfgì—ì„œ default userë¥¼ rootë¡œ ë³€ê²½í•˜ì—¬ ì§„í–‰í•˜ì˜€ë‹¤..

```
# ansible.cfgì—ì„œ ë³€ê²½
[defaults]
inventory = ./inventory
remote_user = root
inject_facts_as_vars = false

# ì‹¤í–‰ ì‹œ
$ sudo ansible-playbook -e userid=ansible create_sshkey.yaml --ask-pass
```

![1-2](/assets/img/a101/3w/1-2.png)

íƒ€ê²Ÿ ë…¸ë“œë¡œ í‚¤ê°€ ì˜®ê²¨ì§„ ansible ê³„ì •ë„ íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥ì—†ì´ root ê¶Œí•œì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ì¶”ê°€ ì„¤ì •ì„ í•´ì£¼ì—ˆë‹¤. sudoersì— ansible ALL=(root) NOPASSWD:ALL ì„ ë„£ì–´ ì–´ë–¤ í˜¸ìŠ¤íŠ¸ë“  ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•œë‹¤.
```
- hosts: all
  tasks:
  - name: Create file
    ansible.builtin.file:
      path: /etc/sudoers.d/ansible
      mode: '0600'
      state: touch

  - name: Edit file
    ansible.builtin.lineinfile:
      path: /etc/sudoers.d/ansible
      line: ansible ALL=(root) NOPASSWD:ALL
```


# íŒ¨í‚¤ì§€ ì„¤ì¹˜

ìš´ì˜ì²´ì œë§ˆë‹¤ ì‚¬ìš©í•˜ëŠ” íŒ¨í‚¤ì§€ë‚˜ ì„¤ì • íŒŒì¼ ìœ„ì¹˜ ë“±ì´ ë‹¤ë¥´ë¯€ë¡œ, ìˆ˜ì§‘í•œ factsë¥¼ ê°€ì§€ê³  ê°ê°ì— ë§ëŠ” ëª¨ë“ˆì´ ì‹¤í–‰ë˜ë„ë¡ í•˜ì˜€ë‹¤. ì¬ì‚¬ìš© í•  ìˆ˜ ìˆëŠ” ë¡¤ì„ ì‚¬ìš©í•˜ì—¬ ì‘ì„±í•˜ì˜€ë‹¤. 

```
# ë¡¤ ìƒì„±ì„ ìœ„í•´ ì´ˆê¸°í™”í•´ì¤€ë‹¤.

$ ansible-galaxy role init --init-path ./roles role.nginx
- Role role.nginx was created successfully

# ê·¸ëŸ¼ ì´ë ‡ê²Œ í•˜ìœ„ì— ìˆ˜ë§ì€ ë””ë ‰í† ë¦¬ì™€ íŒŒì¼ì´ ìƒê¸°ëŠ”ë°, ê° ë””ë ‰í† ë¦¬ë“¤ì€ ë¡¤ ê·œì¹™ìœ¼ë¡œ ì •í•´ì ¸ ìˆë‹¤. 
 tree roles/role.nginx/
./roles/role.nginx/
â”œâ”€â”€ README.md
â”œâ”€â”€ defaults #ê°€ë³€ë³€ìˆ˜
â”‚   â””â”€â”€ main.yml #ë©”ì¸ íƒœìŠ¤í¬ì—ì„œ ì‚¬ìš©ëœ ë³€ìˆ˜ ì„ ì–¸
â”œâ”€â”€ files #ì •ì íŒŒì¼(index.html ìœ„ì¹˜)
â”œâ”€â”€ handlers #í•¸ë“¤ëŸ¬
â”‚   â””â”€â”€ main.yml #restart service httpd
â”œâ”€â”€ meta
â”‚   â””â”€â”€ main.yml
â”œâ”€â”€ tasks
â”‚   â””â”€â”€ main.yml #ë©”ì¸ íƒœìŠ¤í¬(install service httpd & cp html file)
â”œâ”€â”€ templates
â”œâ”€â”€ tests
â”‚   â”œâ”€â”€ inventory
â”‚   â””â”€â”€ test.yml
â””â”€â”€ vars #ë¶ˆë³€ë³€ìˆ˜
    â””â”€â”€ main.yml #ë©”ì¸ íƒœìŠ¤í¬ì™€ í•¸ë“¤ëŸ¬ì—ì„œ ì‚¬ìš©ëœ ë³€ìˆ˜ ì„ ì–¸
```

ìœ„ì—ì„œ ë¶€í„° ê° ìœ„ì¹˜ì— í•„ìš”í•œ íŒŒì¼ë“¤ì„ ì¨ë„£ë‹¤. ì´ë ‡ê²Œ ì§ì ‘ ì‘ì„±í•  ìˆ˜ë„ ìˆê³ , ansible-galaxyë¡œ ì´ë¯¸ ëˆ„êµ°ê°€ ë§Œë“¤ì–´ ë‘” ë¡¤ì„ ë°›ì•„ì„œ ì‚¬ìš©ë„ ê°€ëŠ¥í•˜ë‹¤.
```

# handlers/main.yml
- name: Restart nginx
  ansible.builtin.service:
    name: "{{ service_name }}"
    state: restarted

# tasks/main.yml 
# íŒ©íŠ¸ ë³€ìˆ˜ë¡œ ìˆ˜ì§‘ë˜ëŠ” osë¥¼ ê°€ì§€ê³  when ì¡°ê±´ì„ ì‚¬ìš©í•  ê²ƒì´ë¼, íƒœìŠ¤í¬ íŒŒì¼ì„ í”Œë ˆì´ë¶ì— í¬í•¨ì‹œí‚¤ëŠ” ëª¨ë“ˆì„ ì‚¬ìš©
- name: Import playbook
  ansible.builtin.include_tasks:
    file: "{{ ansible_facts.distribution }}.yml"

# ê° osë§ˆë‹¤ index.html ê¸°ë³¸ ê²½ë¡œ ì§€ì •
- name: Copy nginx index file when Ubuntu
  ansible.builtin.template:
    src: index.html
    dest: /var/www/html/index.html
  notify: "Restart nginx"
  when: ansible_facts.distribution == "Ubuntu"

- name: Copy nginx index file when Other OS
  ansible.builtin.template:
    src: index.html
    dest: /var/www/html/index.html
  notify: "Restart nginx"
  when: ansible_facts.distribution in fedora_os

# tasks í•˜ìœ„ì— ê° osë³„ ë§ëŠ” ì„¤ì¹˜íŒ¨í‚¤ì§€ë¡œ yamlíŒŒì¼ì„ ë§Œë“¤ì—ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ìš°ë¶„íˆ¬ì˜ ê²½ìš°ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.
- name: Install nginx using apt
  ansible.builtin.apt:
    name: "{{ package_name }}"
    state: latest

# nginx index.htmlì— ë„£ì„ ë‚´ìš©ì„ templateì— ì‘ì„±í•´ë‘”ë‹¤.
# templates/index.html
test page

# vars/main.yml
package_name : nginx
service_name : nginx
fedora_os:
 - RedHat
 - CentOS
```

ì´ë ‡ê²Œ ì‘ì„±í•´ë‘ê³  role ë””ë ‰í† ë¦¬ ìƒìœ„ì—ì„œ ì‚¬ìš© í•  ìˆ˜ê°€ ìˆë‹¤. roleì˜ ìœ„ì¹˜ê°€ roles/role.nginxì´ì§€ë§Œ, ansible.cfgì—ì„œ roles_path = ./rolesì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ê²½ë¡œë¥¼ ì§€ì •í•´ ë‘˜ ìˆ˜ ìˆë‹¤.
```
- name: test
  hosts: tnode
  pre_tasks:
    - name: Print Start role
      ansible.builtin.debug:
        msg: "Start to install"
  roles:
    - role: role.nginx
  tasks:
    - name: Curl test
      ansible.builtin.uri:
        url: http://tnode1
        return_content: true
      register: curl_result
      notify: Print result
      changed_when: true
  post_tasks:
    - name: Print Finish role
      ansible.builtin.debug:
        msg: "Finish role play"
  handlers:
    - name: Print result
      ansible.builtin.debug:
        msg: "{{ curl_result.content }}"
# ë™ì‘ ìˆœì„œ
# pre_tasks > role > tasks > handler > post_tasks
```

![1-3](/assets/img/a101/3w/1-3.png)
curlë¡œ í˜¸ì¶œí•˜ë©´ roleì„ í†µí•´ ë„£ì—ˆë˜ test pageê°€ ë°˜í™˜ëœë‹¤.
