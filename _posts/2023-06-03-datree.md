---
layout: post
title: aews) datree ì²´í—˜ê¸°
category:
  - study
  - aws
tags:
  - study
  - aws
---


ì´ë²ˆì£¼ì°¨ ê³¼ì œë¥¼ ë­í• ì§€ ë„ì „ê³¼ì œë¥¼ í›‘ì–´ë³´ë‹¤ê°€ ì²˜ìŒ ë³¸ íˆ´ì´ ìˆì–´ ì‚¬ìš©í•´ë´¤ë‹¤. datreeëŠ” kubernetes clusterì˜ ë¦¬ì†ŒìŠ¤ë“¤ì´ ìƒì„±í•˜ê¸°ì— ì˜¤ë¥˜ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ëŠ” ë„êµ¬ì´ë‹¤. [ğŸ”—](https://hub.datree.io/)


# ì„¤ì¹˜

## install datree

```

(eunyoung@myeks:N/A) [root@myeks-bastion ~]# helm repo add datree-webhook https://datreeio.github.io/admission-webhook-datree
(eunyoung@myeks:N/A) [root@myeks-bastion ~]# helm repo update
(eunyoung@myeks:N/A) [root@myeks-bastion ~]# helm install -n datree datree-webhook datree-webhook/datree-admission-webhook --debug \
--create-namespace --set datree.token=$TOKEN
# tokenì€ https://app.datree.io/webhook-instructions ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 


(eunyoung@myeks:N/A) [root@myeks-bastion ~]# k get all -n datree
NAME                                                 READY   STATUS    RESTARTS   AGE
pod/datree-cluster-scanner-server-7bcbd84658-74lch   1/1     Running   0          2m21s
pod/datree-webhook-server-558f65987c-gchlv           1/1     Running   0          2m21s
pod/datree-webhook-server-558f65987c-wfw4n           1/1     Running   0          2m21s

NAME                            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/datree-webhook-server   ClusterIP   10.100.134.248   <none>        443/TCP   2m22s

NAME                                            READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/datree-cluster-scanner-server   1/1     1            1           2m21s
deployment.apps/datree-webhook-server           2/2     2            2           2m21s

NAME                                                       DESIRED   CURRENT   READY   AGE
replicaset.apps/datree-cluster-scanner-server-7bcbd84658   1         1         1       2m21s
replicaset.apps/datree-webhook-server-558f65987c           2         2         2       2m21s

```

scanner-serverëŠ” ê¸°ë³¸ì ìœ¼ë¡œ 1ì‹œê°„ì— í•œë²ˆ clusterë¥¼ ìŠ¤ìº”í•œë‹¤. datree.scanIntervalHours ì˜µì…˜ìœ¼ë¡œ ë³€ê²½ì´ ê°€ëŠ¥í•˜ì§€ë§Œ 1ì‹œê°„ë³´ë‹¤ ì ê²ŒëŠ” ì„¤ì •ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ìˆ˜ë™ìœ¼ë¡œëŠ” ëŒ€ì‹œë³´ë“œì—ì„œ í•˜ê±°ë‚˜ ì•„ë˜ì™€ ê°™ì´ jobì„ ë°°í¬í•˜ì—¬ ê°€ëŠ¥í•˜ë‹¤. [ğŸ”—](https://hub.datree.io/configuration/cluster-scan)

```
kubectl delete jobs/scan-job -n datree; kubectl create job --from=cronjob/scan-cronjob scan-job -n datree
```


datreeì˜ ë™ì‘ë°©ì‹ì€ ì‚¬ìš©ìê°€ kubectlë“± ëª…ë ¹ì–´ë¥¼ ë‚´ë ¤ k8s api-serverë¥¼ í˜¸ì¶œí•˜ëŠ” ì´ë²¤íŠ¸ê°€ ë°œìƒë˜ë©´, api-serverëŠ” datree webhookìœ¼ë¡œ ìš”ì²­í•œë‹¤. ê·¸ëŸ¬ë©´ ì´ì œ ì´ ì‘ì—…ì„ ê²€ì¦ì„í•˜ê²Œë˜ëŠ”ë°, depoloymentë¡œ ë°°í¬ëœ webhook serverì— ì €ì¥ë˜ì–´ ìˆëŠ” policyë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê²€ì¦í•˜ê²Œëœë‹¤. ì´ ë•Œ ê²€ì¦ ê²°ê³¼ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ëŒ€ì‹œë³´ë“œë¡œ ë‚´ë³´ë‚´ê²Œëœë‹¤. [ğŸ”—](https://hub.datree.io/welcome/how-datree-works) ëŒ€ì‹œë³´ë“œëŠ” í´ëŸ¬ìŠ¤í„°ë‚´ì— ë„ìš°ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ datreeì—ì„œ ì œê³µì´ ë˜ì–´ app.datree.ioì— ë¡œê·¸ì¸ í›„ ì‚¬ìš©ê°€ëŠ¥í•˜ë‹¤.

![1-0](/assets/img/aews/6w/1-0.png)


dashboardë¥¼ í™•ì¸í•´ë³´ë©´ action on failureê°€ monitorë¡œ ë˜ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ê¸°ë³¸ìœ¼ë¡œ enforceì„¤ì •ì´ ë¹„í™œì„±í™” ë˜ì–´ìˆì–´ ì •ì±… ê²€ì¦ ì‹œ ì‹¤íŒ¨í–ˆì–´ë„ ê²½ê³ ë§Œí•˜ê³  í´ëŸ¬ìŠ¤í„°ì— ì ìš©ì´ ëœë‹¤. [ğŸ”—](https://hub.datree.io/configuration/output)

![1-1](/assets/img/aews/6w/1-1.png)



## [enable enforce](https://hub.datree.io/configuration/behavior)

```

# datree.enforce: ì •ì±… ê²€ì¦ì— ì‹¤íŒ¨í•œ ë¦¬ì†ŒìŠ¤ëŠ” í´ëŸ¬ìŠ¤í„°ì— ì ìš©ë˜ì§€ ì•Šë„ë¡ ì°¨ë‹¨ (configFromHelm: true ê²½ìš°ë§Œ ì‚¬ìš© ê°€ëŠ¥)
# datree.configFromHelm: dashboardê°€ ì•„ë‹Œ helmchartë¥¼ í†µí•´ì„œ ì˜µì…˜ ê´€ë¦¬í•  ìˆ˜ ìˆìŒ

(eunyoung@myeks:N/A) [root@myeks-bastion ~]# helm upgrade -n datree datree-webhook datree-webhook/datree-admission-webhook \
--set datree.token=$TOKEN --set datree.clusterName=$(kubectl config current-context) \
--set datree.enforce=true --set datree.configFromHelm=true

```

action on failureì˜ ê°’ì´ blockì´ ëœ ê²ƒì„ ëŒ€ì‹œë³´ë“œì—ì„œë„ í™•ì¸í•  ìˆ˜ ìˆìŒ

![1-2](/assets/img/aews/6w/1-2.png)

ìœ„ ìº¡ì²˜ì˜ kubernetes versionì´ ê²€ì¦í•˜ë ¤ëŠ” í´ëŸ¬ìŠ¤í„°ì˜ ë²„ì „ê³¼ ë™ì¼í•´ì•¼í•œë‹¤. ë‹¤ë¥¼ ê²½ìš°, ì¢Œì¸¡ìƒë‹¨ì˜ workspace > settings > default server version ì—ì„œ ë³€ê²½í•  ìˆ˜ ìˆë‹¤. í˜¹ì€ ëª…ë ¹ì–´ë¡œ í™•ì¸ ì‹œ --schema-version ì˜µì…˜ì„ ë¶™ì—¬ ì“¸ ìˆ˜ë„ ìˆë‹¤.



## install datree cli

```

# ëŒ€ì‹œë³´ë“œ ë©”ì¸ì˜ ìš°ì¸¡ </>localì„ í´ë¦­í•˜ì—¬ cli ì„¤ì¹˜
(eunyoung@myeks:N/A) [root@myeks-bastion ~]# curl https://get.datree.io | /bin/bash
(eunyoung@myeks:N/A) [root@myeks-bastion ~]# datree config set token $TOKEN
(eunyoung@myeks:N/A) [root@myeks-bastion ~]# k create deployment test --image=nginx --dry-run=client -oyaml > testdeploy.yaml

# ì´ë ‡ê²Œ ë¨¼ì € í…ŒìŠ¤íŠ¸ í•´ë³¼ ìˆ˜ ìˆë‹¤.
(eunyoung@myeks:N/A) [root@myeks-bastion ~]# datree test testdeploy.yaml

```


# í™•ì¸í•´ë³´ê¸°

## ë°°í¬í•˜ì—¬ í™•ì¸í•´ë³´ê¸°

```

# ìœ„ì—ì„œ ë§Œë“  yaml íŒŒì¼ì„ ë°°í¬í•˜ë ¤í•˜ë©´ policyì— í†µê³¼í•˜ì§€ ëª»í•´ ë¦¬ì†ŒìŠ¤ ìƒì„±ì´ ë˜ì§€ì•ŠëŠ”ë‹¤.
(eunyoung@myeks:N/A) [root@myeks-bastion ~]# datree test testdeploy.yaml
>>  File: testdeploy.yaml

[V] YAML validation
[V] Kubernetes schema validation

[X] Policy check
...
(Summary)

- Passing YAML validation: 1/1

- Passing Kubernetes (v1.24.13-eks-0a21954) schema validation: 1/1

- Passing policy check: 0/1

+-----------------------------------+-----------------------+
| Enabled rules in policy "Starter" | 67                    |
| Configs tested against policy     | 1                     |
| Total rules evaluated             | 67                    |
| Total rules skipped               | 0                     |
| Total rules failed                | 13                    |
| Total rules passed                | 54                    |
| See all rules in policy           | https://app.datree.io |
+-----------------------------------+-----------------------+

# ì•„ë¬´ê²ƒë„ ë°°í¬ë˜ì§€ ì•Šì•˜ë‹¤..
(eunyoung@myeks:N/A) [root@myeks-bastion ~]# k get deployment
No resources found in default namespace.

```

logì—ì„œë„ ì‹¤íŒ¨í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ìˆë‹¤. ë‚´ìš©ì„ ë³´ë©´ policy checkë¥¼ í†µê³¼í•˜ì§€ ëª»í•˜ì˜€ê³ , ì–´ë– í•œ ê·œì¹™ë“¤ì— í†µê³¼ë˜ì§€ ì •ë„ë§Œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![1-3](/assets/img/aews/6w/1-3.png)


## ëŒ€ì‹œë³´ë“œ í™•ì¸í•´ë³´ê¸°


ëŒ€ì‹œë³´ë“œì˜ clusteríƒ­ì„ ë³´ë©´ ì£¼í™©ë°•ìŠ¤ì˜ Cê°€ ìˆë‹¤. datree ìŠ¤ìº”í•˜ë©´ì„œ ì •ì±…ì— í†µê³¼ ëª»í•œ ìˆ˜ì—ë”°ë¼ A-Eë¡œ ë“±ê¸‰ì´ ë§¤ê²¨ì§„ë‹¤. ê·¸ ì•„ë˜ failed rulesì´ë¼ê³  í†µê³¼ë˜ì§€ í•œ ê·œì¹™ë“¤ì´ ìˆë‹¤. ì´ failed ruleì„ í´ë¦­í•˜ê±°ë‚˜ ì¢Œì¸¡ì˜ repairing íƒ­ì— ê°€ë©´ ê° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë³„ë¡œ ì‹¤íŒ¨í•œ ë¦¬ì†ŒìŠ¤ë“¤ì„ í™•ì¸í•  ìˆ˜ë„ ìˆê³ , í•´ê²°ë°©ì•ˆë„ ê°™ì´ ì œì‹œëœë‹¤.

![1-4](/assets/img/aews/6w/1-4.png)


ì´ëŸ°ì‹ìœ¼ë¡œ ê³ ì¹˜ëŠ” ì˜ˆì‹œê°€ ì œì‹œëœë‹¤. ì´ê²ƒì„ ë³´ê³  ë°°í¬ëœ resource yaml í˜•ì‹ì— ë§ì¶° ê³ ì³ì•¼í•œë‹¤. 

![1-5](/assets/img/aews/6w/1-5.png)

ë°°í¬ë˜ì–´ìˆëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ í™•ì¸í•´ë³´ë©´.. 12ê°œì”©ì´ë‚˜ ê·œì¹™ì„ í†µê³¼í•˜ì§€ ëª»í–ˆë‹¤.  

![1-6](/assets/img/aews/6w/1-6.png)


```
+-----------------------------------+-----------------------+
| Enabled rules in policy "Starter" | 67                    |
| Configs tested against policy     | 1                     |
| Total rules evaluated             | 67                    |
| Total rules skipped               | 0                     |
| Total rules failed                | 12                    |
| Total rules passed                | 55                    |
| See all rules in policy           | https://app.datree.io |
+-----------------------------------+-----------------------+
ì¡°ê¸ˆ ê³ ì³ë³´ë©´.. total rules failedì™€ passedì˜ ìˆ«ìê°€ ë³€í•œ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. 
ì´ ê·œì¹™ë“¤ì´ ì–´ë””ì— ìˆëƒë©´, Enabled rules in policy "Starter"
+-----------------------------------+-----------------------+
| Enabled rules in policy "Starter" | 67                    |
| Configs tested against policy     | 1                     |
| Total rules evaluated             | 67                    |
| Total rules skipped               | 0                     |
| Total rules failed                | 9                     |
| Total rules passed                | 58                    |
| See all rules in policy           | https://app.datree.io |
+-----------------------------------+-----------------------+
```


ìœ„ ê·œì¹™ë“¤ì€ ì¢Œì¸¡ì˜ policies ì—ì„œ í™•ì¸ í•  ìˆ˜ ìˆë‹¤. ê¸°ë³¸ìœ¼ë¡œ starterë¼ëŠ” ì •ì±…ì´ ìˆê³  ê·¸ ì•ˆì— ë§ì€ ê·œì¹™ë“¤ì´ ìƒì„±ë˜ì–´ìˆë‹¤.

![1-7](/assets/img/aews/6w/1-7.png)



# nsë³„ policy ë‹¤ë¥´ê²Œ ì ìš©


## policy ìƒì„±

ì •ì±…ì„ ìƒì„±í•˜ë©´ ê¸°ë³¸ì¸ ê·œì¹™ë“¤ì´ ë“¤ì–´ìˆê³ , ë²„íŠ¼ìœ¼ë¡œ í™œì„±/ë¹„í™œì„±í™”ë¥¼ í•  ìˆ˜ ìˆë‹¤. ê·¸ ì¤‘ì—ì„œ eks ê·œì¹™ë§Œ ëª‡ê°œ í™œì„±í™”í•´ì¤¬ë‹¤. [ğŸ”—](https://hub.datree.io/built-in-rules#EKS)

![1-9](/assets/img/aews/6w/1-9.png)


## [multi policies ì ìš©](https://hub.datree.io/configuration/behavior#multiple-policies)

```

# ns=test ê²½ìš°ì—ë§Œ ìƒˆë¡œë§Œë“  testpolicyë¥¼ ì ìš©ë˜ë„ë¡ ì‘ì„±í–ˆë‹¤.
(eunyoung@myeks:N/A) [root@myeks-bastion ~]# cat policy_values.yaml
datree:
  configFromHelm: true
  multiplePolicies:
  - policy: "testpolicy"
    namespaces:
      includePatterns:
      - "test"
  - policy: "Starter"
    namespaces:
      includePatterns:
      - ".*"
      excludePatterns:
      - "test"

(eunyoung@myeks:N/A) [root@myeks-bastion ~]# helm upgrade -n datree datree-webhook datree-webhook/datree-admission-webhook \  
--set datree.token=$TOKEN --set datree.clusterName=$(kubectl config current-context)  \
--set datree.enforce=true --set datree.configFromHelm=true \
-f policy_values.yaml  
Release "datree-webhook" has been upgraded. Happy Helming!
NAME: datree-webhook
LAST DEPLOYED: Fri Jun  2 23:56:35 2023
NAMESPACE: datree
STATUS: deployed
REVISION: 6
TEST SUITE: None

```

ëŒ€ì‹œë³´ë“œì—ì„œë„ active policyì— mulipleë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![1-8](/assets/img/aews/6w/1-8.png)


## í…ŒìŠ¤íŠ¸

```
# test yaml 
(eunyoung@myeks:N/A) [root@myeks-bastion ~]# cat testdeploy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: test
  name: test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: test
    spec:
      containers:
      - image: nginx
        name: nginx
        resources:
          requests:
            memory: 128Mi
          limits:
            memory: 128Mi
        securityContext:
          capabilities:
            add:
            - AUDIT_WRITE
      securityContext:
        seccompProfile:
          type: RuntimeDefault
```

```

# ns ì§€ì •ì—†ì´ ê¸°ë³¸ default nsì— ë°°í¬ì‹œ, Starter policyê°€ ì ìš©ë˜ë©´ì„œ ê²€ì¦ì— ì‹¤íŒ¨í•˜ì—¬ ë°°í¬ë˜ì§€ ëª»í•œë‹¤.
(eunyoung@myeks:N/A) [root@myeks-bastion ~]# k apply -f testdeploy.yaml
Error from server: error when creating "testdeploy.yaml": admission webhook "datree-webhook-server.datree.svc" denied the request:
---
webhook-test-Deployment.tmp.yaml

[V] YAML validation
[V] Kubernetes schema validation

[X] Policy check
...
(Summary)

- Passing YAML validation: 1/1

- Passing Kubernetes (v1.24.13-eks-0a21954) schema validation: 1/1

- Passing policy check: 0/1

+-----------------------------------+-----------------------+
| Enabled rules in policy "Starter" | 59                    |
| Configs tested against policy     | 1                     |
| Total rules evaluated             | 59                    |
| Total rules skipped               | 0                     |
| Total rules failed                | 5                     |
| Total rules passed                | 54                    |
| See all rules in policy           | https://app.datree.io |
+-----------------------------------+-----------------------+


# test nsì— ë°°í¬ ì‹œ ëª¨ë“  ê·œì¹™ì— í†µê³¼ë˜ì—ˆê¸° ë•Œë¬¸ì— ë¬¸ì œì—†ì´ ìƒì„±ëœë‹¤. 
(eunyoung@myeks:N/A) [root@myeks-bastion ~]# k apply -f testdeploy.yaml  -n test
deployment.apps/test created

(eunyoung@myeks:N/A) [root@myeks-bastion ~]# k get all -n test
NAME                        READY   STATUS    RESTARTS   AGE
pod/test-7b87cd799f-d8qv9   1/1     Running   0          3m27s

NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/test   1/1     1            1           3m28s

NAME                              DESIRED   CURRENT   READY   AGE
replicaset.apps/test-7b87cd799f   1         1         1       3m27s

```

ëŒ€ì‹œë³´ë“œ ë¡œê·¸ì—ì„œ ë³¼ ìˆ˜ ìˆê³ , test nsì˜ ë¦¬ì†ŒìŠ¤ì—ëŠ” ë¬¸ì œê°€ ì—†ëŠ” ê²ƒì„ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.

![1-10](/assets/img/aews/6w/1-10.png)

![1-11](/assets/img/aews/6w/1-11.png)



---
ì°¸ê³ 
- [https://hub.datree.io/configuration/behavior#multiple-policies](https://hub.datree.io/configuration/behavior#multiple-policies)
- [https://www.datree.io/resources/eks-best-practices-you-should-know](https://www.datree.io/resources/eks-best-practices-you-should-know)
- [https://www.datree.io/resources/eks-security-best-practices](https://www.datree.io/resources/eks-security-best-practices)
- [https://aws.amazon.com/ko/blogs/containers/preventing-kubernetes-misconfigurations-using-datree/](https://aws.amazon.com/ko/blogs/containers/preventing-kubernetes-misconfigurations-using-datree/)
