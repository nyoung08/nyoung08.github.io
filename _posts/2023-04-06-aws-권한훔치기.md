---
layout: post
title: pkos) awsì—ì„œ ê¶Œí•œ í›”ì¹˜ê¸°
category:
  - study
  - aws
tags:
  - study
  - aws
---


### instance metadata


ì‹¤ìŠµí™˜ê²½ì€ ì–´ëŠ ë•Œì™€ ê°™ì´ kopsë¡œ ë§Œë“  clusterì´ì§€ë§Œ, ì·¨ì•½í•˜ê²Œ ë§Œë“¤ê¸° ìœ„í•˜ì—¬ instanceMetadataì´ í•„ìš”í–ˆë‹¤. ìˆ˜ì •ì— ì•ì„œ ìš°ì„ .. ì¸ìŠ¤í„´ìŠ¤ ë©”íƒ€ë°ì´í„°ê°€ ë­”ì§€ë¶€í„° ì°¾ì•„ë´¤ë‹¤.

ë…ìŠ¤ë¥¼ ë³´ë©´ 'ì¸ìŠ¤í„´ìŠ¤ ë©”íƒ€ë°ì´í„°ëŠ”Â ì‹¤í–‰ ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ êµ¬ì„±í•˜ê±°ë‚˜ ê´€ë¦¬í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•œ ë°ì´í„°ì…ë‹ˆë‹¤'ì´ë¼ê³  ë‚˜ì™€ìˆë‹¤. ì¸ìŠ¤í„´ìŠ¤ì™€ ê´€ë ¨ëœ ëª¨ë“  ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆëŠ” ê²ƒì´ë¼ ë³¼ ìˆ˜ ìˆë‹¤. [ğŸ”—](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)

ì•„ë¬´ëŸ° ì„¤ì • ì—†ì´ ìƒì„±ì„ í•˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ IMDSv2(instance metadata service version2)ë¡œ ì„¤ì •ë˜ì–´ìˆë‹¤. 

ì´ ë•Œ ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ê·¼í•˜ì—¬ ë…ìŠ¤ì˜ ë‚´ìš©ì—ë”°ë¼ 'ì¸ìŠ¤í„´ìŠ¤ ë©”íƒ€ë°ì´í„° ì„œë¹„ìŠ¤(IMDS)ì˜ IPv4 ì£¼ì†Œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤Â 169.254.169.254' ë¡œ í˜¸ì¶œì„ ì‹œë„í•´ë´¤ë‹¤. IMDSv2ì˜ ê²½ìš° ë©”íƒ€ë°ì´í„°ì— ì ‘ê·¼í•˜ë ¤ë©´ ì„¸ì…˜ í† í°ì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— ê¶Œí•œì´ ë¶€ì¡±í•˜ì—¬ 401 ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤. ì´ì™€ ë‹¤ë¥´ê²Œ IMDSv1ì˜ ê²½ìš°ëŠ” ì„¸ì…˜í† í° ì—†ì´ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ìˆë‹¤ê³  í•˜ì—¬ ë³€ê²½ì„ í•´ë³´ì•˜ë‹¤. [ğŸ”—](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html) 

![1-0](/assets/img/pkos/awsinstancemetadata/1-0.png)

 ì½˜ì†”ì—ì„œì˜ ì¸ìŠ¤í„´ìŠ¤ ìš”ì•½ì— ë³´ë©´ IMDSv2: Requiredë¼ê³  ìˆëŠ” ê²ƒì„ 'ì‘ì—…>ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •>Modify instance metadata options'ì— ê°€ì„œ Optionalë¡œ ë³€ê²½í•´ì£¼ì—ˆë‹¤. ì´ ê²½ìš°, v1ê³¼ v2ê°€ ìš”ì²­ì— ë”°ë¼ êµ¬ë¶„ë˜ì–´ ë™ì‘í•œë‹¤. í† í°ì—†ì´ë„ ì‘ë‹µì„ ë°›ì€ ê²ƒì„ ì•„ë˜ì´ë¯¸ì§€ë¡œ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.  

![1-1](/assets/img/pkos/awsinstancemetadata/1-1.png)

ì•ˆì— ë­ê°€ ë“¤ì–´ìˆëŠ”ì§€ í™•ì¸í•´ë³´ë©´ í•´ë‹¹ ì¸ìŠ¤í„´ìŠ¤ì˜ ëª¨ë“  ì •ë³´ë“¤ì´ ë‹´ê²¨ìˆë‹¤. ì´ë¯¸ì§€ë‚˜ í˜¸ìŠ¤íŠ¸ë„¤ì„ì€ ë¬¼ë¡ .. ì¸ìŠ¤í„´ìŠ¤ê°€ ë¬¼ê³ ìˆëŠ” iamì˜ access key, secret key, tokenê¹Œì§€ ëª¨ë‘ í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤. [ğŸ”—](https://docs.aws.amazon.com/ko_kr/snowball/latest/snowcone-guide/imds-code-examples.html)

![1-2](/assets/img/pkos/awsinstancemetadata/1-2.png)



ìœ„ì—ì„œ ì•Œê²Œëœ ê²ƒì„ í† ëŒ€ë¡œ, podì˜ ì¸ìŠ¤í„´ìŠ¤ë©”íƒ€ë°ì´í„°ë¥¼ í†µí•´ í‚¤ë¥¼ ì–»ì–´ aws ë¦¬ì†ŒìŠ¤ì— ëª…ë ¹ì„ ë‚´ë¦¬ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë³´ì•˜ë‹¤. ìš°ì„ , ë³´ì•ˆì„ ì·¨ì•½í•˜ê²Œ ë§Œë“¤ê¸° ìœ„í•´ ìœ„ì—ì„œ ë³¸ ì¸ìŠ¤í„´ìŠ¤ ë©”íƒ€ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë…¸ë“œì—ë§Œ ë³€ê²½í•˜ì˜€ë‹¤. [ğŸ”—]( https://kops.sigs.k8s.io/instance_groups/#instancemetadata)

```
(nyoung:N/A) [root@kops-ec2 ~]# kops edit ig nodes-ap-northeast-2a

...
spec:
  instanceMetadata:
# IMDSv1ìœ¼ë¡œ ë³€ê²½
    httpTokens: optional 
...

(nyoung:N/A) [root@kops-ec2 ~]# kops update cluster --yes && echo && sleep 3 && kops rolling-update cluster --yes
```

ì¸ìŠ¤í„´ìŠ¤ë©”íƒ€ë°ì´í„°ë¥¼ ì–»ì„ íŒŒë“œë¥¼ nicolaka/netshoot ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ê° ë…¸ë“œì— í•˜ë‚˜ì”© ë°°í¬í•œ ë’¤, ê° íŒŒë“œì—ì„œ 169.254.169.254ë¥¼ í˜¸ì¶œí•´ë³´ì•˜ë‹¤. ì–´ë–¤ íŒŒë“œê°€ ìˆ˜ì •ëœ ë…¸ë“œì— ì˜¬ë¼ê°€ìˆëŠ”ì§€.. ì•„ì£¼ ì˜ ë³´ì¸ë‹¤.

```
# ëª…ë ¹ì–´ë¥¼ ì‰½ê²Œ ë‚´ë¦¬ê¸° ìœ„í•´ ê° íŒŒë“œ ì´ë¦„ì„ ë³€ìˆ˜ì²˜ë¦¬í•´ì¤¬ë‹¤.
# PODNAME1=$(kubectl get pod -l app=netshoot-pod -o jsonpath={.items[0].metadata.name})
# PODNAME2=$(kubectl get pod -l app=netshoot-pod -o jsonpath={.items[1].metadata.name})


# ë°˜í™˜ë˜ì§€ ì•ŠëŠ” ê²ƒìœ¼ë¡œ ë³´ì•„, v2ë¥¼ ì‚¬ìš© ì¤‘ì¸ ë…¸ë“œì— ë°°í¬ëœ ê²ƒìœ¼ë¡œ í™•ì¸
(nyoung:N/A) [root@kops-ec2 ~]# kubectl exec -it $PODNAME2 -- curl 169.254.169.254 ;echo

(nyoung:N/A) [root@kops-ec2 ~]# kubectl exec -it $PODNAME1 -- curl 169.254.169.254 ;echo
1.0
2007-01-19
2007-03-01
2007-08-29
2007-10-10
2007-12-15
2008-02-01

# ì•„ë˜ì™€ ê°™ì´ ìê²©ì¦ëª…ì— í•„ìš”í•œ ì •ë³´ë¥¼ ì–»ëŠ”ë‹¤.
(nyoung:N/A) [root@kops-ec2 ~]# k exec -it $PODNAME1 -- curl 169.254.169.254/latest/meta-data/iam/security-credentials/nodes.$KOPS_CLUSTER_NAME | jq
{
  "Code": "Success",
  "LastUpdated": "2023-04-03T14:26:51Z",
  "Type": "AWS-HMAC",
  "AccessKeyId": ACCESSKEYID,
  "SecretAccessKey": SECRETACCESSKEY,
  "Token": TOKEN,
  "Expiration": "2023-04-03T21:02:27Z"
}
```

ë°©ê¸ˆ ì „ ì–»ì€ í‚¤ë¥¼ ì‚¬ìš©í•  íŒŒë“œë¥¼ amazon/aws-cli ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¬ë ¸ë‹¤. ì˜¬ë¦° íŒŒë“œì— ì ‘ì†í›„, íšë“í•œ ì •ë³´ë¥¼ í™˜ê²½ë³€ìˆ˜ì— ë„£ì–´ì„œ ìê²©ì¦ëª…ì— ì‚¬ìš©í–ˆë‹¤. [ğŸ”—](https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/id_credentials_temp_use-resources.html) ìê²© ì¦ëª… í›„, ìœ„ì˜ ê¶Œí•œì„ ì‚¬ìš©í•˜ì—¬ aws ë‚´ì˜ ë¦¬ì†Œì— ì ‘ê·¼í•´ë³´ì•˜ë‹¤. 

í˜„ì¬ ìƒíƒœê°€ runing ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¢…ë£Œí•˜ëŠ” ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì˜€ë‹¤. ì´ ë•Œ ì‚¬ìš©ë˜ëŠ” íŒŒë“œë¡œë¶€í„° í›”ì¹œê¶Œí•œì€ ë…¸ë“œì— ë¶™ì–´ìˆëŠ” iamì´ê¸° ë•Œë¬¸ì—, í•´ë‹¹ iamì´ ê¶Œí•œì´ ìˆì–´ì•¼ ë™ì‘í•œë‹¤.  


ìœ„: aws cli imageë¥¼ ì‚¬ìš©í•œ podì—ì„œ ìê²©ì¦ëª…ì„ í•œ ìƒíƒœ
ì•„ë˜: aws ec2ì˜ ìƒíƒœë¥¼ í™•ì¸

ëª…ë ¹ì–´ë¥¼ ë‚´ë¦¬ê¸° ì „ ì•„ë˜ì°½ì„ í†µí•´ ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì„ì„ í™•ì¸
![1-3](/assets/img/pkos/awsinstancemetadata/1-3.png)

ìœ—ì°½ì—ì„œ ëª…ë ¹ì–´ë¥¼ ë‚´ë¦¬ë©´ ìƒíƒœ ê°’ì— ë‚˜ì˜¤ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸
![1-4](/assets/img/pkos/awsinstancemetadata/1-4.png)

ì½˜ì†”ì—ì„œ ë³´ë©´ ì¢…ë£Œ ì¤‘ì¸ ê²ƒìœ¼ë¡œ í™•ì¸ëœë‹¤.
![1-5](/assets/img/pkos/awsinstancemetadata/1-5.png)


ì´ì—ëŒ€í•œ ëŒ€ì‘ë°©ì•ˆìœ¼ë¡œëŠ” ì¸ìŠ¤í„´ìŠ¤ë©”íƒ€ë°ì´í„°ì— ì‰½ê²Œ ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡ IMDSv2ìœ¼ë¡œ ë²„ì „ìœ¼ë¡œ ì œí•œí•˜ê±°ë‚˜ IRSAì„ ì´ìš©í•˜ì—¬ íŒŒë“œê°€ ë…¸ë“œì˜ iamì„ ê°€ì ¸ê°€ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ saì— ë³„ê°œì˜ iamì„ ì—°ê²°í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ë°©ì•ˆì´ ìˆë‹¤. 

ë‹¤ìŒ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê¸° ìœ„í•´ ìœ„ì—ì„œ ì§„í–‰í–ˆë˜ íŒŒë“œë¥¼ ëª¨ë‘ ì‚­ì œí–ˆë‹¤.



### irsa


kubernetesì˜ saì— awsì˜ iamì„ ì—°ê²°í•˜ëŠ” ë°©ë²•ì´ awsì—ì„œëŠ” IRSA(IAM Role for Service Account)ì„ í†µí•´ êµ¬ì„±ì´ ê°€ëŠ¥í•˜ë‹¤. ì´ ì‘ì—…ì„ ìœ„í•´ì„œëŠ” ì™¸ë¶€ì—ì„œ awsì˜ iamì„ ìê²©ì¦ëª… í•  ìˆ˜ ìˆë„ë¡  openid connect ì„¤ì •ì´ í•„ìš”í•˜ë‹¤. [ğŸ”—](https://openid.net/connect/)
eksì˜ ê²½ìš°ì—ëŠ” í•´ë‹¹ ì‘ì—…ì´ í•„ìš”ì—†ì§€ë§Œ, í…ŒìŠ¤íŠ¸í™˜ê²½ì¸ kops clusterì—ì„œëŠ” cluster specì„ ë³€ê²½í•´ì•¼í•œë‹¤. [ğŸ”—](https://kops.sigs.k8s.io/cluster_spec/#service-account-issuer-discovery-and-aws-iam-roles-for-service-accounts-irsa) [ğŸ”—](https://kops.sigs.k8s.io/addons/#pod-identity-webhook)


```
(nyoung:N/A) [root@kops-ec2 ~]# kops edit cluster

...
spec:
# openid connect providerì˜ ì—”ë“œí¬ì¸íŠ¸ë¡œ public S3 bucketì§€ì • 
# allUsersì— ëŒ€í•´ readê¶Œí•œì´ ì—´ë ¤ìˆì–´ì•¼í•¨
  serviceAccountIssuerDiscovery:
    discoveryStore: s3://nyoung-publicly-readable-store
# openid connect provider í™œì„±í™”
	  enableAWSOIDCProvider: true
  certManager:
    enabled: true
# awsê¶Œí•œìœ¼ë¡œ saì—ì„œ ì—­í• ì„ í•  ìˆ˜ ìˆë„ë¡ í™œì„±í™”
  podIdentityWebhook:
    enabled: true

  iam:
# iamì˜ policy arnê³¼ sa ì‘ì„±
    ServiceAccountExternalPermissions:
    - name: testsa
      aws:
        policyARNs:
        - arn:aws:iam::643127389001:policy/nyoung-test 
# ë§Œì•½ saë§ˆë‹¤ ì •ì±…ì„ ë‹¤ë¥´ê²Œ ê°€ì ¸ê°„ë‹¤ë©´ ì•„ë˜ì— ì¶”ê°€í•´ì£¼ë©´ ëœë‹¤.
#   - name: another-sa
#     ...
...


 (nyoung:N/A) [root@kops-ec2 ~]# kops update cluster --yes && echo && sleep 3 && kops rolling-update cluster --yes
```

ì—…ë°ì´íŠ¸ í›„ì— ì½˜ì†”ì—ì„œ iam > ìê²©ì¦ëª… ê³µê¸‰ìë¥¼ ë³´ë©´, openid connect providerê°€ ìƒì„±ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆê³ , ë²„í‚·ì—ëŠ” ì¸ì¦ì— í•„ìš”í•œ ì •ë³´(openid connect ì˜ êµ¬ì„±ì •ë³´)ê°€ ìƒì„±ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ì¸ì¦ ì‹œì—ëŠ” ë²„í‚·ë‚´ì— ìƒì„±ëœ openid connect configure fileì˜ issuer urlì„ ë”°ë¼ provider ì •ë³´ë¥¼ í™•ì¸í•˜ê³  jwks urië¡œ í† í°ì„ ê°€ì ¸ì™€ ê²€ì¦í•˜ê²Œëœë‹¤.

íŒŒì¼ ë‚´ì— ì´ëŸ°ì‹ìœ¼ë¡œ ì‘ì„±ë˜ì–´ìˆë‹¤.
...
"issuer": "[https://nyoung-publicly-readable-store.s3.ap-northeast-2.amazonaws.com](https://nyoung-publicly-readable-store.s3.ap-northeast-2.amazonaws.com/)",
"jwks_uri": "[https://nyoung-publicly-readable-store.s3.ap-northeast-2.amazonaws.com/openid/v1/jwks](https://nyoung-publicly-readable-store.s3.ap-northeast-2.amazonaws.com/openid/v1/jwks)",
...


![1-6](/assets/img/pkos/awsinstancemetadata/1-6.png)


ê·¸ëŸ¼ ì´ì œ iamê³¼ ì—°ê²°ëœ saë¥¼ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œì„ ì œëŒ€ë¡œ ë¶€ì—¬ë°›ì•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì•˜ë‹¤. 
sa ìƒì„±í•œ ë’¤, amazon/aws-cliì´ë¯¸ì§€ë¡œ ë‘ê°œì˜ íŒŒë“œë¥¼ ìƒì„±í–ˆë‹¤.


![1-7](/assets/img/pkos/awsinstancemetadata/1-7.png)

saë¥¼ ì ìš©í•˜ì§€ ì•Šê³  ê·¸ëƒ¥ nodeì˜ iamì„ ê°€ì ¸ê°€ëŠ” testpoëŠ” s3 ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì§€ë§Œ, s3 ë¦¬ìŠ¤íŠ¸ë¥¼ ë³¼ ìˆ˜ ìˆëŠ” iamì´ ì—°ê²°ëœ saë¥¼ ë¶™ì¸ testpo-saëŠ” í™•ì¸ì´ ê°€ëŠ¥í•˜ë‹¤. 

saê°€ ë¶™ì€ íŒŒë“œ ë‚´ë¶€ë¥¼ ë³´ë©´ í™˜ê²½ë³€ìˆ˜ì™€ ë³¼ë¥¨ì´ ë§ˆìš´íŠ¸ ë˜ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ê°€ ìˆë‹¤.  

```
...
Environment:
      AWS_ROLE_ARN:                 arn:aws:iam::643127389001:role/testsa.default.sa.nyoung.xyz
      AWS_WEB_IDENTITY_TOKEN_FILE:  /var/run/secrets/eks.amazonaws.com/serviceaccount/token
    Mounts:
      /var/run/secrets/eks.amazonaws.com/serviceaccount from aws-iam-token (ro)

Volumes:
  aws-iam-token:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  86400
...
```

ë§Œë“ ì ì—†ëŠ” role arnì´ ë¶™ì–´ìˆì–´ì„œ ì½˜ì†”ì„ í™•ì¸í•´ë´¤ëŠ”ë°.. ìœ„ì—ì„œ podIdentityWebhookì„ í™œì„±í™” í•´ì¤Œìœ¼ë¡œ saê°€ iamì˜ ì •ì±…ê³¼ ì—°ê²°ë˜ë©´ì„œ iamì˜ ì—­í• ì„ ë§Œë“  ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![1-8](/assets/img/pkos/awsinstancemetadata/1-8.png)


ì´ëŸ°ì‹ìœ¼ë¡œ ê° íŒŒë“œì— í•„ìš”í•œ ê¶Œí•œë§Œí¼ë§Œ í• ë‹¹í•˜ëŠ” ê²ƒì´, ë§Œì•½ ë©”íƒ€ë°ì´í„°ê°€ ìœ ì¶œë˜ë”ë¼ë„.. ìµœì†Œí•œì˜ í”¼í•´ë¥¼ ë§‰ì„ ìˆ˜ ìˆëŠ” ë°©ì•ˆìœ¼ë¡œ ë³´ì¸ë‹¤.

 





