---
layout: post
title: kans3) ciliumì— ê´€í•˜ì—¬
category: 
  - study
tags:
  - study
---


# ciliumì— ê´€í•˜ì—¬. ..ğŸ

ì´ë²ˆ ì£¼ì°¨ì˜ ì£¼ì œëŠ” ciliumì´ì˜€ë‹¤. ëª‡ ë…„ ì „ì—ë„ í•´ë‹¹ ì£¼ì œë¥¼ ë“¤ì€ ì ì´ ìˆì—ˆëŠ”ë°, ê·¸ë•Œë³´ë‹¤ ë” ì•Œì•„ë“¤ì€ ê²ƒë„ ìˆì§€ë§Œ ê·¸ë ‡ë‹¤ê³  ì•„ì§ë„ ì´í•´ë¥¼ ì™„ë²½í•˜ê²Œ í–ˆë‹¤ê³  í•  ìˆ˜ëŠ” ì—†ë‹¤.. ì´ë²ˆ ì£¼ì°¨ì— ë“¤ìœ¼ë©´ì„œ ê³µë¶€í•˜ê³  ì•Œê²Œëœ ê²ƒë“¤ì— ëŒ€í•´ ì •ë¦¬í•´ë³´ì•˜ë‹¤.
ciliumì˜ ë“±ì¥ ë°°ê²½ë¶€í„° ì´ì•¼ê¸°í•˜ë©´, ê¸°ì¡´ì˜ ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œì˜ ë„¤íŠ¸ì›Œí¬ í†µì‹ ì€ ëª¨ë‘ user spaceê¹Œì§€ ë“¤ì–´ê°€ì„œ iptablesë¥¼ í†µí•´ì•¼ë§Œ í–ˆë‹¤.  ê·¸ë˜ì„œ ì„¤ì¹˜í•˜ê³  ë³´ë©´, ìˆ˜ë§ì€ iptables ê·œì¹™ì´ ìˆê³  podë¥¼ í•˜ë‚˜ ìƒì„±í•˜ëŠ” ê²ƒì— ë”°ë¼ ìˆ˜ë§ì€ ê·œì¹™ì´ ìƒê¸°ê²Œ ë˜ì—ˆë‹¤. (calico cni ì„¤ì¹˜í•´ì„œ í™•ì¸í•´ë´¤ì„ë–„ì—ëŠ” 120ê°œ ê°€ëŸ‰ì˜ í•„í„°ê°€ ëŠ˜ì—ˆì—ˆìŒ) ë˜ iptables íŠ¹ì„±ìƒ ìœ„ì—ì„œë¶€í„° ì¼ì¹˜í•˜ëŠ” ê·œì¹™ì— íŒ¨í‚·ì„ ì „ë‹¬í•˜ê²Œ ë˜ê¸° ë•Œë¬¸ì— ë³µì¡ë„ê°€ í™• ëŠ˜ì–´ë‚œë‹¤. ê·¸ë˜ì„œ ì´ì „ì— kube-proxyì—ì„œ ipvs proxy modeê°€ ë“±ì¥í•˜ê²Œ ëœ ê²ƒë„ ì´ ë•Œë¬¸ì´ì˜€ê³  kube-proxyë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ebpfë¥¼ ì‚¬ìš©í•˜ëŠ” ciliumë„ ë“±ì¥í•˜ê²Œ ë˜ì—ˆë‹¤.


## ebpf

ebpfëŠ” í™•ì¥ëœ bpf(Berkeley Packet Filter)ë¡œ ë ˆì§€ìŠ¤í„° ë“±ì´ ì¦ê°€í•˜ì—¬ ê¸°ì¡´ì˜ bpfë³´ë‹¤ ì„±ëŠ¥ì´ ì¢‹ì•„ì¡Œë‹¤. [ğŸ”—](https://docs.kernel.org/bpf/classic_vs_extended.html)
bpfëŠ” ì»¤ë„ ì½”ë“œì— í›…ì„ ê±¸ì–´ ë™ì‘í•œë‹¤. ì°¾ì•„ë´¤ì„ ë•Œ, íŒ¨í‚·ì„ ë¶„ì„í•˜ê³  í•„í„°ë§í•˜ê¸° ìœ„í•´ ì„¤ê³„ë˜ì—ˆë˜ ê²ƒì´ê³ , ì»¤ë„ ë‚´ë¶€ì—ì„œ í•˜ë‚˜ì˜ ìƒŒë“œë°•ìŠ¤ì™€ ê°™ì€ í™˜ê²½(in-kernel virtual machine)ì—ì„œ ì‹¤í–‰ëœë‹¤. iptablesëŠ” ê·œì¹™ì— ë”°ë¼ user spaceì—ì„œ íŒ¨í‚·ì„ ì—´ì‹¬íˆ ì²˜ë¦¬í•˜ì§€ë§Œ, bpfëŠ” ì»¤ë„ë ˆë²¨ì—ì„œ ìˆ˜í–‰ë˜ê¸° ë•Œë¬¸ì— ë³´ë‹¤ ë¹ ë¥´ê²Œ íŒ¨í‚·ì´ ì²˜ë¦¬ëœë‹¤.


## cilium

ciliumì€ ë¦¬ëˆ…ìŠ¤ ì»¨í…Œì´ë„ˆ ê´€ë¦¬ í”Œë«í¼ì„ ì‚¬ìš©í•˜ì—¬ ë°°í¬ëœ ì„œë¹„ìŠ¤ ê°„ì˜ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ ì œê³µí•˜ëŠ” ì˜¤í”ˆ ì†ŒìŠ¤ ì†Œí”„íŠ¸ì›¨ì–´ì´ë‹¤. ì»¤ë„ì—ì„œ ë™ì‘í•˜ëŠ” ebpfê¸°ë°˜ì¸ ciliumì€ ëª¨ë“  íŒ¨í‚·ì„ ê°€ë¡œì±„ê¸° ìœ„í•´ ingress tc hooksì„ ì‚¬ìš©í•œë‹¤. [ğŸ”—](https://docs.cilium.io/en/v1.10/concepts/ebpf/intro/) 
tc(traffic control)ì˜ ingress í›…ì— ì—°ê²°ëœ bpfí”„ë¡œê·¸ë¨ì€ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ì™€ ì—°ê²°ë˜ì§€ë§Œ, ë„¤íŠ¸ì›Œí¬ ìŠ¤íƒì´ íŒ¨í‚·ì„ ì´ˆê¸°ì— ì²˜ë¦¬í•œ ì´í›„ ì‹¤í–‰ëœë‹¤. (ì´ˆê¸°ë¼ í•¨ì€.. ì•„ë˜ ê·¸ë¦¼ì—ì„œ ë³´ë©´, l2ë¡œ ì´í•´ í•  ìˆ˜ ìˆë‹¤. l2ë¥¼ ì§€ë‚˜ tc ingressê°€ ìˆìŒ). bpfëŠ” íŒ¨í‚·ì˜ ë©”íƒ€ë°ì´í„°ì—ëŠ” ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— L3ì™€ L4 ì—”ë“œí¬ì¸íŠ¸ ì •ì±…ì„ ì ìš©í•˜ê±°ë‚˜ ë¡œì»¬ ë…¸ë“œì—ì„œ íŠ¸ë˜í”½ì„ íŠ¹ì • ì—”ë“œí¬ì¸íŠ¸ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œí‚¬ ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë‚˜ L7 íŠ¸ë˜í”½ì˜ ê²½ìš°, ë³´ë‹¤ ë³µì¡í•œ ì²˜ë¦¬ë¥¼ ìœ„í•´ envoyì™€ ê°™ì€ í”„ë¡ì‹œê°€ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— ì–´ì©” ìˆ˜ ì—†ì´ iptablesë¥¼ íƒ€ê²Œ ëœë‹¤. ì „ì²´ ì•„í‚¤í…ì²˜ë¥¼ ë³´ë©´ iptables ëŒ€ì‹  ì»¤ë„ì—ì„œ bpf í›…ì„ í†µí•´ íŠ¸ë˜í”½ì„ ì œì–´í•˜ê³ , ê¸°ì¡´ì˜ conntrack í…Œì´ë¸” ëŒ€ì‹  bpf mapì— ê¸°ë¡ì´ ë‚¨ëŠ”ë‹¤. 


![1-1](/assets/img/kans3-2024/w8/1-1.png)

![1-0](/assets/img/kans3-2024/w8/1-0.png)
ì´ë¯¸ì§€ ì¶œì²˜ [ğŸ”—](https://archive.fosdem.org/2020/schedule/event/replacing_iptables_with_ebpf/attachments/slides/3622/export/events/attachments/replacing_iptables_with_ebpf/slides/3622/Cilium_FOSDEM_2020.pdf)


## í…ŒìŠ¤íŠ¸

### ì‹¤ìŠµ í™˜ê²½
í…ŒìŠ¤íŠ¸ í™˜ê²½ì€ ê°€ì‹œë‹¤ë‹˜ì´ ì‘ì„±í•´ë‘” ìŠ¤íƒ íŒŒì¼ì„ ì‚¬ìš©í–ˆë‹¤.

```
â¯ curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/kans/kans-8w.yaml
â¯ aws cloudformation deploy --template-file kans-8w.yaml --stack-name mylab --parameter-overrides KeyName=nyoung SgIngressSshCidr=$(curl -s ipinfo.io/ip)/32 --region ap-northeast-2
â¯ aws cloudformation describe-stacks --stack-name mylab --query 'Stacks[*].Outputs[0].OutputValue' --output text --region ap-northeast-2
43.203.197.16
```

### cilium ì„¤ì¹˜

```
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# helm repo add cilium https://helm.cilium.io/
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# helm repo update
"cilium" has been added to your repositories
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "cilium" chart repository
Update Complete. âˆHappy Helming!âˆ

(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# helm install cilium cilium/cilium --version 1.16.3 --namespace kube-system \
--set k8sServiceHost=192.168.10.10 --set k8sServicePort=6443 --set debug.enabled=true \
--set rollOutCiliumPods=true --set routingMode=native --set autoDirectNodeRoutes=true \
--set bpf.masquerade=true --set bpf.hostRouting=true --set endpointRoutes.enabled=true \
--set ipam.mode=kubernetes --set k8s.requireIPv4PodCIDR=true --set kubeProxyReplacement=true \
--set ipv4NativeRoutingCIDR=192.168.0.0/16 --set installNoConntrackIptablesRules=true \
--set hubble.ui.enabled=true --set hubble.relay.enabled=true --set prometheus.enabled=true --set operator.prometheus.enabled=true --set hubble.metrics.enableOpenMetrics=true \
--set hubble.metrics.enabled="{dns:query;ignoreAAAA,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip\,source_namespace\,source_workload\,destination_ip\,destination_namespace\,destination_workload\,traffic_direction}" \
--set operator.replicas=1 --set ipMasqAgent.enabled=true
NAME: cilium
LAST DEPLOYED: Sun Oct 27 04:33:24 2024
NAMESPACE: kube-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
You have successfully installed Cilium with Hubble Relay and Hubble UI.

# ì„¤ì •í•œ ì˜µì…˜ë“¤ì„ ëª‡ê°€ì§€ ì‚´í´ë³´ìë©´, 
--set k8sServiceHost=192.168.10.10 # ciliumì´ ì—°ê²°í•  controlplane node ip 
--set k8sServicePort=6443 # kubernetes API ì„œë²„ í¬íŠ¸ë¥¼ ì§€ì • (ê¸°ë³¸ í¬íŠ¸ëŠ” 6443).
--set debug.enabled=true # ciliumì˜ ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”
--set rollOutCiliumPods=true # cilium podê°€ ìƒˆ ì„¤ì • ì‹œ ìë™ ì¬ì‹œì‘
--set routingMode=native # ë„¤ì´í‹°ë¸Œ ë¼ìš°íŒ… ëª¨ë“œë¥¼ ì‚¬ìš© (ciliumì—ëŠ” ë„¤ì´í‹°ë¸Œ ë¼ìš°íŒ… ëª¨ë“œì™€ í„°ë„ëª¨ë“œê°€ ì¡´ì¬)
--set autoDirectNodeRoutes=true  # ê° ë…¸ë“œì— ëŒ€í•´ ì§ì ‘ ë¼ìš°íŒ…ì„ í™œì„±í™”
--set bpf.masquerade=true # eBPF ë§ˆìŠ¤ì»¤ë ˆì´ë“œ ì‚¬ìš©. í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ë¡œ ë‚˜ê°ˆ ê²½ìš° snat ì²˜ë¦¬
--set bpf.hostRouting=true # eBPFë¥¼ ì‚¬ìš©í•˜ì—¬ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ë¼ìš°íŒ…ì„ í™œì„±í™”
--set endpointRoutes.enabled=true # ë…¸ë“œì—ì„œ endpoint(pod)ë³„ ë¼ìš°íŠ¸ë¥¼ í™œì„±í™”
--set ipam.mode=kubernetes # kubernetesì—ì„œ ì œê³µí•˜ëŠ” ipamì„ ì‚¬ìš©
--set k8s.requireIPv4PodCIDR=true # podê°€ ipv4 cidr ì‚¬ìš© ê°€ëŠ¥ í•  ë•Œê¹Œì§€ cillium ê¸°ë‹¤ë¦¼
--set kubeProxyReplacement=true # kube-proxyì˜ ê¸°ëŠ¥ì„ ciliumì´ ëŒ€ì²´
--set ipv4NativeRoutingCIDR=192.168.0.0/16 # snatí•˜ì§€ ì•Šì„ ë‚´ë¶€ ì£¼ì†Œ
--set installNoConntrackIptablesRules=true # no-conntrack iptables ê·œì¹™ì„ ì„¤ì¹˜í•˜ì—¬ ì—°ê²° ì¶”ì ì„ ìš°íšŒ
--set hubble.ui.enabled=true # hubble ui í™œì„±í™”(relayë¡œ ìˆ˜ì§‘í•œ ë°ì´í„°ë¥¼ ë³´ê³  ë¶„ì„í•˜ëŠ”ë° ì‚¬ìš©)
--set hubble.relay.enabled=true # hubble relay í™œì„±í™”(ê° nodeì—ì„œ podì— ëŒ€í•œ ë„¤íŠ¸ì›Œí¬ ë¶„ì„ ë°ì´í„° ìˆ˜ì§‘)
--set prometheus.enabled=true # prometheus ëª¨ë‹ˆí„°ë§
--set operator.prometheus.enabled=true # cilium ì˜¤í¼ë ˆì´í„°ì˜ Prometheus ë©”íŠ¸ë¦­ ìˆ˜ì§‘ì„ í™œì„±í™”
--set hubble.metrics.enableOpenMetrics=true # hubble ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í™œì„±í™”
--set hubble.metrics.enabled="{...}" # Hubble ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í•­ëª© ì •ì˜
--set operator.replicas=1 # cilium-operator ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ìš´ì˜
--set ipMasqAgent.enabled=true # ip masquerade agentë¥¼ í™œì„±í™”. í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ë¡œ ë‚˜ê°€ëŠ” íŠ¸ë˜í”½ì˜ ì†ŒìŠ¤ snat
```

ì„¤ì¹˜ í›„ í™•ì¸

```
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# k get ciliumnodes
NAME     CILIUMINTERNALIP   INTERNALIP       AGE
k8s-s    172.16.0.190       192.168.10.10    74m
k8s-w1   172.16.2.107       192.168.10.101   74m
k8s-w2   172.16.1.224       192.168.10.102   74m

(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# k get ciliumendpoints -A
NAMESPACE     NAME                           SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6
kube-system   coredns-55cb58b774-7lsz7       29265               ready            172.16.0.41
kube-system   coredns-55cb58b774-flwn9       29265               ready            172.16.0.7
kube-system   hubble-relay-88f7f89d4-lzwjh   9167                ready            172.16.1.104
kube-system   hubble-ui-59bb4cb67b-7vlmz     35196               ready            172.16.1.230

# bpf ì‚¬ìš©ì„ ìœ„í•´ í™•ì¸ 
# xdp ì§€ì› ë“œë¼ì´ë²„ (https://docs.cilium.io/en/stable/bpf/progtypes/#xdp-drivers)
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# ethtool -i ens5
driver: ena
version: 6.8.0-1015-aws
...

# iptablesë¥¼ í™•ì¸í•´ë³´ë©´ ê¸°ë³¸ ë¦¬ì†ŒìŠ¤ê°€ ë‹¤ ë– ìˆëŠ”ë°ì—ë„ ì—„ì²­ ë§ì´ ì¤„ì–´ë“¤ì—ˆë‹¤.
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# iptables -t nat -S | wc -l
11
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# iptables -t filter -S | wc -l
24
```

cilium cli ì„¤ì¹˜

```
# cilium cli ì„¤ì¹˜
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# CLI_ARCH=amd64
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
cilium-linux-amd64.tar.gz: OK
cilium
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}

# cilium clië¡œ status í™•ì¸
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# cilium status --wait
    /Â¯Â¯\
 /Â¯Â¯\__/Â¯Â¯\    Cilium:             OK
 \__/Â¯Â¯\__/    Operator:           OK
 /Â¯Â¯\__/Â¯Â¯\    Envoy DaemonSet:    OK
 \__/Â¯Â¯\__/    Hubble Relay:       OK
    \__/       ClusterMesh:        disabled
...
    
# cilium ì„¤ì • ê°’ë“¤ì„ í™•ì¸ ê°€ëŠ¥
âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# cilium config view

# cilium pod ë‚´ì˜ cilium agent containerì— ëª…ë ¹ì–´ ì‹¤í–‰ ì „.. ë„ˆë¬´ ê¸°ë‹ˆê¹Œ alias ë“±ë¡
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# alias c0="kubectl exec -it cilium-88nkj -n kube-system -c cilium-agent"

# cilium endpoint ìƒíƒœ, ì„¤ì • í™•ì¸
# í˜„ì¬ ì•„ë¬´ê²ƒë„ ì„¤ì •ë˜ì§€ ì•Šì•„ ëª¨ë‘ Disabledë¡œ í‘œì‹œëœë‹¤. 
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# c0 -- cilium endpoint list
ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS
           ENFORCEMENT        ENFORCEMENT
142        Disabled           Disabled          1          k8s:node-role.kubernetes.io/control-plane                                                          ready
                                                           k8s:node.kubernetes.io/exclude-from-external-load-balancers
                                                           reserved:host
297        Disabled           Disabled          29265      k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          172.16.0.41    ready
                                                           k8s:io.cilium.k8s.policy.cluster=default
                                                           k8s:io.cilium.k8s.policy.serviceaccount=coredns
                                                           k8s:io.kubernetes.pod.namespace=kube-system
                                                           k8s:k8s-app=kube-dns
788        Disabled           Disabled          29265      k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          172.16.0.7     ready
                                                           k8s:io.cilium.k8s.policy.cluster=default
                                                           k8s:io.cilium.k8s.policy.serviceaccount=coredns
                                                           k8s:io.kubernetes.pod.namespace=kube-system
                                                           k8s:k8s-app=kube-dns
3034       Disabled           Disabled          4          reserved:health                                                                     172.16.0.196   ready



# ciliumì´ ê´€ë¦¬í•˜ëŠ” ê° ì—”ë“œí¬ì¸íŠ¸ì˜ ebpf ìƒíƒœ í™•ì¸
# ë‘ë²ˆì§¸ì˜ idëŠ” security idë¡œ ë„¤íŠ¸ì›Œí¬ ì •ì±… ê¸°ë°˜ìœ¼ë¡œ íŠ¸ë˜í”½ ì œì–´ ì‹œ ì‚¬ìš©ëœë‹¤.
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# c0 -- cilium bpf endpoint list
IP ADDRESS        LOCAL ENDPOINT INFO
172.16.0.196:0    id=3034  sec_id=4     flags=0x0000 ifindex=12  mac=6A:E3:6A:FF:33:E0 nodemac=7E:64:F3:57:23:7D
172.16.0.190:0    (localhost)
172.16.0.7:0      id=788   sec_id=29265 flags=0x0000 ifindex=10  mac=AE:FA:30:78:0C:F9 nodemac=6E:A4:DB:E4:9A:46
192.168.10.10:0   (localhost)
172.16.0.41:0     id=297   sec_id=29265 flags=0x0000 ifindex=8   mac=D6:BB:72:3B:80:C5 nodemac=26:59:D7:B7:99:68
```

192.168.10.10:0   (localhost) > podê°€ ì˜¬ë¼ê°€ ìˆëŠ” node ip 
172.16.0.190:0    (localhost) > ì´ê²Œ ëˆ„êµ¬ì¸ì§€ ì°¾ì•„ê°€ë³´ë©´ . .

ë…¸ë“œì—ì„œ ipë¥¼ í™•ì¸í•´ë³´ë©´, 172.16.0.190:0 ì€ cilium_host interfaceë‹¤.

ciliumì—ì„œëŠ” veth pairë¡œ ì»¨í…Œì´ë„ˆ ë„¤íŠ¸ì›Œí¬ë¥¼ êµ¬í˜„ë˜ì–´ì„œ proxy arpë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. ë°”ë¡œ ì„œë¡œì—ê²Œ ì „ë‹¬ë˜ì–´, ipë¥¼ ê°€ì§€ê³  ëˆ„êµ¬ëƒê³  ë¬»ëŠ” ê³¼ì •ì´ ìƒëµë˜ì–´ ë¹ ë¥´ë‹¤. ê·¸ë¦¬ê³  proxy arpë„ ì‚¬ìš©í•˜ì§€ ì•Šì•„ ë³´ì•ˆì ìœ¼ë¡œë„ ìœ„í—˜ ìš”ì†Œê°€ ì‚¬ë¼ì§„ë‹¤.

```
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# ip -c a
...
3: cilium_net@cilium_host: <BROADCAST,MULTICAST,NOARP,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default qlen 1000
    link/ether 0a:9f:d1:0d:f9:36 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::89f:d1ff:fe0d:f936/64 scope link
       valid_lft forever preferred_lft forever
4: cilium_host@cilium_net: <BROADCAST,MULTICAST,NOARP,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default qlen 1000
    link/ether 0a:e0:e2:dc:52:d7 brd ff:ff:ff:ff:ff:ff
    inet 172.16.0.190/32 scope global cilium_host
       valid_lft forever preferred_lft forever
    inet6 fe80::8e0:e2ff:fedc:52d7/64 scope link
       valid_lft forever preferred_lft forever
...

(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# cat /proc/sys/net/ipv4/conf/cilium_net/proxy_arp
0
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# cat /proc/sys/net/ipv4/conf/cilium_host/proxy_arp
0
```


hubble web ui ë“¤ì–´ê°€ê¸° ìœ„í•´ nodeportë¡œ ë³€ê²½

```
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# kubectl patch -n kube-system svc hubble-ui -p '{"spec": {"type": "NodePort"}}'
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# HubbleUiNodePort=$(kubectl get svc -n kube-system hubble-ui -o jsonpath={.spec.ports[0].nodePort})
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# echo -e "Hubble UI URL = http://$(curl -s ipinfo.io/ip):$HubbleUiNodePort"
service/hubble-ui patched
Hubble UI URL = http://43.203.197.16:30389

# hubble client ì„¤ì¹˜
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# HUBBLE_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/hubble/master/stable.txt)
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# HUBBLE_ARCH=amd64
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# if [ "$(uname -m)" = "aarch64" ]; then HUBBLE_ARCH=arm64; fi
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# curl -L --fail --remote-name-all https://github.com/cilium/hubble/releases/download/$HUBBLE_VERSION/hubble-linux-${HUBBLE_ARCH}.tar.gz{,.sha256sum}
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# sha256sum --check hubble-linux-${HUBBLE_ARCH}.tar.gz.sha256sum
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# sudo tar xzvfC hubble-linux-${HUBBLE_ARCH}.tar.gz /usr/local/bin
hubble-linux-amd64.tar.gz: OK
hubble
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# rm hubble-linux-${HUBBLE_ARCH}.tar.gz{,.sha256sum}

# web uië¡œ ì ‘ê·¼ í•  ìˆ˜ ìˆê²Œ í¬íŠ¸í¬ì›Œë”© ì‹¤í–‰
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# cilium hubble port-forward &
[1] 24466
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# hubble status
Healthcheck (via localhost:4245): Ok
Current/Max Flows: 12,285/12,285 (100.00%)
Flows/s: 39.22
Connected Nodes: 3/3
```

![2-0](/assets/img/kans3-2024/w8/2-0.png)


### í…ŒìŠ¤íŠ¸

```
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# cat testpod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: netpod
  labels:
    app: netpod
spec:
  nodeName: k8s-s
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod1
  labels:
    app: webpod
spec:
  nodeName: k8s-w1
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0
---
apiVersion: v1
kind: Pod
metadata:
  name: webpod2
  labels:
    app: webpod
spec:
  nodeName: k8s-w2
  containers:
  - name: container
    image: traefik/whoami
  terminationGracePeriodSeconds: 0

(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# k apply -f testpod.yaml
pod/netpod created
pod/webpod1 created
pod/webpod2 created

(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# k get po -owide
NAME      READY   STATUS    RESTARTS   AGE   IP             NODE     NOMINATED NODE   READINESS GATES
netpod    1/1     Running   0          99s   172.16.0.251   k8s-s    <none>           <none>
webpod1   1/1     Running   0          99s   172.16.2.139   k8s-w1   <none>           <none>
webpod2   1/1     Running   0          99s   172.16.1.235   k8s-w2   <none>           <none>

(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# kubectl get ciliumendpoints -A
NAMESPACE     NAME                           SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6
default       netpod                         11370               ready            172.16.0.251
default       webpod1                        19520               ready            172.16.2.139
default       webpod2                        19520               ready            172.16.1.235
kube-system   coredns-55cb58b774-7lsz7       29265               ready            172.16.0.41
kube-system   coredns-55cb58b774-flwn9       29265               ready            172.16.0.7
kube-system   hubble-relay-88f7f89d4-lzwjh   9167                ready            172.16.1.104
kube-system   hubble-ui-59bb4cb67b-7vlmz     35196               ready            172.16.1.230

# c0ì€ k8s-s ë…¸ë“œì— ìœ„ì¹˜í•˜ê³  ìˆì–´ì„œ, í•´ë‹¹ ë…¸ë“œì— ìœ„ì¹˜í•œ netpodì˜ ip endpointê°€ í™•ì¸
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# c0 -- cilium bpf endpoint list
IP ADDRESS        LOCAL ENDPOINT INFO
172.16.0.196:0    id=3034  sec_id=4     flags=0x0000 ifindex=12  mac=6A:E3:6A:FF:33:E0 nodemac=7E:64:F3:57:23:7D
172.16.0.190:0    (localhost)
172.16.0.7:0      id=788   sec_id=29265 flags=0x0000 ifindex=10  mac=AE:FA:30:78:0C:F9 nodemac=6E:A4:DB:E4:9A:46
172.16.0.251:0    id=663   sec_id=11370 flags=0x0000 ifindex=14  mac=12:52:E3:7E:87:4F nodemac=2E:E6:8A:A2:06:1E
192.168.10.10:0   (localhost)
172.16.0.41:0     id=297   sec_id=29265 flags=0x0000 ifindex=8   mac=D6:BB:72:3B:80:C5 nodemac=26:59:D7:B7:99:68


# alias ì§€ì •
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# NETPODIP=$(kubectl get pods netpod -o jsonpath='{.status.podIP}')
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# WEBPOD1IP=$(kubectl get pods webpod1 -o jsonpath='{.status.podIP}')
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# WEBPOD2IP=$(kubectl get pods webpod2 -o jsonpath='{.status.podIP}')
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# alias p0="kubectl exec -it netpod  -- "
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# alias p1="kubectl exec -it webpod1 -- "
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# alias p2="kubectl exec -it webpod2 -- "

# netpodì—ì„œ webpod1,webpod2ë¡œ í˜¸ì¶œ
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# p0 ping -c 1 $WEBPOD1IP && p0 ping -c 1 $WEBPOD2IP
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# p0 curl -s $WEBPOD1IP && p0 curl -s $WEBPOD2IP
```

![3-0](/assets/img/kans3-2024/w8/3-0.png)

```
# hubble clië¡œ í™•ì¸
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# hubble observe --pod netpod
Oct 26 23:27:40.843: default/netpod:54492 (ID:11370) <> default/webpod1 (ID:19520) pre-xlate-rev TRACED (TCP)
Oct 26 23:27:40.844: default/netpod:54492 (ID:11370) <> default/webpod1 (ID:19520) pre-xlate-rev TRACED (TCP)
Oct 26 23:27:40.844: default/netpod:54492 (ID:11370) <> default/webpod1 (ID:19520) pre-xlate-rev TRACED (TCP)
Oct 26 23:27:40.844: default/netpod:54492 (ID:11370) <- default/webpod1:80 (ID:19520) to-network FORWARDED (TCP Flags: ACK, PSH)
Oct 26 23:27:40.844: default/netpod:54492 (ID:11370) -> default/webpod1:80 (ID:19520) to-endpoint FORWARDED (TCP Flags: ACK, FIN)
Oct 26 23:27:40.844: default/netpod:54492 (ID:11370) <- default/webpod1:80 (ID:19520) to-network FORWARDED (TCP Flags: ACK, FIN)
Oct 26 23:27:40.845: default/netpod:54492 (ID:11370) -> default/webpod1:80 (ID:19520) to-endpoint FORWARDED (TCP Flags: ACK)
Oct 26 23:28:19.003: default/netpod:47616 (ID:11370) <> default/webpod2 (ID:19520) pre-xlate-rev TRACED (TCP)
Oct 26 23:28:19.003: default/netpod:47616 (ID:11370) <> default/webpod2 (ID:19520) pre-xlate-rev TRACED (TCP)
Oct 26 23:28:19.003: default/netpod:47616 (ID:11370) <> default/webpod2 (ID:19520) pre-xlate-rev TRACED (TCP)
Oct 26 23:28:19.003: default/netpod:47616 (ID:11370) <- default/webpod2:80 (ID:19520) to-network FORWARDED (TCP Flags: ACK, PSH)
Oct 26 23:28:19.003: default/netpod:47616 (ID:11370) <- default/webpod2:80 (ID:19520) to-endpoint FORWARDED (TCP Flags: ACK, PSH)
Oct 26 23:28:19.004: default/netpod:47616 (ID:11370) -> default/webpod2:80 (ID:19520) to-network FORWARDED (TCP Flags: ACK, FIN)
Oct 26 23:28:19.004: default/netpod:47616 (ID:11370) -> default/webpod2:80 (ID:19520) to-endpoint FORWARDED (TCP Flags: ACK, FIN)
...

# WEBPOD1ì— ëŒ€í•œ cacheê°€ ë‚¨ì•„ìˆìŒ
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# c0 -- cilium map get cilium_ipcache | grep $WEBPOD1IP
172.16.2.139/32     identity=19520 encryptkey=0 tunnelendpoint=192.168.10.101, flags=<none>   sync


# bpftoolë¡œ ebpfì—
# lxcb50b1869cfd2ì€ ip a ëª…ë ¹ì–´ ì‹¤í–‰ ì‹œ ê°€ì¥ í•˜ìœ„ì— ìƒê¸´ interface
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# c0 -- bpftool net show | grep lxcb50b1869cfd2
lxcb50b1869cfd2(14) tcx/ingress cil_from_container prog_id 1361 link_id 27
lxcb50b1869cfd2(14) tcx/egress cil_to_container prog_id 1356 link_id 28

(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# c0 -- bpftool prog show id 1361
1361: sched_cls  name cil_from_container  tag f4a78938bf290167  gpl
	loaded_at 2024-10-26T23:11:00+0000  uid 0
	xlated 728B  jited 545B  memlock 4096B  map_ids 187,66
	btf_id 381
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# c0 -- bpftool prog show id 1356
1356: sched_cls  name cil_to_container  tag 2c1290820dba04eb  gpl
	loaded_at 2024-10-26T23:11:00+0000  uid 0
	xlated 1712B  jited 1015B  memlock 4096B  map_ids 66,187
	btf_id 376
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# c0 -- bpftool map list
66: percpu_hash  name cilium_metrics  flags 0x1
	key 8B  value 16B  max_entries 1024  memlock 19384B
187: prog_array  name cilium_calls_00  flags 0x0
	key 4B  value 4B  max_entries 50  memlock 720B
	owner_prog_type sched_cls  owner jited
...
```
ip ì£¼ì†Œë„ ì—†ëŠ” lxcì–´ì©Œê³ ê°€ ì–´ë–»ê²Œ í†µì‹ ì„ í•˜ëŠ” ê²ƒì¼ê¹Œ.. ì´ê²ƒì— ëŒ€í•´ì„œëŠ” ê°€ì¥ ë°‘ì—ì„œ ì“°ê² ë‹¤.


### pod > pod 

netpod > svc > webpod1,webpod2

```
# svc ìƒì„±
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# cat <<EOF | kubectl create -f -
apiVersion: v1
kind: Service
metadata:
  name: svc
spec:
  ports:
    - name: svc-webport
      port: 80
      targetPort: 80
  selector:
    app: webpod
  type: ClusterIP
EOF
service/svc created

(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# k get svc
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.10.0.1       <none>        443/TCP   7h22m
svc          ClusterIP   10.10.249.114   <none>        80/TCP    39s

(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# kubectl exec netpod -- curl -s   10.10.249.114 | grep Hostname
Hostname: webpod2


# whileë¬¸ìœ¼ë¡œ ê³„ì† curlì„ ë‚ ë¦¬ê³  netpodì—ì„œ í™•ì¸
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# while true; do kubectl exec netpod -- curl -s  10.10.249.114| grep Hostname;echo "-----";sleep 1;done

# netpodì—ì„œ íŒ¨í‚·ì„ ë– ë³´ë©´, svc ipë¥¼ í™•ì¸ í•  ìˆ˜ ì—†ë‹¤. 
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# kubectl exec netpod -- tcpdump -enni any -q
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
23:43:19.043325 eth0  Out ifindex 13 12:52:e3:7e:87:4f 172.16.0.251.37352 > 172.16.1.235.80: tcp 0
23:43:19.043605 eth0  In  ifindex 13 2e:e6:8a:a2:06:1e 172.16.1.235.80 > 172.16.0.251.37352: tcp 0
23:43:19.043649 eth0  Out ifindex 13 12:52:e3:7e:87:4f 172.16.0.251.37352 > 172.16.1.235.80: tcp 0
23:43:19.043767 eth0  Out ifindex 13 12:52:e3:7e:87:4f 172.16.0.251.37352 > 172.16.1.235.80: tcp 76
23:43:19.043887 eth0  In  ifindex 13 2e:e6:8a:a2:06:1e 172.16.1.235.80 > 172.16.0.251.37352: tcp 0
23:43:19.044556 eth0  In  ifindex 13 2e:e6:8a:a2:06:1e 172.16.1.235.80 > 172.16.0.251.37352: tcp 312

# ìœ„ì—ì„œ ëª©ì ì§€ë¡œ ì°íˆëŠ” ipë¥¼ í™•ì¸í•´ë³´ë©´, webpod2..!
# podë¥¼ ë‚˜ê°€ê¸°ë„ ì „ì— ì´ë¯¸ dnatì´ ë˜ì–´ì„œ ë°”ë¡œ ëª©ì ì§€ pod ipë¥¼ ì°ê³  ê°€ê²Œëœë‹¤.
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# k get po -owide
NAME      READY   STATUS    RESTARTS   AGE   IP             NODE     NOMINATED NODE   READINESS GATES
netpod    1/1     Running   0          34m   172.16.0.251   k8s-s    <none>           <none>
webpod1   1/1     Running   0          34m   172.16.2.139   k8s-w1   <none>           <none>
webpod2   1/1     Running   0          34m   172.16.1.235   k8s-w2   <none>           <none>

# ciliumì—ì„œ ê´€ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# c0 -- cilium service list
ID   Frontend              Service Type   Backend
...
9    10.10.249.114:80      ClusterIP      1 => 172.16.2.139:80 (active)
                                          2 => 172.16.1.235:80 (active)
                                          
# cilium bpfì—ì„œ ê´€ë¦¬í•˜ëŠ” lb ëª©ë¡ 
(âˆ|kubernetes-admin@kubernetes:N/A) root@k8s-s:~# c0 -- cilium bpf lb list | grep 10.10.249.114
10.10.249.114:80 (0)      0.0.0.0:0 (9) (0) [ClusterIP, non-routable]
10.10.249.114:80 (2)      172.16.1.235:80 (9) (2)
10.10.249.114:80 (1)      172.16.2.139:80 (9) (1)
```

### arp ë™ì‘ ì‹œ, bpf ë”°ë¼ê°€ë³´ê¸° 

í™•ì¸í•œ íŒŒì¼ì€ ì•„ë˜ ë‘ íŒŒì¼ 
- [bpf_lxc.c](https://github.com/cilium/cilium/blob/main/bpf/bpf_lxc.c)
- [arp.h](https://github.com/cilium/cilium/blob/main/bpf/lib/arp.h)

```
# ARP ìš”ì²­ ê°ì§€ (bpf_lxc.c ìœ„ì¹˜)
# ë¨¼ì € handle_xgress í•¨ìˆ˜ì—ì„œ ARP íŒ¨í‚·ì„ ê°ì§€í•˜ê³  CILIUM_CALL_ARPë¡œ tail callì„ ìˆ˜í–‰í•˜ë©° í•´ë‹¹ í•¨ìˆ˜ëŠ” ì¢…ë£Œëœë‹¤.
__section_entry
int cil_from_container(struct __ctx_buff *ctx)
{
	__u16 proto;
	__u32 sec_label = SECLABEL;
	__s8 ext_err = 0;
	int ret;

	bpf_clear_meta(ctx);
	ctx->queue_mapping = 0;

	send_trace_notify(ctx, TRACE_FROM_LXC, sec_label, UNKNOWN_ID,
			  TRACE_EP_ID_UNKNOWN, TRACE_IFINDEX_UNKNOWN,
			  TRACE_REASON_UNKNOWN, TRACE_PAYLOAD_LEN);

	if (!validate_ethertype(ctx, &proto)) {
		ret = DROP_UNSUPPORTED_L2;
		goto out;
	}

	switch (proto) {
#elif defined(ENABLE_ARP_RESPONDER)
	case bpf_htons(ETH_P_ARP):
		ret = tail_call_internal(ctx, CILIUM_CALL_ARP, &ext_err);
		break;

	default:
		ret = DROP_UNKNOWN_L3;
	}


# ARP ìš”ì²­ ê²€ì¦ (bpf_lxc.c ìœ„ì¹˜)
# __section_tailì—ì„œ CILIUM_CALL_ARPì„ ë”°ë¼ê°€ì„œ í•¨ìˆ˜ í™•ì¸
# ipv4 gwì™€ node macì£¼ì†Œë¥¼ arp ì‘ë‹µìœ¼ë¡œ ë³´ë‚¸ë‹¤

# ì›ë˜ëŠ” lxc ipë‘ ëª©ì ì§€ê°€ ê°™ìœ¼ë©´ ì‘ë‹µ ì•ˆí•˜ëŠ”ë°, 
# ì—¬ê¸°ì„œ lxcì—ëŠ” ipê°€ ì—†ìœ¼ë‹ˆê¹Œ macì£¼ì†Œë‚˜ ë‹¤ë¥¸ í•„ë“œì— ëŒ€í•´ì„œ ìœ íš¨ì„± ê²€ì‚¬í•œë‹¤.
# ëª¨ë“  ì¡°ê±´ì´ ì¶©ì¡±ë˜ì–´ arp_respondë¡œ í–¥í•œë‹¤.

__section_tail(CILIUM_MAP_CALLS, CILIUM_CALL_ARP)
int tail_handle_arp(struct __ctx_buff *ctx)
{
	union macaddr mac = THIS_INTERFACE_MAC;
	union macaddr smac;
	__be32 sip;
	__be32 tip;

	if (!arp_validate(ctx, &mac, &smac, &sip, &tip))
		return CTX_ACT_OK;

	if (tip == LXC_IPV4)
		return CTX_ACT_OK;

	return arp_respond(ctx, &mac, tip, &smac, sip, 0);
}


# ARP ì‘ë‹µ ì¤€ë¹„ ë° ì „ì†¡ (arp.h ì— ìœ„ì¹˜)
# arp_prepare_response í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬, ìœ„ì—ì„œ ë¦¬í„´ë°›ì€ ê°’ë“¤ì„ ë„£ì–´ ì‘ë‹µ íŒ¨í‚·ì„ êµ¬ì„±
# ì¤€ë¹„ë˜ë©´ ctx_redirectë¥¼ í†µí•´ íŒ¨í‚·ì„ ë¦¬ë‹¤ì´ë ‰íŠ¸
static __always_inline int
arp_respond(struct __ctx_buff *ctx, union macaddr *smac, __be32 sip,
	    union macaddr *dmac, __be32 tip, int direction)
{
	int ret = arp_prepare_response(ctx, smac, sip, dmac, tip);

	if (unlikely(ret != 0))
		goto error;

	cilium_dbg_capture(ctx, DBG_CAPTURE_DELIVERY,
			   ctx_get_ifindex(ctx));
	return ctx_redirect(ctx, ctx_get_ifindex(ctx), direction);

error:
	return send_drop_notify_error(ctx, UNKNOWN_ID, ret, CTX_ACT_DROP, METRIC_EGRESS);
}


# ARP ì‘ë‹µ ì¤€ë¹„ (arp.h ì— ìœ„ì¹˜)
# ìœ„ì—ì„œ ARP ì‘ë‹µ ì¤€ë¹„ í•  ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
static __always_inline int
arp_prepare_response(struct __ctx_buff *ctx, union macaddr *smac, __be32 sip,
		     union macaddr *dmac, __be32 tip)
{
	__be16 arpop = bpf_htons(ARPOP_REPLY);

	if (eth_store_saddr(ctx, smac->addr, 0) < 0 ||
	    eth_store_daddr(ctx, dmac->addr, 0) < 0 ||
	    ctx_store_bytes(ctx, 20, &arpop, sizeof(arpop), 0) < 0 ||
	    /* sizeof(macadrr)=8 because of padding, use ETH_ALEN instead */
	    ctx_store_bytes(ctx, 22, smac, ETH_ALEN, 0) < 0 ||
	    ctx_store_bytes(ctx, 28, &sip, sizeof(sip), 0) < 0 ||
	    ctx_store_bytes(ctx, 32, dmac, ETH_ALEN, 0) < 0 ||
	    ctx_store_bytes(ctx, 38, &tip, sizeof(tip), 0) < 0)
		return DROP_WRITE_ERROR;

	return 0;
}

```



