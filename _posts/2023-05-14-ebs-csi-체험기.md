---
layout: post
title: aews) ebs csi ì²´í—˜ê¸°
category:
  - study
  - aws
tags:
  - study
  - aws
---

3ì£¼ì°¨ ìŠ¤í„°ë”” ë‚´ìš©ì€ ebs controllerë¥¼ í†µí•´ pvì™€ pvcì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ê³µë¶€í–ˆë‹¤.
ebs controller ì‚¬ìš©ì„ ìœ„í•´ì„  csiì„¤ì¹˜ê°€ í•„ìš”í•˜ë‹¤. eks ìƒì„±ì‹œ ë§Œë“¤ì–´ì§€ëŠ” ìŠ¤í† ë¦¬ì§€ ë“œë¼ì´ë²„ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì— ìˆëŠ” aws ebs ìŠ¤í† ë¦¬ì§€ë¥¼ ì‚¬ìš© í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ê²ƒì´ë‹¤. [ğŸ”—](https://aws.amazon.com/ko/blogs/containers/amazon-ebs-csi-driver-is-now-generally-available-in-amazon-eks-add-ons/)

```
# defaultë¡œ ìˆëŠ” scë¥¼ í™•ì¸í•´ë³´ë©´ Provisionerê°€ kubernetes.io/aws-ebsë¡œ ë˜ì–´ìˆë‹¤.
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# k describe sc gp2
Name:            gp2
IsDefaultClass:  Yes
Annotations:     kubectl.kubernetes.io/last-applied-configuration={"apiVersion":"storage.k8s.io/v1","kind":"StorageClass","metadata":{"annotations":{"storageclass.kubernetes.io/is-default-class":"true"},"name":"gp2"},"parameters":{"fsType":"ext4","type":"gp2"},"provisioner":"kubernetes.io/aws-ebs","volumeBindingMode":"WaitForFirstConsumer"}
,storageclass.kubernetes.io/is-default-class=true
Provisioner:           kubernetes.io/aws-ebs
Parameters:            fsType=ext4,type=gp2
AllowVolumeExpansion:  <unset>
MountOptions:          <none>
ReclaimPolicy:         Delete
VolumeBindingMode:     WaitForFirstConsumer
```


# ebs csi ì„¤ì¹˜

1. ë¨¼ì € ebsë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ csi driverì—ê²Œ ê¶Œí•œì´ í• ë‹¹ë˜ì–´ì•¼í•œë‹¤. irsaë¥¼ ì‚¬ìš©í•˜ì—¬ saì™€ iamê¶Œí•œì„ ì—°ê²°í•´ì¤€ë‹¤. awsì—ì„œ ê´€ë¦¬í•˜ëŠ” ì •ì±…ì„ ì—°ê²°í•  ê²ƒì´ê¸°ë•Œë¬¸ì— ë”°ë¡œ ë§Œë“¤ì§€ ì•Šì•„ë„ ëœë‹¤.

```
# irsa ì„¤ì • (ì´ë¦„ì€ ë™ì¼í•´ì•¼í•œë‹¤)
eksctl create iamserviceaccount \
  --name ebs-csi-controller-sa \
  --namespace kube-system \
  --cluster ${CLUSTER_NAME} \
  --attach-policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy \
  --approve \
  --role-only \
  --role-name AmazonEKS_EBS_CSI_DriverRole

# í™•ì¸
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# eksctl get iamserviceaccount ebs-csi-controller-sa --cluster myeks
NAMESPACE	NAME			ROLE ARN
kube-system	ebs-csi-controller-sa	arn:aws:iam::643127389001:role/AmazonEKS_EBS_CSI_DriverRole

```

2. ebs csi driver addon

```
eksctl create addon --name aws-ebs-csi-driver --cluster ${CLUSTER_NAME} --service-account-role-arn arn:aws:iam::${ARN}:role/AmazonEKS_EBS_CSI_DriverRole --force

# ë°°í¬ëœ ë¦¬ì†ŒìŠ¤ í™•ì¸
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# kubectl get deploy,ds -l=app.kubernetes.io/name=aws-ebs-csi-driver -n kube-system
NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/ebs-csi-controller   2/2     2            2           11m

NAME                                  DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR              AGE
daemonset.apps/ebs-csi-node           3         3         3       3            3           kubernetes.io/os=linux     11m
daemonset.apps/ebs-csi-node-windows   0         0         0       0            0           kubernetes.io/os=windows   11m

# íŒŒë“œì•ˆì— ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆê°€ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. í™•ì¸ì¸í•´ë³´ë©´ provisioner, attacher, snapshotter ë“± ê° ê¸°ëŠ¥ë“¤ì´ ì»¨í…Œì´ë„ˆë¡œ ë“¤ì–´ê°€ ìˆë‹¤.
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# kubectl get pod -n kube-system -l app.kubernetes.io/name=aws-ebs-csi-driver
NAME                                  READY   STATUS    RESTARTS   AGE
ebs-csi-controller-67658f895c-7dj8c   6/6     Running   0          25m
ebs-csi-controller-67658f895c-9wjps   6/6     Running   0          25m
ebs-csi-node-7lcnl                    3/3     Running   0          25m
ebs-csi-node-fzn9d                    3/3     Running   0          25m
ebs-csi-node-pxrvt                    3/3     Running   0          25m


# csiê°€ ì„¤ì¹˜ëœ ë…¸ë“œë“¤ë„ í™•ì¸í•´ë³´ì
# spec.driversì•„ë˜ ë³´ë©´ ì„¤ì¹˜ëœ driverì™€ ê·¸ ì•„ë˜, allocatablesì—ì„œ ë…¸ë“œë‹¹ ìµœëŒ€ ì—°ê²°í•  ìˆ˜ ìˆëŠ” ë³¼ë¥¨ì„ (ebsë¥¼)í™•ì¸í•  ìˆ˜ ìˆë‹¤.
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# kubectl describe csinodes
Name:               ip-192-168-1-58.ap-northeast-2.compute.internal
Labels:             <none>
Annotations:        storage.alpha.kubernetes.io/migrated-plugins:
                      kubernetes.io/aws-ebs,kubernetes.io/azure-disk,kubernetes.io/azure-file,kubernetes.io/cinder,kubernetes.io/gce-pd
CreationTimestamp:  Thu, 11 May 2023 18:05:00 +0900
Spec:
  Drivers:
    ebs.csi.aws.com:
      Node ID:  i-03abd706aae96c603
      Allocatables:
        Count:        25
        # ê¸°ë³¸ì ìœ¼ë¡œ 25ê°œì´ë©°, íŠ¹ì • ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì— ë”°ë¼ 39ê°œê¹Œì§€ ê°€ëŠ¥í•˜ë‹¤.
      Topology Keys:  [topology.ebs.csi.aws.com/zone]
Events:               <none>
...

```

# ebs csi ë™ì‘

pvìš”ì²­ì´ ìˆì„ ì‹œ, csi-controller(deploymentë¡œ ë°°í¬ëœ)ê°€ aws apië¥¼ í˜¸ì¶œí•˜ì—¬ ebsë¥¼ ìƒì„±í•˜ê³  volumeì— attach í•œë‹¤.
csi-node(daemonsetìœ¼ë¡œ ë°°í¬ëœ)ë¥¼ í†µí•´ volumeì„ podì— mountì‹œí‚¨ë‹¤.


![1-0](/assets/img/aews/3w/1-0.png)

ì´ë¯¸ì§€ ì¶œì²˜ëŠ” ì•…ë¶„ë‹˜ ë¸”ë¡œê·¸ì—ì„œ ê°€ì ¸ì™”ë‹¤. [ğŸ”—](https://malwareanalysis.tistory.com/598)


# í…ŒìŠ¤íŠ¸

```
# ì„¤ì¹˜ëœ csië¡œ provisioner ì„¤ì •í•˜ì—¬ sc ìƒì„±
# ê¸°ì¡´ ê¸°ë³¸ìœ¼ë¡œ ìˆëŠ” ìŠ¤í† ë¦¬ì§€ ë“œë¼ì´ë²„ì˜ provisionerëŠ” provisionerëŠ” kubernetes.io/aws-ebs
---
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: gp3
allowVolumeExpansion: true
provisioner: ebs.csi.aws.com
volumeBindingMode: WaitForFirstConsumer
parameters:
  type: gp3
  allowAutoIOPSPerGBIncrease: 'true'
  encrypted: 'true'
---


# í…ŒìŠ¤íŠ¸ po,pvc
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ebs-claim
spec:
  accessModes:
    - ReadWriteOnce
    # etx4, xfsê°™ì€ fsì€ nfsì²˜ëŸ¼ ë™ì‹œì— ì—°ê²°í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— RWOìœ¼ë¡œ ì„¤ì •
  resources:
    requests:
      storage: 4Gi
  storageClassName: gp3
---
apiVersion: v1
kind: Pod
metadata:
  name: app
spec:
  terminationGracePeriodSeconds: 3
  containers:
  - name: app
    image: centos
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo $(date -u) >> /data/out.txt; sleep 5; done"]
    volumeMounts:
    - name: persistent-storage
      mountPath: /data
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: ebs-claim
---


# ë™ì ìœ¼ë¡œ ì˜ ìƒì„±ë˜ì–´ ë¶™ì€ ê²ƒì„ í™•ì¸
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# kubectl get pvc,pv,pod
NAME                              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/ebs-claim   Bound    pvc-8c30b306-2853-4937-aedd-cb59bad3760b   4Gi        RWO            gp3            4m16s

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS   REASON   AGE
persistentvolume/pvc-8c30b306-2853-4937-aedd-cb59bad3760b   4Gi        RWO            Delete           Bound    default/ebs-claim   gp3                     54s

NAME      READY   STATUS    RESTARTS   AGE
pod/app   1/1     Running   0          58s

(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# kubectl get VolumeAttachment
NAME                                                                   ATTACHER          PV                                         NODE                                             ATTACHED   AGE
csi-6b459f4ca202aeb1c2e56851103ce56553ebcd5bdeddbf63c15fd4e01f0ac766   ebs.csi.aws.com   pvc-8c30b306-2853-4937-aedd-cb59bad3760b   ip-192-168-3-6.ap-northeast-2.compute.internal   true       52s
```

ì½˜ì†”ì—ì„œë„ í™•ì¸ ê°€ëŠ¥

![1-1](/assets/img/aews/3w/1-1.png)

ì´ë ‡ê²Œ ìƒì„±ëœ ebsê°€ ë¶™ì€ ë…¸ë“œì™€ íŒŒë“œê°€ ë™ì¼í•œ ì¡´ì— ìˆì–´ì•¼ í• ë‹¹ì´ ëœë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ë…¸ë“œê°€ ê° ì¡´ì— ë°°ì¹˜ë˜ì§€ë§Œ, ë§Œì•½ íŠ¹ì •ì¡´ì—ë§Œ ë…¸ë“œë¥¼ ìƒì„±í•˜ì˜€ê±°ë‚˜, í•´ë‹¹ ì¡´ì˜ ë…¸ë“œì— ì´ë¯¸ í• ë‹¹ëœ ìˆ˜ë§Œí¼ì˜ ë³¼ë¥¨ì´ ë¶™ì—ˆë‹¤ë©´ ìƒˆë¡œìš´ ë…¸ë“œê°€ ë°°í¬ë˜ì–´ì•¼í•œë‹¤. ì´ë¥¼ ìœ„í•´ --balance-similar-node-groups ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ í™œì„±í™” í•´ì¤˜ì•¼í•œë‹¤. (í•´ë‹¹ ì˜µì…˜ì„ ìœ„í•´ì„  cluster autoscalerê°€ ì„ í–‰ë˜ì–´ì•¼í•œë‹¤ (ğŸ”—)[https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/autoscaling.html](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/autoscaling.html))
ì§€ê¸ˆ í…ŒìŠ¤íŠ¸í™˜ê²½ì—ì„œëŠ” ë³¼ë¥¨ì„ ë¶™ì´ê¸°ì— ì¶©ë¶„íˆ ì—¬ìœ ìˆìœ¼ë¯€ë¡œ, ìœ„ ì‘ì—… ì—†ì´ ì§„í–‰í•˜ì˜€ë‹¤.


```
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# cat test.yaml
...
apiVersion: v1
kind: Pod
metadata:
  name: test-app
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: failure-domain.beta.kubernetes.io/zone
						# ë”ì´ìƒ í•´ë‹¹ keyë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  í•œë‹¤.
            # node labelì„ í™•ì¸í•´ë³´ë©´ topology.kubernetes.io/zone 
            operator: In
            values:
            - ap-northeast-2a
  terminationGracePeriodSeconds: 3
  containers:
  - ...
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: test-claim

(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# k apply -f test.yaml
persistentvolumeclaim/test-claim created
Warning: spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key: failure-domain.beta.kubernetes.io/zone is deprecated since v1.17; use "topology.kubernetes.io/zone" instead
pod/test-app created


(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# k get po,pv,pvc
NAME           READY   STATUS    RESTARTS   AGE
pod/app        1/1     Running   0          103m
pod/test-app   1/1     Running   0          10m

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE
persistentvolume/pvc-40f668d9-2750-45f4-a5f2-bd50deb3ef6f   4Gi        RWO            Delete           Bound    default/test-claim   gp3                     10m
persistentvolume/pvc-8c30b306-2853-4937-aedd-cb59bad3760b   4Gi        RWO            Delete           Bound    default/ebs-claim    gp3                     103m

NAME                               STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/ebs-claim    Bound    pvc-8c30b306-2853-4937-aedd-cb59bad3760b   4Gi        RWO            gp3            106m
persistentvolumeclaim/test-claim   Bound    pvc-40f668d9-2750-45f4-a5f2-bd50deb3ef6f   4Gi        RWO            gp3            10m


(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# k get volumeattachment
NAME                                                                   ATTACHER          PV                                         NODE                                              ATTACHED   AGE
csi-287da6a2b2414ed393feade04016f839a01e0bc577fb44f5a32891bd92e151b7   ebs.csi.aws.com   pvc-40f668d9-2750-45f4-a5f2-bd50deb3ef6f   ip-192-168-1-58.ap-northeast-2.compute.internal   true       10m
csi-6b459f4ca202aeb1c2e56851103ce56553ebcd5bdeddbf63c15fd4e01f0ac766   ebs.csi.aws.com   pvc-8c30b306-2853-4937-aedd-cb59bad3760b   ip-192-168-3-6.ap-northeast-2.compute.internal    true       103m

```

ì½˜ì†”ì—ì„œ í™•ì¸ ì‹œ aì¡´ì— ebsê°€ ìƒê¸´ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.
![1-2](/assets/img/aews/3w/1-2.png)



# snapshot
### snapshot

```
# ebs controller pod ì•ˆì„ ë³´ë©´  csi-snapshotter ì»¨í…Œì´ë„ˆê°€ ë™ì‘ ì¤‘ì¸ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.
# í•´ë‹¹ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ë¨¼ì € crd ì„¤ì¹˜ê°€ í•„ìš”í•˜ë‹¤

# volume sanpshot crd ì„¤ì¹˜
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# curl -s -O https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# curl -s -O https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# curl -s -O https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# kubectl apply -f snapshot.storage.k8s.io_volumesnapshots.yaml,snapshot.storage.k8s.io_volumesnapshotclasses.yaml,snapshot.storage.k8s.io_volumesnapshotcontents.yaml
customresourcedefinition.apiextensions.k8s.io/volumesnapshots.snapshot.storage.k8s.io created
customresourcedefinition.apiextensions.k8s.io/volumesnapshotclasses.snapshot.storage.k8s.io created
customresourcedefinition.apiextensions.k8s.io/volumesnapshotcontents.snapshot.storage.k8s.io created

# rbac ì„¤ì •ê³¼ snapshot controller ì„¤ì¹˜
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# curl -s -O https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# curl -s -O https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# kubectl apply -f rbac-snapshot-controller.yaml,setup-snapshot-controller.yaml

# snapshotclass ì„¤ì¹˜ 
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# curl -s -O https://raw.githubusercontent.com/kubernetes-sigs/aws-ebs-csi-driver/master/examples/kubernetes/snapshot/manifests/classes/snapshotclass.yaml
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# kubectl apply -f snapshotclass.yaml


# ì‚¬ìš©í•˜ê²Œë  snapshotclass 
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# k get volumesnapshotclass
NAME          DRIVER            DELETIONPOLICY   AGE
csi-aws-vsc   ebs.csi.aws.com   Delete           4m39s

# snapshotì„ í•˜ë ¤í•˜ëŠ” pvcì™€ ìœ„ì˜ snapshotclassë¥¼ ì´ìš©í•œë‹¤.
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# cat ebs-volume-snapshot.yaml
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: ebs-volume-snapshot
spec:
  volumeSnapshotClassName: csi-aws-vsc
  source:
    persistentVolumeClaimName: ebs-claim

(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# k get volumesnapshot
NAME                  READYTOUSE   SOURCEPVC   SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS   SNAPSHOTCONTENT                                    CREATIONTIME   AGE
ebs-volume-snapshot   true         ebs-claim                           4Gi           csi-aws-vsc     snapcontent-c79ef8ed-e0d3-4beb-89a4-32acaf19d552   24s            24s
```

![1-3](/assets/img/aews/3w/1-3.png)


### restore

```
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# cat ebs-snapshot-restore.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ebs-snapshot-restored-claim
spec:
  storageClassName: gp3
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 4Gi
  dataSource:
    name: ebs-volume-snapshot
    kind: VolumeSnapshot
    apiGroup: snapshot.storage.k8s.io
---
apiVersion: v1
kind: Pod
metadata:
  name: restore-app
spec:
  containers:
  - name: app
    image: centos
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo $(date -u) >> /data/out.txt; sleep 5; done"]
    volumeMounts:
    - name: persistent-storage
      mountPath: /data
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: ebs-snapshot-restored-claim


(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# k get po,pvc
NAME              READY   STATUS    RESTARTS   AGE
pod/app           1/1     Running   0          119m
pod/restore-app   1/1     Running   0          20s
pod/test-app      1/1     Running   0          26m

NAME                                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/ebs-claim                     Bound    pvc-8c30b306-2853-4937-aedd-cb59bad3760b   4Gi        RWO            gp3            122m
persistentvolumeclaim/ebs-snapshot-restored-claim   Bound    pvc-b22ea2c5-2926-4b79-8da0-ad285acde7e1   4Gi        RWO            gp3            2m21s
persistentvolumeclaim/test-claim                    Bound    pvc-40f668d9-2750-45f4-a5f2-bd50deb3ef6f   4Gi        RWO            gp3            26m
```

### fstype: xfs

csië¡œ ì„¤ì¹˜ëœ controllerì˜ ì»¨í…Œì´ë„ˆ ì¤‘ csi-provisioner containerë¥¼ ì‚´í´ë³´ë©´ --default-fstypeì´ ext4ë¡œ ì§€ì •ë˜ì–´ìˆë‹¤. ë§Œë“¤ì–´ì„œ ì‚¬ìš©í–ˆë˜ gp3 scë„ ex4ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •ë˜ì–´ í…ŒìŠ¤íŠ¸í–ˆì—ˆëŠ”ë°, xfsìœ¼ë¡œ í•œ ê²½ìš° snapshotì´ ì•ˆë  ìˆ˜ë„ ì•ˆë  ìˆ˜ë„ ìˆë‹¤í•˜ì—¬ í™•ì¸ì°¨í…ŒìŠ¤íŠ¸í•´ë³´ì•˜ë‹¤.

```
# ë¨¼ì € scë¥¼ ìƒì„±í•´ì£¼ì—ˆë‹¤. ì•„ê¹Œì™€ë‹¤ë¥¸ ì ì€ parameters.fsType: xfs ë¿ì´ë‹¤.
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# cat testxfssc.yaml
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: xfs-gp3
allowVolumeExpansion: true
provisioner: ebs.csi.aws.com
volumeBindingMode: WaitForFirstConsumer
parameters:
  type: gp3
  allowAutoIOPSPerGBIncrease: 'true'
  encrypted: 'true'
  fsType: xfs

(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# k get sc
NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
xfs-gp3         ebs.csi.aws.com         Delete          WaitForFirstConsumer   true                   19s
...

# ìœ„ì—ì„œ po,pvcë¡œ ë°°í¬í–ˆë˜ yamlì—ì„œ scë§Œ ìˆ˜ì • í›„ ë™ì¼í•˜ê²Œ ë°°í¬í–ˆë‹¤.
# ìƒì„±ëœ podì— ë“¤ì–´ê°€ì„œ í™•ì¸í•´ë³´ë‹ˆ mountê°€ ì˜ë˜ì–´ìˆë‹¤.
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# kubectl exec -it xfs-test-app  -- sh -c 'df -hT --type=xfs'
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/nvme1n1   xfs   4.0G   62M  4.0G   2% /data
/dev/nvme0n1p1 xfs    30G  3.6G   27G  12% /etc/hosts
```

### xfs snapshot & restore

```
# snapshot
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# cat xfs-snapshot.yaml
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: xfs-volume-snapshot
spec:
  volumeSnapshotClassName: csi-aws-vsc
  source:
    persistentVolumeClaimName: xfs-test-claim

# restore
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# cat xfs-restore-claim.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: xfs-snapshot-restored-claim
spec:
  storageClassName: xfs-gp3
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 4Gi
  dataSource:
    name: xfs-volume-snapshot
    kind: VolumeSnapshot
    apiGroup: snapshot.storage.k8s.io

# scë¥¼ ì˜ ë¶™ì—¬ì£¼ê³  ë³µêµ¬í–ˆë‹¤ë©´, ì´ìƒì—†ì´ podì— ë¶™ëŠ” ê²ƒì„ í™•ì¼ í•  ìˆ˜ ìˆë‹¤.
(nyoung@myeks:default) [root@myeks-bastion-EC2 ~]# kubectl exec -it restore-app-xfs -- sh -c 'df -hT --type=xfs'
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/nvme2n1   xfs   4.0G   62M  4.0G   2% /data
/dev/nvme0n1p1 xfs    30G  3.7G   27G  13% /etc/hosts
```

ë³µêµ¬ëœ íŒŒì¼ ë‚´ìš©ì„ í™•ì¸í•´ë³´ë©´ snapshotì„ ì°ê³  restoreë˜ëŠ” ì‹œê°„ì´ ë¹„ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. 

![1-4](/assets/img/aews/3w/1-4.png)


---
ì°¸ê³ 
- [https://kubernetes.io/blog/2021/12/10/storage-in-tree-to-csi-migration-status-update/](https://kubernetes.io/blog/2021/12/10/storage-in-tree-to-csi-migration-status-update/)
- [https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/managing-ebs-csi.html](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/managing-ebs-csi.html)
- [https://aws.github.io/aws-eks-best-practices/reliability/docs/dataplane/#ensure-capacity-in-each-az-when-using-ebs-volumes](https://aws.github.io/aws-eks-best-practices/reliability/docs/dataplane/#ensure-capacity-in-each-az-when-using-ebs-volumes)
- [https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/ebs-sample-app.html](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/ebs-sample-app.html)
- [https://docs.aws.amazon.com/eks/latest/userguide/storage-classes.html](https://docs.aws.amazon.com/eks/latest/userguide/storage-classes.html)
- [https://aws.amazon.com/ko/blogs/containers/using-ebs-snapshots-for-persistent-storage-with-your-eks-cluster/](https://aws.amazon.com/ko/blogs/containers/using-ebs-snapshots-for-persistent-storage-with-your-eks-cluster/)


