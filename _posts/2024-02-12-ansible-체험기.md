---
layout: post
title: a101) ansible ì²´í—˜ê¸°
category:
  - study
  - ansible
tags:
  - study
  - ansible
---

ë§ˆì§€ë§‰ ìˆ™ì œì¸ ë§Œí¼ ì´ê²ƒì €ê²ƒ í•´ë³´ìëŠ” ì˜ë¯¸ë¡œ ì‹œì‘í–ˆì§€ë§Œ.. ìƒê°ë³´ë‹¤ ë” ì˜ ì•ˆë˜ì„œ ì•„ì‰½ë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ í•˜ë ¤ê³  í•œ ë‚´ìš©ì€ 'ec2 ìƒì„± -> í‚¤ë“±ë¡ -> ìƒì„±í•œ ec2ì— roleë°°í¬' ì˜€ë‹¤... 


# ì¤€ë¹„ ì‘ì—…

ë¨¼ì € ec2ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ aws sdk ì„¤ì¹˜ê°€ í•„ìš”í•˜ë‹¤. ansibleì´ pythonìœ¼ë¡œ êµ¬í˜„ë˜ì–´ìˆê¸° ë•Œë¬¸ì— boto3ì„ ì„¤ì¹˜í–ˆë‹¤. ì´ë ‡ê²Œ ì„¤ì¹˜ë¥¼ í•˜ê³  ë‚˜ë©´ awsë‚´ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ì»¨íŠ¸ë¡¤ í•  ìˆ˜ ìˆë‹¤. í˜„ì¬ ì ‘ì† ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ì—ê²Œ ì¶©ë¶„í•œ ê¶Œí•œì´ ìˆì–´ ì„¤ì¹˜ í›„, ì•„ë˜ì™€ ê°™ì´ ec2 ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë‹¤. (ec2 full accessë¡œ ê¶Œí•œ ë¶€ì—¬ëœ ìƒíƒœ)

```
$ sudo apt-get install python3-pip
$ pip install boto3
```
![1-0](/assets/img/a101/4w/1-0.png)

ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê¸° ì „, ì‚¬ìš©í•  roleì„ ì„¤ì¹˜í•˜ì˜€ë‹¤.[ğŸ”—](https://galaxy.ansible.com/ui/standalone/roles/Oefenweb/wordpress/install/)
```
$ ansible-galaxy role init --init-path ./roles role.test
$ ansible-galaxy role install -p roles Oefenweb.wordpress
```

roleì—ì„œ ë„£ì„ ë³€ìˆ˜ë¥¼ í™•ì¸í•´ë³´ë‹ˆ passwordë€ì´ ìˆì–´, ansible-vaultë¡œ ì•”í˜¸í™”í•˜ì˜€ë‹¤. ì§€ë‚œë²ˆì— í•œ ê²ƒê³¼ ë™ì¼í•˜ê²Œ ansible-vaultë¡œ ì•”í˜¸í™” ì‹œ ì‚¬ìš©í•œ ë¹„ë°€ë²ˆí˜¸ëŠ” aws secretmanagerì— ë„£ì–´ë†¨ë‹¤.
```
$ ansible-vault create vars/secret.yml
New Vault password: qwe123
Confirm New Vault password: qwe123

# vars/secret.yml
dbpass: qwe123

# get-vault-passwd.sh 
#!/bin/sh
aws secretsmanager get-secret-value --secret-id ansiblepasswd | jq -r .SecretString | jq -r .ansible_passwd
```

# íŒŒì¼ ì‘ì„±

### ansible.cfg & inventory
```
# ansible.cfg
[defaults]
inventory = ./inventory
remote_user = ubuntu
ask_pass = false
roles_path= ./roles
vault_password_file=./get-vault-passwd.sh 

[privilege_escalation]
become = true
become_method = sudo
become_user = root
become_ask_pass = false


# inventory
tnode1
tnode2
tnode3
```

### variable
```
# vars/wp.yml
	wordpress_installs:
	- name: wordpress
	  dbname: wordpress
	  dbuser: wordpress
	  dbpass: !vault | 
	          $ANSIBLE_VAULT;1.1;AES256
	          {{ ansible vault secretì •ë³´ }}
	  dbhost: localhost
	  path: /var/www
	  url: http://localhost
	  title: wordpress
	  admin_name: admin
	  admin_email: root@localhost.localdomain
	  admin_password: !vault | 
	          $ANSIBLE_VAULT;1.1;AES256
	          {{ ansible vault secretì •ë³´ }}
	  themes:
	    - name: twentytwelve
	      activate: true
	    - name: twentythirteen
	  plugins:
	    - name: contact-form-7
	      activate: false
	    - name: simple-fields
	  users: {}
	  queries: []


# vars/ec2.yml
# security_groupê³¼ vpc_subnet_idë¥¼ ì˜ ë§ì¶°ì„œ ì¨ì¤˜ì•¼ì§€.. ì•„ë‹ˆë©´ default sg,vpcë¥¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.
vm_name: "testserver"
image_id: "ami-0382ac14e5f06eb95" #ubuntu
instance_type: "t3.medium"
key_name: "nyoung"
security_group: "sg-050094e736daa3955"
region_name: "ap-northeast-2"
user_name: "ubuntu"
vpc_subnet_id: "subnet-0633258a6f7a419ef"
```

### playbook
```
# ì§„í–‰ ìˆœì„œ
# (localhostì—ì„œ)
# create ec2 vm > print vm private ip > add hosts file > add inventory file 
# (ì´í›„ì— ë“±ë¡ë˜ëŠ” testserverì—ì„œ)
# copy pub key > wordpress role  


- hosts: localhost
  vars_files:
    - vars/ec2.yml
  tasks:
    - name: Create ec2 vm
      amazon.aws.ec2_instance:
        name: {{ vm_name }}
        image_id: {{ image_id }}
        instance_type: {{ instance_type }}
        key_name: {{ key_name }}
        security_group: {{ security_group }}
        network:
          assign_public_ip: true
        region: {{ region_name }}
      register: ec2_info

    - name: Print vm private ip
      ansible.builtin.debug:
        var: ec2_info.instances[0].private_ip_address

    - name: add hosts file
      ansible.builtin.shell: |
        echo '{{ ec2_info.instances[0].private_ip_address }} testserver' >> /etc/hosts 
    - name: add inventory file
      ansible.builtin.shell: |
        echo "testserver" >> /inventory
 
- hosts: testserver
  tasks:
    - name: copy pub key
      ansible.posix.authorized_key:
        user: "{{ user_name }}"
        state: present
        key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_rsa.pub') }}"

  vars_files:
    - vars/wp.yml
  roles:
    - role: Oefenweb.wordpress
```

# ì‹¤í–‰í•˜ë©´ì„œ ìˆ˜ì •í•œ ê²ƒë“¤
## hosts: localhost

ë¬¸ë²• ì²´í¬ì‹œ ë¬¸ì œ ì—†ê³ , ì¶”ê°€ë  í˜¸ìŠ¤íŠ¸ì— ëŒ€í•´ ì•„ì§ ëª¨ë¥´ê¸° ë•Œë¬¸ì— warningì´ ë°œìƒí•œë‹¤.
![1-1](/assets/img/a101/4w/1-1.png)

ëŠ˜ ê·¸ë ‡ë“¯.. ë¬¸ë²•ì´ í†µê³¼ ë˜ì—ˆì–´ë„ ì˜¤ë¥˜ëŠ” ë°œìƒí•œë‹¤. ì‚¬ì‹¤ ì´ ì‚¬ì´ì—ì„œë„ sg, subnetì„ ì˜ëª»ë§ì¶°ì„œ ëª‡ë²ˆ ë‹¤ì‹œ ë§Œë“¤ì—ˆë‹¤.. 
ì—¬ê¸°ì„œ ë°œìƒí•œ ì˜¤ë¥˜ëŠ” ec2ê°€ ì˜¨ì „íˆ ìƒê¸°ê¸° ì „ì— ë‹¤ìŒ íƒœìŠ¤í¬ë¥¼ ìˆ˜í–‰í•˜ë ¤í•˜ë‹¤ë³´ë‹ˆ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤. (ì´ ë•Œê¹Œì§€ë§Œí•´ë„ ipë„ publicìœ¼ë¡œ ì˜ëª» ë„£ì—ˆì—ˆë‹¤..)
![1-2](/assets/img/a101/4w/1-2.png)

wait_forì´ë¼ëŠ” ëª¨ë“ˆì„ ì‚¬ìš©í•˜ì—¬ 22ë²ˆ í¬íŠ¸ê°€ ì—´ë¦¬ë©´ ë‹¤ìŒ íƒœìŠ¤í¬ë¥¼ ìˆ˜í–‰í•˜ë„ë¡ í–ˆë‹¤. ë‹¤ìŒ íƒœìŠ¤í¬ì¸ hosts fileê³¼ inventory fileì— ì‘ì„±ë˜ëŠ” ê²ƒì´ í”Œë ˆì´ë¶ ì‹¤í–‰ì‹œë§ˆë‹¤ ìŒ“ì´ê¸° ë•Œë¬¸ì—, lineinfileì´ë¼ëŠ” ëª¨ë“ˆë¡œ ë³€ê²½í•˜ì˜€ë‹¤. pathì˜ íŒŒì¼ì— lineì—ì„œ ì§€ì •í•œ ë¬¸ìê°€ ìˆì„ ì‹œ ì¶”ê°€ë˜ì§€ ì•ŠëŠ”ë‹¤.
```
    - name: check ec2 vm
      ansible.builtin.wait_for: 
        host: "{{ item.public_dns_name }}" 
        port: 22 
        delay: 10  
        timeout: 300
      with_items: "{{ ec2_info.instances }}"

    - name: add hosts file
      lineinfile:
        path: /etc/hosts
        line: "{{ ec2_info.instances[0].private_ip_address }} testserver" 
        state: present
      
    - name: add inventory file
      lineinfile:
        path: ./inventory
        line: "testserver"
        state: present
```
ì´ ë•Œ ìƒì„±ë˜ëŠ” ec2ëŠ” IMDSv1ìœ¼ë¡œ ìƒì„±ëœë‹¤. moduleì—ì„œëŠ” ì˜µì…˜ì´ ì—†ëŠ” ê²ƒìœ¼ë¡œ í™•ì¸í–ˆëŠ”ë°.. ë§Œì•½ ansibleë¡œ ec2ë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•´ì•¼í•œë‹¤ë©´, ì´ë¶€ë¶„ì€ ë°”ê¾¸ê³  ì¨ì•¼ í•  ê²ƒ ê°™ë‹¤.

ë“±ë¡ì„ ì™„ë£Œ í›„, target host ë³€ê²½ ì „ ì¸ë²¤í† ë¦¬ë¥¼ refreshí•´ì„œ ìƒˆë¡œ ìƒê¸´ testserverì˜ ì¡´ì¬ë¥¼ ansible serverì—ê²Œ ì•Œë ¤ì¤€ë‹¤. 
```
    - name: refresh inventory
      ansible.builtin.meta: refresh_inventory
```

ì—¬ê¸°ì„œë¶€í„° ë˜ë‹¤ì‹œ í‚¤ì™€ì˜ ì˜¤ë¥˜ë¥¼ ë§Œë‚˜ í•œì°¸ì„ í—¤ë§¸ë‹¤. ansibleì´ testserverë¥¼ ì•Œì§€ë§Œ ssh ì ‘ì†ì´ ì•ˆë˜ì–´ìˆëŠ” ìƒíƒœë¡œ gathering factsë¥¼ í•˜ë‹¤ ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤. ê·¸ë ‡ê¸° ë•Œë¬¸ì—, hosts: testserverë¡œ ë„˜ì–´ê°€ê¸° ì „ì— public keyê°€ ë„˜ì–´ê°€ì•¼í•œë‹¤ ìƒê°í•´ì„œ ì—¬ê¸°ì„œ ë„˜ê²¨ë³´ë ¤ê³  í–ˆì§€ë§Œ.. ì‹¤íŒ¨í–ˆë‹¤.
í•œì°¸ ì”¨ë¦„í•˜ë‹¤ ì•ˆë˜ê² ë‹¤ ì‹¶ì–´ì„œ public keyë¥¼ ë³µì‚¬í•´ì„œ testserverì˜ authorized_key íŒŒì¼ì— ë„£ì–´ì£¼ê³ , ì„œë²„ì—ì„œ í•œë²ˆ ì ‘ì†í•˜ì—¬ ì¬ì ‘ê·¼ì‹œ prompt ì•ˆëœ¨ë„ë¡ í–ˆë‹¤.

<details>
<summary>ìˆ˜ì •ëœ ì²«ë²ˆì§¸ playbook </summary>
<div markdown="1">       

```
- hosts: localhost
  vars_files:
    - vars/ec2.yml
  tasks:
    - name: Create ec2 vm
      amazon.aws.ec2_instance:
        name: "{{ vm_name }}"
        image_id: "{{ image_id }}"
        instance_type: "{{ instance_type }}"
        key_name: "{{ key_name }}"
        security_group: "{{ security_group }}"
        vpc_subnet_id: "{{ vpc_subnet_id }}"
        network:
          assign_public_ip: true
        region: "{{ region_name }}"
        state: present
        user_data: " "
      register: ec2_info

    - name: check ec2 vm
      ansible.builtin.wait_for: 
        host: "{{ item.public_dns_name }}" 
        port: 22 
        delay: 10  
        timeout: 300
      with_items: "{{ ec2_info.instances }}"

    - name: Print vm public ip
      ansible.builtin.debug:
        var: ec2_info.instances[0].private_ip_address

    - name: add hosts file
      lineinfile:
        path: /etc/hosts
        line: "{{ ec2_info.instances[0].private_ip_address }} testserver" 
        state: present
      
    - name: add inventory file
      lineinfile:
        path: ./inventory
        line: "testserver"
        state: present

    - name: refresh inventory
      ansible.builtin.meta: refresh_inventory
```

</div>
</details>


## hosts: testserver

testserverì—ì„œëŠ” roleì„ ì‹¤í–‰í•˜ëŠ” í”Œë ˆì´ë¶ì„ ì‘ì„±í•˜ì˜€ë‹¤. role ì‚¬ìš©ì„ ìœ„í•´ ëª‡ê°€ì§€ íŒ¨í‚¤ì§€ ì„¤ì¹˜ê°€ ì„ í–‰ë˜ì–´ì•¼ í•´ì„œ ì„¤ì¹˜í•˜ëŠ” íƒœìŠ¤í¬ í›„ì— ë¡¤ì„ ì‹¤í–‰í–ˆë‹¤. [ğŸ”—](https://galaxy.ansible.com/ui/standalone/roles/Oefenweb/wordpress/install/)
```
- hosts: testserver
  tasks:
  - name: install pkg
    ansible.builtin.apt:
      name: 
        - php
        - mysql-server
        - apache2
        - php-mysql
      state: present

- hosts: testserver
  vars_files:
    - vars/wp.yml
  roles:
    - role: Oefenweb.wordpress
      become: true
```

ì´ ë•Œ, ê³„ì†í•´ì„œ ansible-vaultë¥¼ ë³µí˜¸í™”í•˜ì§€ ëª»í•˜ëŠ” ì˜¤ë¥˜ê°€ ìˆì—ˆëŠ”ë°.. get-vault-passwd.shë¥¼ ì‹¤í–‰í•˜ëŠ” ê¶Œí•œì´ ì—†ì–´ì„œì˜€ë‹¤.
$ chmod +x ./get-vault-passwd.sh

ê¶Œí•œ ë¶€ì—¬ í›„ì—ëŠ” valueë§Œ ê°€ì ¸ì™€ì•¼í•˜ëŠ”ë° {key: value}ë¥¼ ê°€ì ¸ì™€ì„œ ë¬¸ì œê°€ ë˜ì—ˆë‹¤. ë³€ìˆ˜íŒŒì¼ (vars/wp.yml)ì—ì„œ !vaultë¡œ ì‘ì„±í–ˆë˜ ë¶€ë¶„ë“¤ì„ lookupì„ ì‚¬ìš©í•˜ì—¬ ë³€ê²½í•˜ì˜€ë‹¤. vars/secret.ymlì˜ íŒŒì¼ì´ yamlí˜•ì‹ì´ë©°, ì—¬ê¸°ì„œ dbpassì˜ valueë¥¼ ê°€ì ¸ì˜¤ë„ë¡ í–ˆë‹¤.
"{{ lookup('file', '/home/ubuntu/my-ansible/vars/secret.yml') | from_yaml | json_query('dbpass') }}"


ì´ í›„ì—”, mysqlì— dbì™€ userê°€ ì¤€ë¹„ë˜ì–´ìˆì§€ ì•Šì•„ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ë‹¤. 
```
CREATE database wordpress;
ALTER USER 'root'@'localhost' IDENTIFIED BY 'qwe123';
CREATE USER 'wordpress'@localhost IDENTIFIED BY 'qwe123';
GRANT ALL PRIVILEGES ON wordpress.* TO 'wordpress'@localhost;
FLUSH PRIVILEGES;
```

roleì„ ì“°ëŠ”ê²Œ ìµìˆ™í•˜ì§€ë„ ì•Šê³ , ê¼¼ê¼¼í•˜ê²Œ ì½ì§€ ì•Šì•„ì„œ ê·¸ëŸ°ì§€ ì´í›„ì—ë„ ìì˜ìì˜í•œ ì˜¤ë¥˜ë“¤ì„ ë§ˆì£¼í–ˆë‹¤. ë³€ìˆ˜íŒŒì¼ (vars/wp.yml)ì‘ì„±í•  ë•Œ, ê·¸ëƒ¥ ë°‘ì— ìˆë˜ í€µìŠ¤íƒ€íŠ¸ ìƒ˜í”Œì„ ë³µì‚¬í•˜ê³  vaultë¶€ë¶„ë§Œ ë³€ê²½í•˜ì—¬ ì‚¬ìš©í•˜ì˜€ëŠ”ë°.. ê·¸ ê³³ì— ì í˜€ìˆë˜ í”ŒëŸ¬ê·¸ì¸ì´ ì—†ë‹¤ê±°ë‚˜ í•„ìˆ˜ ë³€ìˆ˜ê°’ì´ ì—†ë‹¤ê±°ë‚˜í•˜ëŠ” ì˜¤ë¥˜ë“¤ì´ ìˆì—ˆë‹¤. ëª‡ê°œë¥¼ ê³ ì³ì£¼ê³  ë‚˜ë‹ˆ ì˜¤ë¥˜ì—†ì´ í”Œë ˆì´ë¶ì´ ì¢…ë£Œë˜ê¸´í–ˆì§€ë§Œ skipped=15ë¥¼ ë³´ê³  ì°ì°í•¨ë§Œ ìƒê²¼ë‹¤. ì™¸ë¶€ì—ì„œëŠ” ì ‘ê·¼ì´ ì•ˆë˜ëŠ” ê²ƒì„ ë³´ê³  ì´ê±´ ê·¸ëƒ¥ í†µê³¼ì§€ ì„¤ì¹˜ì— ì„±ê³µí•œê²Œ ì•„ë‹ˆêµ¬ë‚˜ ì‹¶ì—ˆë‹¤.. ã…  ë°©í™”ë²½ë„ í™•ì¸í•˜ê³  ë³€ìˆ˜ì˜ urlë„ ë³€ê²½í•´ì£¼ì—ˆì§€ë§Œ, ë¶ˆê°€í–ˆë‹¤. ëˆ„êµ°ê°€ ë§Œë“¤ì–´ ë‘” roleì„ ì‚¬ìš©í•˜ëŠ”ê²Œ ì•„ë¬´ë¦¬ ì¢‹ë‹¤í•´ë„, ì´ë ‡ê²Œ ì œëŒ€ë¡œ ì½ì§€ë„ ì•Šê³  í•˜ë©´ ì˜¨ê°– ê³³ì—ì„œ ë¬¸ì œê°€ ë‚˜ì˜¨ë‹¤.. ğŸ˜‡


